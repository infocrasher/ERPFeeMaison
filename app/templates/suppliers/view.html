{% extends "base.html" %}

{% block title %}{{ supplier.company_name }}{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- En-tête -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-building me-2"></i>{{ supplier.company_name }}</h2>
            <div class="text-muted">
                {% if supplier.is_active %}
                    <span class="badge bg-success">Actif</span>
                {% else %}
                    <span class="badge bg-secondary">Inactif</span>
                {% endif %}
                <span class="badge bg-info ms-2">
                    {% if supplier.supplier_type == 'ingredients' %}Ingrédients
                    {% elif supplier.supplier_type == 'equipment' %}Équipements
                    {% elif supplier.supplier_type == 'services' %}Services
                    {% elif supplier.supplier_type == 'packaging' %}Emballages
                    {% elif supplier.supplier_type == 'maintenance' %}Maintenance
                    {% else %}Général{% endif %}
                </span>
            </div>
        </div>
        <div class="btn-group">
            <a href="{{ url_for('suppliers.edit_supplier', supplier_id=supplier.id) }}" class="btn btn-primary">
                <i class="bi bi-pencil me-1"></i>Modifier
            </a>
            <form method="POST" action="{{ url_for('suppliers.toggle_supplier_status', supplier_id=supplier.id) }}" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn btn-outline-{{ 'secondary' if supplier.is_active else 'success' }}"
                        onclick="return confirm('Êtes-vous sûr de vouloir {{ 'désactiver' if supplier.is_active else 'activer' }} ce fournisseur ?')">
                    <i class="bi bi-{{ 'pause' if supplier.is_active else 'play' }} me-1"></i>
                    {{ 'Désactiver' if supplier.is_active else 'Activer' }}
                </button>
            </form>
            <a href="{{ url_for('suppliers.list_suppliers') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Retour
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Informations principales -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Informations Principales</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <dl class="row">
                                <dt class="col-sm-4">Entreprise:</dt>
                                <dd class="col-sm-8">{{ supplier.company_name }}</dd>
                                
                                {% if supplier.contact_person %}
                                <dt class="col-sm-4">Contact:</dt>
                                <dd class="col-sm-8">{{ supplier.contact_person }}</dd>
                                {% endif %}
                                
                                {% if supplier.phone %}
                                <dt class="col-sm-4">Téléphone:</dt>
                                <dd class="col-sm-8">
                                    <a href="tel:{{ supplier.phone }}" class="text-decoration-none">
                                        {{ supplier.phone }}
                                    </a>
                                </dd>
                                {% endif %}
                                
                                {% if supplier.email %}
                                <dt class="col-sm-4">Email:</dt>
                                <dd class="col-sm-8">
                                    <a href="mailto:{{ supplier.email }}" class="text-decoration-none">
                                        {{ supplier.email }}
                                    </a>
                                </dd>
                                {% endif %}
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <dl class="row">
                                {% if supplier.tax_number %}
                                <dt class="col-sm-4">NIF/RC:</dt>
                                <dd class="col-sm-8">{{ supplier.tax_number }}</dd>
                                {% endif %}
                                
                                <dt class="col-sm-4">Paiement:</dt>
                                <dd class="col-sm-8">{{ supplier.payment_terms }} jours</dd>
                                
                                <dt class="col-sm-4">Créé le:</dt>
                                <dd class="col-sm-8">{{ supplier.created_at.strftime('%d/%m/%Y') }}</dd>
                                
                                {% if supplier.updated_at != supplier.created_at %}
                                <dt class="col-sm-4">Modifié le:</dt>
                                <dd class="col-sm-8">{{ supplier.updated_at.strftime('%d/%m/%Y') }}</dd>
                                {% endif %}
                            </dl>
                        </div>
                    </div>
                    
                    {% if supplier.address %}
                    <div class="mt-3">
                        <strong>Adresse:</strong>
                        <div class="mt-1">{{ supplier.address|replace('\n', '<br>')|safe }}</div>
                    </div>
                    {% endif %}
                    
                    {% if supplier.bank_details %}
                    <div class="mt-3">
                        <strong>Coordonnées bancaires:</strong>
                        <div class="mt-1 font-monospace small">{{ supplier.bank_details|replace('\n', '<br>')|safe }}</div>
                    </div>
                    {% endif %}
                    
                    {% if supplier.notes %}
                    <div class="mt-3">
                        <strong>Notes:</strong>
                        <div class="mt-1">{{ supplier.notes|replace('\n', '<br>')|safe }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Statistiques -->
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Statistiques</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <h4 class="text-primary mb-0">{{ supplier.purchases.count() }}</h4>
                                <small class="text-muted">Achats</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <h4 class="text-success mb-0">{{ supplier.active_purchases_count }}</h4>
                            <small class="text-muted">En cours</small>
                        </div>
                    </div>
                    
                    {% if supplier.total_purchases %}
                    <hr>
                    <div class="text-center">
                        <h5 class="text-success mb-0">{{ "%.2f"|format(supplier.total_purchases) }} DA</h5>
                        <small class="text-muted">Total des achats</small>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Actions rapides -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-lightning me-2"></i>Actions Rapides</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('purchases.new_purchase') }}?supplier_id={{ supplier.id }}" class="btn btn-outline-primary">
                            <i class="bi bi-plus-circle me-1"></i>Nouvel Achat
                        </a>
                        <a href="{{ url_for('purchases.list_purchases') }}?supplier={{ supplier.company_name }}" class="btn btn-outline-info">
                            <i class="bi bi-list-ul me-1"></i>Voir tous les achats
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Achats récents -->
    {% if recent_purchases %}
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Achats Récents</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Référence</th>
                            <th>Date</th>
                            <th>Statut</th>
                            <th>Montant</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for purchase in recent_purchases %}
                        <tr>
                            <td>
                                <a href="{{ url_for('purchases.view_purchase', id=purchase.id) }}" class="text-decoration-none">
                                    {{ purchase.reference }}
                                </a>
                            </td>
                            <td>{{ purchase.requested_date.strftime('%d/%m/%Y') }}</td>
                            <td>
                                <span class="badge bg-{{ 'success' if purchase.status.value == 'received' else 'warning' if purchase.status.value in ['ordered', 'partially_received'] else 'secondary' }}">
                                    {{ purchase.status.value.title() }}
                                </span>
                            </td>
                            <td>
                                {% if purchase.total_amount %}
                                    {{ "%.2f"|format(purchase.total_amount) }} DA
                                {% else %}
                                    <span class="text-muted">—</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('purchases.view_purchase', id=purchase.id) }}" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-eye"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}











