{% extends "reports/_report_base.html" %}

{% set report_type = 'daily_production' %}
{% set export_params = '?date=' + (data.date.strftime('%Y-%m-%d') if data.date else '') %}

{% block report_icon %}bi-gear-fill{% endblock %}
{% block report_title %}Production Quotidienne{% endblock %}
{% block report_description %}
    Rapport de production du {{ data.date.strftime('%d/%m/%Y') }}
{% endblock %}

{% block filter_fields %}
<div class="col-md-3">
    <label class="form-label">Date du rapport</label>
    <input type="date" name="date" class="form-control" value="{{ data.date.strftime('%Y-%m-%d') }}">
</div>
{% endblock %}

{% block kpis %}
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card kpi-card border-primary">
            <div class="card-body">
                <div class="kpi-label">Unités Produites</div>
                <div class="kpi-value text-primary">{{ data.total_units }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card kpi-card border-success">
            <div class="card-body">
                <div class="kpi-label">Ordres de Production</div>
                <div class="kpi-value text-success">{{ data.total_orders }}</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card kpi-card border-info">
            <div class="card-body">
                <div class="kpi-label">Taux d'Efficacité</div>
                <div class="kpi-value text-info">{{ "{:.1f}".format(data.efficiency_rate) }}%</div>
                <div class="progress mt-2">
                    <div class="progress-bar bg-info" style="width: {{ data.efficiency_rate }}%"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block charts %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Production par Produit</h6>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="productionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block data_tables %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-list-ul me-2"></i>Détail de la Production</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Produit</th>
                                <th class="text-end">Quantité Produite</th>
                                <th>Unité</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in data.production_by_product %}
                            <tr>
                                <td><strong>{{ item.name }}</strong></td>
                                <td class="text-end">{{ item.quantity_produced }}</td>
                                <td>{{ item.unit }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block chart_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const productionData = {{ data.production_by_product_json | tojson }};
    const labels = productionData.map(p => p.name);
    const quantities = productionData.map(p => p.quantity_produced);
    
    new Chart(document.getElementById('productionChart'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Quantité Produite',
                data: quantities,
                backgroundColor: 'rgba(13, 110, 253, 0.8)',
                borderColor: 'rgb(13, 110, 253)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
});
</script>
{% endblock %}

{% block ai_section %}
<!-- PHASE 3 - Intégration IA -->
{% include 'components/ai_summary_block.html' %}

<script src="{{ url_for('static', filename='js/ai_forecast.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Extraire les métadonnées IA du rapport
    const metadata = {
        growth_rate: {{ data.growth_rate | default(0) | tojson }},
        variance: {{ data.variance | default(0) | tojson }},
        trend_direction: {{ data.trend_direction | default('stable') | tojson }},
        benchmark: {{ data.benchmark | default({}) | tojson }}
    };
    
    // Initialiser le module IA
    initAIModule({
        type: "daily",
        reportName: "production",
        endpoints: {
            forecast: null,
            insights: "/dashboards/api/daily/ai-insights",
            anomalies: "/dashboards/api/daily/anomalies"
        },
        metadata: metadata
    });
});
</script>
{% endblock %}

