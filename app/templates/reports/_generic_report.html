{% extends "reports/_report_base.html" %}

{% set kpi_labels = {
    'total_revenue': 'Chiffre d\'affaires',
    'total_transactions': 'Nombre de transactions',
    'average_basket': 'Panier moyen',
    'cogs': 'Coût des marchandises vendues',
    'labor_cost': 'Coût de main d\'œuvre',
    'total_labor_cost': 'Coût total du personnel',
    'prime_cost': 'Coût de revient',
    'prime_cost_percentage': 'Pourcentage de coût de revient',
    'gross_margin': 'Marge brute',
    'gross_margin_percentage': 'Pourcentage de marge brute',
    'net_margin_percentage': 'Pourcentage de marge nette',
    'gross_margin_percent': 'Pourcentage de marge brute',
    'expenses': 'Charges',
    'ebitda': 'EBITDA',
    'net_income': 'Résultat net',
    'total_value_lost': 'Valeur totale perdue',
    'waste_percentage': 'Pourcentage de gaspillage',
    'is_acceptable': 'Acceptable',
    'total_alerts': 'Total des alertes',
    'total_units': 'Unités produites',
    'total_orders': 'Commandes totales',
    'total_hours': 'Heures travaillées',
    'overtime_hours': 'Heures supplémentaires',
    'total_outflows': 'Total des décaissements',
    'purchases_outflows': 'Décaissements achats',
    'payroll_outflows': 'Décaissements salaires',
    'expected_inflows': 'Encaissements prévus',
    'net_cash_flow': 'Flux de trésorerie net',
    'current_balance': 'Solde actuel',
    'forecasted_balance': 'Solde prévisionnel',
    'stock_rotation': 'Rotation des stocks',
    'days_coverage': 'Jours de couverture',
    'average_stock_value': 'Valeur moyenne du stock',
    'productivity': 'Productivité',
    'efficiency_rate': 'Taux d\'efficacité',
    'conformity_rate': 'Taux de conformité'
} %}

{% macro translate_kpi(key) %}
    {% if kpi_labels[key] %}
        {{ kpi_labels[key] }}
    {% else %}
        {{ key.replace('_', ' ').title() }}
    {% endif %}
{% endmacro %}

{% block kpis %}
<div class="row mb-4">
    {% for key, value in data.items() %}
        {% if key not in ['start_date', 'end_date', 'date', 'year', 'month', 'waste_declarations', 'waste_by_reason', 'orders', 'top_products', 'sales_by_category', 'hourly_sales', 'production_by_product', 'category_data', 'margin_data', 'current_week_sales', 'prev_week_sales', 'product_performance', 'stock_alerts', 'low_stock_products', 'out_of_stock', 'coverage_data', 'waste_declarations_data'] and (value is number or value is string) %}
        <div class="col-md-3 mb-3">
            <div class="card kpi-card border-primary">
                <div class="card-body">
                    <div class="kpi-label">{{ translate_kpi(key) }}</div>
                    <div class="kpi-value text-primary">
                        {% if value is float or value is number %}
                            {% if value is float and value < 1 %}
                                {{ "{:,.2%}".format(value) }}
                            {% elif 'percentage' in key.lower() or 'percent' in key.lower() or '%' in key.lower() %}
                                {{ "{:,.2f}".format(value) }}%
                            {% elif 'amount' in key.lower() or 'cost' in key.lower() or 'revenue' in key.lower() or 'value' in key.lower() or 'price' in key.lower() or 'salary' in key.lower() or 'balance' in key.lower() or 'flow' in key.lower() %}
                                {{ "{:,.0f}".format(value) }} DA
                            {% else %}
                                {{ "{:,.2f}".format(value) }}
                            {% endif %}
                        {% elif value is string %}
                            {{ value }}
                        {% else %}
                            {{ value }}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    {% endfor %}
</div>
{% endblock %}

{% block data_tables %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-table me-2"></i>Données Détaillées du Rapport</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Indicateur</th>
                                <th class="text-end">Valeur</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for key, value in data.items() %}
                                {% if key not in ['start_date', 'end_date', 'date', 'year', 'month'] %}
                                <tr>
                                    <td><strong>{{ translate_kpi(key) }}</strong></td>
                                    <td class="text-end">
                                        {% if value is number %}
                                            {% if value is float and value < 1 and 'percentage' not in key.lower() %}
                                                {{ "{:,.2%}".format(value) }}
                                            {% elif 'percentage' in key.lower() or 'percent' in key.lower() or '%' in key.lower() %}
                                                {{ "{:,.2f}".format(value) }}%
                                            {% elif 'amount' in key.lower() or 'cost' in key.lower() or 'revenue' in key.lower() or 'value' in key.lower() or 'price' in key.lower() or 'salary' in key.lower() or 'balance' in key.lower() or 'flow' in key.lower() %}
                                                {{ "{:,.0f}".format(value) }} DA
                                            {% else %}
                                                {{ "{:,.2f}".format(value) }}
                                            {% endif %}
                                        {% elif value is string or value is none %}
                                            {{ value or 'N/A' }}
                                        {% elif value is mapping %}
                                            <span class="badge bg-info">{{ value|length }} clés</span>
                                        {% elif value is sequence and value is not string %}
                                            <span class="badge bg-info">{{ value|length }} éléments</span>
                                        {% else %}
                                            {{ value }}
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

