{% extends "reports/_report_base.html" %}

{% set report_type = 'profitability' %}
{% set export_params = '?start_date=' + (data.start_date.strftime('%Y-%m-%d') if data.start_date else '') + '&end_date='
+ (data.end_date.strftime('%Y-%m-%d') if data.end_date else '') %}

{% block report_icon %}bi-graph-up-arrow{% endblock %}
{% block report_title %}Rentabilit√© & Tr√©sorerie{% endblock %}
{% block report_description %}
Analyse Performance vs Cash du {{ data.start_date.strftime('%d/%m/%Y') }} au {{ data.end_date.strftime('%d/%m/%Y') }}
{% endblock %}

{% block filter_fields %}
<div class="col-md-3">
    <label class="form-label">Date de d√©but</label>
    <input type="date" name="start_date" class="form-control" value="{{ data.start_date.strftime('%Y-%m-%d') }}">
</div>
<div class="col-md-3">
    <label class="form-label">Date de fin</label>
    <input type="date" name="end_date" class="form-control" value="{{ data.end_date.strftime('%Y-%m-%d') }}">
</div>
{% endblock %}

{% block kpis %}
<div class="row mb-4">
    <!-- CA Ventes (Performance) -->
    <div class="col-md-2">
        <div class="card kpi-card border-primary h-100">
            <div class="card-body text-center">
                <div class="kpi-label">CA Ventes</div>
                <div class="kpi-value text-primary" style="font-size: 1.5rem;">{{
                    "{:,.0f}".format(data.totals.ca_ventes) }}</div>
                <small class="text-muted">DA (Performance)</small>
            </div>
        </div>
    </div>

    <!-- Co√ªt Mati√®re -->
    <div class="col-md-2">
        <div class="card kpi-card border-warning h-100">
            <div class="card-body text-center">
                <div class="kpi-label">Co√ªt Mati√®re</div>
                <div class="kpi-value text-warning" style="font-size: 1.5rem;">{{ "{:,.0f}".format(data.totals.cogs) }}
                </div>
                <small class="text-muted">DA ({{ data.totals.cogs_percent }}%)</small>
            </div>
        </div>
    </div>

    <!-- Main d'≈íuvre -->
    <div class="col-md-2">
        <div class="card kpi-card border-info h-100">
            <div class="card-body text-center">
                <div class="kpi-label">Main d'≈íuvre</div>
                <div class="kpi-value text-info" style="font-size: 1.5rem;">{{ "{:,.0f}".format(data.totals.labor_cost)
                    }}</div>
                <small class="text-muted">DA ({{ data.totals.labor_percent }}%)</small>
            </div>
        </div>
    </div>

    <!-- Marge Nette -->
    <div class="col-md-2">
        <div
            class="card kpi-card {% if data.totals.marge_nette >= 0 %}border-success{% else %}border-danger{% endif %} h-100">
            <div class="card-body text-center">
                <div class="kpi-label">Marge Nette</div>
                <div class="kpi-value {% if data.totals.marge_nette >= 0 %}text-success{% else %}text-danger{% endif %}"
                    style="font-size: 1.5rem;">
                    {{ "{:,.0f}".format(data.totals.marge_nette) }}
                </div>
                <small class="text-muted">DA ({{ data.totals.margin_percent }}%)</small>
            </div>
        </div>
    </div>

    <!-- Encaissements (Cash) -->
    <div class="col-md-2">
        <div class="card kpi-card border-secondary h-100">
            <div class="card-body text-center">
                <div class="kpi-label">Encaissements</div>
                <div class="kpi-value" style="font-size: 1.5rem; color: #6c757d;">{{
                    "{:,.0f}".format(data.totals.encaissement) }}</div>
                <small class="text-muted">DA (Cash r√©el)</small>
            </div>
        </div>
    </div>

    <!-- √âcart Cash vs Ventes -->
    <div class="col-md-2">
        <div
            class="card kpi-card {% if data.totals.ecart_cash >= 0 %}border-success{% else %}border-danger{% endif %} h-100">
            <div class="card-body text-center">
                <div class="kpi-label">√âcart Cash</div>
                <div class="kpi-value {% if data.totals.ecart_cash >= 0 %}text-success{% else %}text-danger{% endif %}"
                    style="font-size: 1.5rem;">
                    {% if data.totals.ecart_cash >= 0 %}+{% endif %}{{ "{:,.0f}".format(data.totals.ecart_cash) }}
                </div>
                <small class="text-muted">DA (Cash - Ventes)</small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block charts %}
<div class="row mb-4">
    <!-- Graphique CA vs Encaissements -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-bar-chart me-2"></i>CA Ventes vs Encaissements (Cash)</h6>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="revenueVsCashChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphique Marge & √âcart -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-pie-chart me-2"></i>Marge Nette & √âcart Cash</h6>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="marginGapChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block data_tables %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-table me-2"></i>D√©tail Quotidien</h6>
                <span class="badge bg-secondary">{{ data.days_count }} jours</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>Date</th>
                                <th class="text-end">CA Ventes<br><small class="fw-normal">(Performance)</small></th>
                                <th class="text-end">Co√ªt Mati√®re<br><small class="fw-normal">(COGS)</small></th>
                                <th class="text-end">Main d'≈íuvre<br><small class="fw-normal">(Labor)</small></th>
                                <th class="text-end">Marge Nette<br><small class="fw-normal">(Calcul√©)</small></th>
                                <th class="text-end">Encaissement<br><small class="fw-normal">(Cash)</small></th>
                                <th class="text-end">√âcart<br><small class="fw-normal">(Cash - Ventes)</small></th>
                                <th class="text-center">Cmds</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for day in data.daily_data %}
                            <tr>
                                <td>
                                    <strong>{{ day.date.strftime('%d/%m/%Y') }}</strong>
                                    <br><small class="text-muted">{{ day.date.strftime('%A') }}</small>
                                </td>
                                <td class="text-end">
                                    <span class="text-primary fw-bold">{{ "{:,.0f}".format(day.ca_ventes) }} DA</span>
                                </td>
                                <td class="text-end">
                                    <span class="text-warning">-{{ "{:,.0f}".format(day.cogs) }} DA</span>
                                    <br><small class="text-muted">({{ day.cogs_percent }}%)</small>
                                </td>
                                <td class="text-end">
                                    <span class="text-info">-{{ "{:,.0f}".format(day.labor_cost) }} DA</span>
                                    <br><small class="text-muted">({{ day.labor_percent }}%)</small>
                                </td>
                                <td class="text-end">
                                    <span
                                        class="{% if day.marge_nette >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                                        {% if day.marge_nette >= 0 %}+{% endif %}{{ "{:,.0f}".format(day.marge_nette) }}
                                        DA
                                    </span>
                                    <br><small class="text-muted">({{ day.margin_percent }}%)</small>
                                </td>
                                <td class="text-end">
                                    <span class="fw-bold">{{ "{:,.0f}".format(day.encaissement) }} DA</span>
                                </td>
                                <td class="text-end">
                                    <span
                                        class="{% if day.ecart_cash >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                                        {% if day.ecart_cash >= 0 %}+{% endif %}{{ "{:,.0f}".format(day.ecart_cash) }}
                                        DA
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-light text-dark">
                                        {{ day.pos_count + day.shop_count }}
                                    </span>
                                    <br><small class="text-muted">POS:{{ day.pos_count }} Shop:{{ day.shop_count
                                        }}</small>
                                    <br>
                                    <!-- Bouton pour afficher les d√©tails -->
                                    <button class="btn btn-sm btn-outline-primary mt-2" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#details-{{ loop.index }}"
                                        aria-expanded="false">
                                        <i class="bi bi-list-ul"></i> D√©tails
                                    </button>
                                </td>
                            </tr>
                            <!-- Ligne collapsible avec les d√©tails -->
                            <tr class="collapse" id="details-{{ loop.index }}">
                                <td colspan="8" class="bg-light">
                                    <div class="accordion" id="accordion-{{ loop.index }}">
                                        <!-- Accord√©on 1: CA Ventes -->
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button"
                                                    data-bs-toggle="collapse"
                                                    data-bs-target="#ca-ventes-{{ loop.index }}">
                                                    <i class="bi bi-bar-chart me-2"></i> <strong>CA Ventes : {{
                                                        "{:,.0f}".format(day.ca_ventes) }} DA</strong>
                                                </button>
                                            </h2>
                                            <div id="ca-ventes-{{ loop.index }}" class="accordion-collapse collapse"
                                                data-bs-parent="#accordion-{{ loop.index }}">
                                                <div class="accordion-body">
                                                    <h6 class="text-primary">üì¶ Ventes Comptoir ({{
                                                        "{:,.0f}".format(day.pos_orders | sum(attribute='amount')) }}
                                                        DA) - {{ day.pos_orders | length }} commandes</h6>
                                                    {% if day.pos_orders %}
                                                    <table class="table table-sm table-striped">
                                                        <thead>
                                                            <tr>
                                                                <th>ID</th>
                                                                <th>Heure</th>
                                                                <th class="text-end">Montant</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for order in day.pos_orders %}
                                                            <tr>
                                                                <td><a href="/admin/orders/{{ order.id }}">#{{ order.id
                                                                        }}</a></td>
                                                                <td>{{ order.time }}</td>
                                                                <td class="text-end">{{ "{:,.0f}".format(order.amount)
                                                                    }} DA</td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                    {% else %}
                                                    <p class="text-muted">Aucune vente comptoir</p>
                                                    {% endif %}

                                                    <h6 class="text-primary mt-3">üöö Commandes cr√©√©es + livr√©es ce jour
                                                        ({{ "{:,.0f}".format(day.shop_orders_same_day |
                                                        sum(attribute='amount')) }} DA) - {{ day.shop_orders_same_day |
                                                        length }} commandes</h6>
                                                    {% if day.shop_orders_same_day %}
                                                    <table class="table table-sm table-striped">
                                                        <thead>
                                                            <tr>
                                                                <th>ID</th>
                                                                <th>Client</th>
                                                                <th>Heure</th>
                                                                <th class="text-end">Montant</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for order in day.shop_orders_same_day %}
                                                            <tr>
                                                                <td><a href="/admin/orders/{{ order.id }}">#{{ order.id
                                                                        }}</a></td>
                                                                <td>{{ order.customer }}</td>
                                                                <td>{{ order.time }}</td>
                                                                <td class="text-end">{{ "{:,.0f}".format(order.amount)
                                                                    }} DA</td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                    {% else %}
                                                    <p class="text-muted">Aucune commande cr√©√©e + livr√©e ce jour</p>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Accord√©on 2: Encaissements -->
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button"
                                                    data-bs-toggle="collapse"
                                                    data-bs-target="#encaissements-{{ loop.index }}">
                                                    <i class="bi bi-cash-stack me-2"></i> <strong>Encaissements : {{
                                                        "{:,.0f}".format(day.encaissement) }} DA</strong>
                                                </button>
                                            </h2>
                                            <div id="encaissements-{{ loop.index }}" class="accordion-collapse collapse"
                                                data-bs-parent="#accordion-{{ loop.index }}">
                                                <div class="accordion-body">
                                                    <h6 class="text-success">‚úÖ Ventes comptoir du jour : {{
                                                        "{:,.0f}".format(day.pos_orders | sum(attribute='amount')) }} DA
                                                    </h6>
                                                    <p class="text-muted small">Voir table ci-dessus (CA Ventes /
                                                        Comptoir)</p>

                                                    <h6 class="text-success mt-3">‚úÖ Paiements commandes Shop du jour :
                                                        {{ "{:,.0f}".format(day.shop_orders_same_day |
                                                        sum(attribute='amount')) }} DA</h6>
                                                    <p class="text-muted small">Voir table ci-dessus (CA Ventes /
                                                        Commandes cr√©√©es + livr√©es ce jour)</p>

                                                    <h6 class="text-warning mt-3">‚ö†Ô∏è Paiements commandes anciennes : {{
                                                        "{:,.0f}".format(day.old_orders_total) }} DA - {{
                                                        day.old_orders_count }} commandes</h6>
                                                    <p class="text-muted small">‚ö†Ô∏è Ces montants peuvent inclure des
                                                        acomptes vers√©s avant aujour d'hui</p>
                                                    {% if day.old_orders_paid_today %}
                                                    <table class="table table-sm table-striped">
                                                        <thead>
                                                            <tr>
                                                                <th>ID</th>
                                                                <th>Cr√©√©e le</th>
                                                                <th>Livr√©e le</th>
                                                                <th>Client</th>
                                                                <th class="text-end">Montant Pay√©</th>
                                                                <th class="text-end">Total Commande</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for order in day.old_orders_paid_today %}
                                                            <tr {% if order.has_advance %}class="table-warning" {% endif
                                                                %}>
                                                                <td>
                                                                    <a href="/admin/orders/{{ order.id }}">#{{ order.id
                                                                        }}</a>
                                                                    {% if order.has_advance %}
                                                                    <i class="bi bi-coin text-warning"
                                                                        title="Acompte vers√© avant"></i>
                                                                    {% endif %}
                                                                </td>
                                                                <td>{{ order.created_date }}</td>
                                                                <td>{{ order.delivered_date }}</td>
                                                                <td>{{ order.customer }}</td>
                                                                <td class="text-end fw-bold text-success">{{
                                                                    "{:,.0f}".format(order.amount) }} DA</td>
                                                                <td class="text-end"><small class="text-muted">{{
                                                                        "{:,.0f}".format(order.total_order) }}
                                                                        DA</small></td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                    <p class="text-muted small"><em>üí° Lignes en jaune = acompte vers√©
                                                            avant aujourd'hui. L'√©cart peut √™tre gonfl√© si des acomptes
                                                            sont inclus.</em></p>
                                                    {% else %}
                                                    <p class="text-muted">Aucune commande ancienne encaiss√©e ce jour</p>
                                                    {% endif %}

                                                    <h6 class="text-info mt-3">üíµ Tous les mouvements de caisse : {{
                                                        "{:,.0f}".format(day.cash_movements_total) }} DA - {{
                                                        day.cash_movements | length }} entr√©es</h6>
                                                    {% if day.cash_movements %}
                                                    <table class="table table-sm table-striped">
                                                        <thead>
                                                            <tr>
                                                                <th>Heure</th>
                                                                <th>Type</th>
                                                                <th>Description</th>
                                                                <th>Commande</th>
                                                                <th class="text-end">Montant</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for movement in day.cash_movements %}
                                                            <tr>
                                                                <td>{{ movement.time }}</td>
                                                                <td><span class="badge bg-info">{{ movement.type
                                                                        }}</span></td>
                                                                <td>
                                                                    {{ movement.reason }}
                                                                    {% if movement.notes %}
                                                                    <br><small class="text-muted">{{ movement.notes
                                                                        }}</small>
                                                                    {% endif %}
                                                                </td>
                                                                <td>
                                                                    {% if movement.order_id %}
                                                                    <a href="/admin/orders/{{ movement.order_id }}">#{{
                                                                        movement.order_id }}</a>
                                                                    {% else %}
                                                                    <span class="text-muted">-</span>
                                                                    {% endif %}
                                                                </td>
                                                                <td class="text-end fw-bold">{{
                                                                    "{:,.0f}".format(movement.amount) }} DA</td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                    <p class="text-muted small"><em>Cette table montre TOUS les
                                                            mouvements de caisse du jour, y compris les ventes comptoir,
                                                            paiements de commandes, acomptes, et entr√©es manuelles.</em>
                                                    </p>
                                                    {% else %}
                                                    <p class="text-muted">Aucun mouvement de caisse</p>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Accord√©on 3: Explication de l'√©cart -->
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button"
                                                    data-bs-toggle="collapse" data-bs-target="#ecart-{{ loop.index }}">
                                                    <i class="bi bi-graph-up-arrow me-2"></i> <strong>Explication de
                                                        l'√©cart : {% if day.ecart_cash >= 0 %}+{% endif %}{{
                                                        "{:,.0f}".format(day.ecart_cash) }} DA</strong>
                                                </button>
                                            </h2>
                                            <div id="ecart-{{ loop.index }}" class="accordion-collapse collapse"
                                                data-bs-parent="#accordion-{{ loop.index }}">
                                                <div class="accordion-body">
                                                    {% if day.ecart_cash >= 0 %}
                                                    <div class="alert alert-success">
                                                        <h6><i class="bi bi-check-circle me-2"></i>‚úÖ √âcart positif =
                                                            Tr√©sorerie saine</h6>
                                                        <p class="mb-0">Vous avez encaiss√© <strong>{{
                                                                "{:,.0f}".format(day.ecart_cash) }} DA de plus</strong>
                                                            que le CA du jour.</p>
                                                        {% if day.old_orders_count > 0 %}
                                                        <p class="mb-0 mt-2"><strong>Raison :</strong> {{
                                                            day.old_orders_count }} commande(s) cr√©√©e(s) les jours
                                                            pr√©c√©dents ont √©t√© livr√©es et pay√©es aujourd'hui.</p>
                                                        <ul class="mb-0 mt-2">
                                                            <li>Ces paiements <strong>ne comptent pas</strong> dans le
                                                                "CA Ventes" du jour (qui ne compte que les ventes cr√©√©es
                                                                ET livr√©es aujourd'hui)</li>
                                                            <li>Mais ils <strong>comptent bien</strong> dans les
                                                                "Encaissements" (argent r√©ellement rentr√© en caisse)
                                                            </li>
                                                        </ul>
                                                        {% endif %}
                                                    </div>
                                                    {% else %}
                                                    <div class="alert alert-warning">
                                                        <h6><i class="bi bi-exclamation-triangle me-2"></i>‚ö†Ô∏è √âcart
                                                            n√©gatif = Ventes non encore encaiss√©es</h6>
                                                        <p class="mb-0">Les encaissements sont <strong>{{
                                                                "{:,.0f}".format(day.ecart_cash|abs) }} DA de
                                                                moins</strong> que le CA du jour.</p>
                                                        <p class="mb-0 mt-2"><strong>Raison possible :</strong> Cr√©ances
                                                            clients, ventes √† cr√©dit, ou dettes livreurs non encore
                                                            r√©gl√©es.</p>
                                                    </div>
                                                    {% endif %}

                                                    <h6 class="mt-3">R√©capitulatif</h6>
                                                    <table class="table table-sm">
                                                        <tr>
                                                            <td>CA Ventes (Performance)</td>
                                                            <td class="text-end text-primary fw-bold">{{
                                                                "{:,.0f}".format(day.ca_ventes) }} DA</td>
                                                        </tr>
                                                        <tr>
                                                            <td>Encaissements (Cash)</td>
                                                            <td class="text-end fw-bold">{{
                                                                "{:,.0f}".format(day.encaissement) }} DA</td>
                                                        </tr>
                                                        <tr class="table-active">
                                                            <td><strong>√âcart (Cash - Ventes)</strong></td>
                                                            <td
                                                                class="text-end {% if day.ecart_cash >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                                                                {% if day.ecart_cash >= 0 %}+{% endif %}{{
                                                                "{:,.0f}".format(day.ecart_cash) }} DA
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr class="fw-bold">
                                <td>TOTAUX</td>
                                <td class="text-end text-primary">{{ "{:,.0f}".format(data.totals.ca_ventes) }} DA</td>
                                <td class="text-end text-warning">-{{ "{:,.0f}".format(data.totals.cogs) }} DA</td>
                                <td class="text-end text-info">-{{ "{:,.0f}".format(data.totals.labor_cost) }} DA</td>
                                <td
                                    class="text-end {% if data.totals.marge_nette >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    {% if data.totals.marge_nette >= 0 %}+{% endif %}{{
                                    "{:,.0f}".format(data.totals.marge_nette) }} DA
                                </td>
                                <td class="text-end">{{ "{:,.0f}".format(data.totals.encaissement) }} DA</td>
                                <td
                                    class="text-end {% if data.totals.ecart_cash >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    {% if data.totals.ecart_cash >= 0 %}+{% endif %}{{
                                    "{:,.0f}".format(data.totals.ecart_cash) }} DA
                                </td>
                                <td class="text-center">{{ data.totals.total_orders }}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Analyse -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card {% if data.totals.marge_nette >= 0 %}border-success{% else %}border-danger{% endif %}">
            <div
                class="card-header {% if data.totals.marge_nette >= 0 %}bg-success{% else %}bg-danger{% endif %} text-white">
                <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Analyse Performance</h6>
            </div>
            <div class="card-body">
                {% if data.totals.marge_nette >= 0 %}
                <div class="alert alert-success">
                    <h6><i class="bi bi-check-circle me-2"></i>P√©riode Rentable</h6>
                    <p class="mb-0">La marge nette est de <strong>{{ "{:,.0f}".format(data.totals.marge_nette) }}
                            DA</strong> soit <strong>{{ data.totals.margin_percent }}%</strong> du CA.</p>
                </div>
                {% else %}
                <div class="alert alert-danger">
                    <h6><i class="bi bi-exclamation-triangle me-2"></i>Attention - P√©riode D√©ficitaire</h6>
                    <p class="mb-0">La marge nette est n√©gative : <strong>{{ "{:,.0f}".format(data.totals.marge_nette)
                            }} DA</strong>. Actions recommand√©es :</p>
                    <ul class="mb-0 mt-2">
                        <li>R√©viser les co√ªts mati√®res ({{ data.totals.cogs_percent }}% du CA)</li>
                        <li>Optimiser les co√ªts de main d'≈ìuvre ({{ data.totals.labor_percent }}% du CA)</li>
                        <li>Analyser les prix de vente</li>
                    </ul>
                </div>
                {% endif %}

                <h6 class="mt-3">R√©partition des Co√ªts</h6>
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span>Co√ªt Mati√®re (COGS)</span>
                        <span>{{ data.totals.cogs_percent }}%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar bg-warning" style="width: {{ data.totals.cogs_percent }}%"></div>
                    </div>
                </div>
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span>Main d'≈íuvre</span>
                        <span>{{ data.totals.labor_percent }}%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar bg-info" style="width: {{ data.totals.labor_percent }}%"></div>
                    </div>
                </div>
                <div>
                    <div class="d-flex justify-content-between">
                        <span>Marge Nette</span>
                        <span>{{ data.totals.margin_percent }}%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar {% if data.totals.margin_percent >= 0 %}bg-success{% else %}bg-danger{% endif %}"
                            style="width: {{ [data.totals.margin_percent, 0] | max }}%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card {% if data.totals.ecart_cash >= 0 %}border-success{% else %}border-warning{% endif %}">
            <div
                class="card-header {% if data.totals.ecart_cash >= 0 %}bg-success{% else %}bg-warning{% endif %} text-white">
                <h6 class="mb-0"><i class="bi bi-cash-stack me-2"></i>Analyse Tr√©sorerie</h6>
            </div>
            <div class="card-body">
                {% if data.totals.ecart_cash >= 0 %}
                <div class="alert alert-success">
                    <h6><i class="bi bi-check-circle me-2"></i>Tr√©sorerie Positive</h6>
                    <p class="mb-0">Les encaissements (<strong>{{ "{:,.0f}".format(data.totals.encaissement) }}
                            DA</strong>) d√©passent le CA ventes (<strong>{{ "{:,.0f}".format(data.totals.ca_ventes) }}
                            DA</strong>) de <strong>+{{ "{:,.0f}".format(data.totals.ecart_cash) }} DA</strong>.</p>
                    <p class="mb-0 mt-2"><small>Cela peut indiquer des encaissements d'acomptes, des paiements diff√©r√©s
                            de p√©riodes pr√©c√©dentes, ou des entr√©es diverses.</small></p>
                </div>
                {% else %}
                <div class="alert alert-warning">
                    <h6><i class="bi bi-exclamation-triangle me-2"></i>Attention - √âcart Tr√©sorerie</h6>
                    <p class="mb-0">Les encaissements (<strong>{{ "{:,.0f}".format(data.totals.encaissement) }}
                            DA</strong>) sont inf√©rieurs au CA ventes (<strong>{{
                            "{:,.0f}".format(data.totals.ca_ventes) }} DA</strong>) de <strong>{{
                            "{:,.0f}".format(data.totals.ecart_cash) }} DA</strong>.</p>
                    <p class="mb-0 mt-2"><small>Cela peut indiquer des cr√©ances clients, des ventes non encore
                            encaiss√©es, ou des dettes livreurs.</small></p>
                </div>
                {% endif %}

                <h6 class="mt-3">Comparaison Performance vs Cash</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <tr>
                            <td>CA Ventes (Performance)</td>
                            <td class="text-end text-primary fw-bold">{{ "{:,.0f}".format(data.totals.ca_ventes) }} DA
                            </td>
                        </tr>
                        <tr>
                            <td>Encaissements (Cash)</td>
                            <td class="text-end fw-bold">{{ "{:,.0f}".format(data.totals.encaissement) }} DA</td>
                        </tr>
                        <tr class="table-active">
                            <td><strong>√âcart (Cash - Ventes)</strong></td>
                            <td
                                class="text-end {% if data.totals.ecart_cash >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                                {% if data.totals.ecart_cash >= 0 %}+{% endif %}{{
                                "{:,.0f}".format(data.totals.ecart_cash) }} DA
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block chart_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Donn√©es pour les graphiques
        const chartData = {{ data.chart_data | tojson
    }};

    // Graphique CA vs Encaissements
    new Chart(document.getElementById('revenueVsCashChart'), {
        type: 'bar',
        data: {
            labels: chartData.labels,
            datasets: [
                {
                    label: 'CA Ventes (Performance)',
                    data: chartData.ca_ventes,
                    backgroundColor: 'rgba(13, 110, 253, 0.7)',
                    borderColor: 'rgba(13, 110, 253, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Encaissements (Cash)',
                    data: chartData.encaissement,
                    backgroundColor: 'rgba(108, 117, 125, 0.7)',
                    borderColor: 'rgba(108, 117, 125, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            return context.dataset.label + ': ' + context.raw.toLocaleString() + ' DA';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function (value) {
                            return value.toLocaleString() + ' DA';
                        }
                    }
                }
            }
        }
    });

    // Graphique Marge & √âcart
    new Chart(document.getElementById('marginGapChart'), {
        type: 'line',
        data: {
            labels: chartData.labels,
            datasets: [
                {
                    label: 'Marge Nette',
                    data: chartData.marge_nette,
                    borderColor: 'rgba(25, 135, 84, 1)',
                    backgroundColor: 'rgba(25, 135, 84, 0.2)',
                    fill: true,
                    tension: 0.3
                },
                {
                    label: '√âcart Cash',
                    data: chartData.ecart_cash,
                    borderColor: 'rgba(255, 193, 7, 1)',
                    backgroundColor: 'rgba(255, 193, 7, 0.2)',
                    fill: true,
                    tension: 0.3
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            const sign = context.raw >= 0 ? '+' : '';
                            return context.dataset.label + ': ' + sign + context.raw.toLocaleString() + ' DA';
                        }
                    }
                }
            },
            scales: {
                y: {
                    ticks: {
                        callback: function (value) {
                            const sign = value >= 0 ? '+' : '';
                            return sign + value.toLocaleString() + ' DA';
                        }
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}

{% block ai_section %}
<!-- PHASE 3 - Int√©gration IA (optionnel) -->
{% endblock %}