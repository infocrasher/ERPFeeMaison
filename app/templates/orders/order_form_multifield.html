{% extends "base.html" %}
{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0"><i class="bi bi-cart-plus me-2"></i>Nouvelle Commande</h1>
                <a href="{{ url_for('orders.list_orders') }}" class="btn btn-outline-secondary"><i class="bi bi-list me-1"></i>Liste Demandes</a>
            </div>

            {% for field, errors in form.errors.items() %}
                {% for error in errors %}
                    <div class="alert alert-danger" role="alert">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i> {{ form[field].label.text if field in form else field }}: {{ error }}
                    </div>
                {% endfor %}
            {% endfor %}

            <form method="POST" id="order-form">
                {{ form.hidden_tag() }}

                <div class="card mb-4">
                    <div class="card-header"><h5 class="card-title mb-0"><i class="bi bi-tag me-2"></i>Type de Demande</h5></div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                {{ form.order_type.label(class="form-label", id="order_type_label") }}
                                {{ form.order_type(class="form-select", id="order_type") }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4" id="customer_section_card">
                    <div class="card-header"><h5 class="card-title mb-0"><i class="bi bi-person me-2"></i>Informations Client</h5></div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.customer_name.label(class="form-label") }}
                                {{ form.customer_name(class="form-control" + (' is-invalid' if form.customer_name.errors else ""), id="customer_name_input") }}
                                {% for error in form.customer_name.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.customer_phone.label(class="form-label") }}
                                {{ form.customer_phone(class="form-control" + (' is-invalid' if form.customer_phone.errors else ""), id="customer_phone_input") }}
                                {% for error in form.customer_phone.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="col-12" id="customer_address_wrapper">
                                {{ form.customer_address.label(class="form-label") }}
                                {{ form.customer_address(class="form-control" + (' is-invalid' if form.customer_address.errors else ""), id="customer_address_input", placeholder="Adresse complète...") }}
                                {% for error in form.customer_address.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4" id="service_and_planning_section_card">
                    <div class="card-header"><h5 class="card-title mb-0"><i class="bi bi-truck me-2"></i>Options de Service et Planification</h5></div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3" id="delivery_option_wrapper_div">
                                {{ form.delivery_option.label(class="form-label") }}
                                {{ form.delivery_option(class="form-select", id="delivery_option") }}
                            </div>
                            <div class="col-md-6 mb-3" id="due_date_wrapper_div">
                                {{ form.due_date.label(class="form-label") }}
                                {{ form.due_date(class="form-control" + (" is-invalid" if form.due_date.errors else ""), id="due_date", type="datetime-local") }}
                                {% if form.due_date.errors %}
                                    <div class="invalid-feedback d-block">{% for error in form.due_date.errors %}{{ error }}{% endfor %}</div>
                                {% endif %}
                                <div class="form-text">Date et heure prévues.</div>
                            </div>
                            <div class="col-md-6 mb-3 price-related" id="delivery_cost_field_wrapper_div">
                                {{ form.delivery_cost.label(class="form-label") }}
                                <div class="input-group">
                                    {{ form.delivery_cost(class="form-control" + (' is-invalid' if form.delivery_cost.errors else ""), id="delivery_cost", step="0.01") }}
                                    <span class="input-group-text">DA</span>
                                </div>
                                {% for error in form.delivery_cost.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                {% include "orders/_order_items_fieldlist.html" %}

                <div class="card mb-4">
                    <div class="card-header"><h5 class="card-title mb-0"><i class="bi bi-chat-text me-2"></i>Notes Spéciales</h5></div>
                    <div class="card-body">
                        {{ form.notes.label(class="form-label") }}
                        {{ form.notes(class="form-control", id="notes_input", placeholder="Instructions spéciales...") }}
                    </div>
                </div>

                <div class="order-summary price-related">
                    <h5><i class="bi bi-calculator me-2"></i>Résumé de la Commande</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between"><span>Sous-total articles:</span><span class="fw-bold" id="items-total">0.00 DA</span></div>
                            <div class="d-flex justify-content-between" id="delivery_total_summary_line_display"><span>Frais de livraison:</span><span class="fw-bold" id="delivery-total">0.00 DA</span></div>
                            <hr>
                            <div class="d-flex justify-content-between fs-5"><span><strong>Total Général:</strong></span><span class="fw-bold text-success" id="grand-total">0.00 DA</span></div>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2 mt-4">
                    <input class="btn btn-primary btn-lg" id="submit" name="submit" type="submit" value="Enregistrer la commande">
                    <a href="{{ url_for('orders.list_orders') }}" class="btn btn-secondary btn-lg"><i class="bi bi-arrow-left me-1"></i>Annuler</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function updateAddressFieldVisibility() {
    const orderType = document.getElementById('order_type').value;
    const deliveryOption = document.getElementById('delivery_option').value;
    const addressWrapper = document.getElementById('customer_address_wrapper');
    if (orderType === 'customer_order' && deliveryOption === 'delivery') {
        addressWrapper.style.display = 'block';
    } else {
        addressWrapper.style.display = 'none';
    }
}
function updateCustomerSectionVisibility() {
    const orderType = document.getElementById('order_type').value;
    const customerSection = document.getElementById('customer_section_card');
    if (orderType === 'customer_order') {
        customerSection.style.display = 'block';
    } else {
        customerSection.style.display = 'none';
    }
}
document.addEventListener('DOMContentLoaded', function () {
    const orderType = document.getElementById('order_type');
    const deliveryOption = document.getElementById('delivery_option');
    orderType.addEventListener('change', function () {
        updateAddressFieldVisibility();
        updateCustomerSectionVisibility();
    });
    deliveryOption.addEventListener('change', updateAddressFieldVisibility);
    updateAddressFieldVisibility();
    updateCustomerSectionVisibility();
});
</script>
{% endblock %}