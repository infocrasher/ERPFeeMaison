{% extends "base.html" %}

{% block title %}{{ inventory.title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <!-- En-t√™te -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-0">{{ inventory.title }}</h2>
                    <p class="text-muted mb-0">
                        Cr√©√© le {{ inventory.created_at.strftime('%d/%m/%Y √† %H:%M') }}
                        par {{ inventory.created_by.username if inventory.created_by else 'N/A' }}
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('inventory.index') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>Retour
                    </a>
                    {% if inventory.can_be_edited() %}
                        <a href="{{ url_for('inventory.complete', id=inventory.id) }}" 
                           class="btn btn-success" 
                           onclick="return confirm('Marquer cet inventaire comme termin√© ?')">
                            <i class="bi bi-check-circle me-2"></i>Terminer
                        </a>
                    {% endif %}
                </div>
            </div>

            <!-- Informations de l'inventaire -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">üìã Informations de l'inventaire</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Date :</strong> {{ inventory.inventory_date.strftime('%d/%m/%Y') }}</p>
                                    <p><strong>Statut :</strong> 
                                        {% if inventory.status.value == 'en_cours' %}
                                            <span class="badge bg-warning">En cours</span>
                                        {% elif inventory.status.value == 'complete' %}
                                            <span class="badge bg-info">Termin√©</span>
                                        {% elif inventory.status.value == 'valide' %}
                                            <span class="badge bg-success">Valid√©</span>
                                        {% elif inventory.status.value == 'cloture' %}
                                            <span class="badge bg-secondary">Cl√¥tur√©</span>
                                        {% endif %}
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Emplacements :</strong></p>
                                    <div>
                                        {% if inventory.include_ingredients_magasin %}
                                            <span class="badge bg-primary me-1">üì¶ Magasin</span>
                                        {% endif %}
                                        {% if inventory.include_ingredients_local %}
                                            <span class="badge bg-warning me-1">üè≠ Local</span>
                                        {% endif %}
                                        {% if inventory.include_consommables %}
                                            <span class="badge bg-info me-1">üìã Consommables</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% if inventory.notes %}
                                <div class="mt-3">
                                    <strong>Notes :</strong>
                                    <p class="text-muted">{{ inventory.notes }}</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">üìä Statistiques</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6">
                                    <h4 class="text-primary">{{ stats.total_items }}</h4>
                                    <small class="text-muted">Produits</small>
                                </div>
                                <div class="col-6">
                                    <h4 class="text-success">{{ stats.counted_items }}</h4>
                                    <small class="text-muted">Compt√©s</small>
                                </div>
                            </div>
                            <hr>
                            <div class="row text-center">
                                <div class="col-6">
                                    <h4 class="text-warning">{{ stats.items_with_variance }}</h4>
                                    <small class="text-muted">Avec √©cart</small>
                                </div>
                                <div class="col-6">
                                    <h4 class="text-danger">{{ stats.critical_variances }}</h4>
                                    <small class="text-muted">Critiques</small>
                                </div>
                            </div>
                            <hr>
                            <div class="text-center">
                                <h5 class="text-info">{{ "%.2f"|format(stats.total_variance_value) }} DA</h5>
                                <small class="text-muted">Valeur des √©carts</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progression par emplacement -->
            <div class="row mb-4">
                {% for location in inventory.locations_list %}
                    {% set location_items = items_by_location.get(location, []) %}
                    {% set location_counted = location_items | selectattr('is_counted') | list | length %}
                    {% set location_total = location_items | length %}
                    {% set location_progress = (location_counted / location_total * 100) if location_total > 0 else 0 %}
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    {% if location == 'ingredients_magasin' %}
                                        üì¶ Magasin (Labo A)
                                    {% elif location == 'ingredients_local' %}
                                        üè≠ Local (Labo B)
                                    {% elif location == 'consommables' %}
                                        üìã Consommables
                                    {% endif %}
                                </h6>
                                <span class="badge bg-primary">{{ location_counted }}/{{ location_total }}</span>
                            </div>
                            <div class="card-body">
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar" role="progressbar" 
                                         style="width: {{ location_progress }}%"
                                         aria-valuenow="{{ location_progress }}" 
                                         aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <small class="text-muted">{{ "%.1f"|format(location_progress) }}% termin√©</small>
                                    {% if inventory.can_be_edited() %}
                                        <a href="{{ url_for('inventory.count_location', id=inventory.id, location=location) }}" 
                                           class="btn btn-sm btn-outline-primary">
                                            {% if location_counted == location_total %}
                                                <i class="bi bi-eye me-1"></i>Voir
                                            {% else %}
                                                <i class="bi bi-pencil me-1"></i>Saisir
                                            {% endif %}
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <!-- Actions selon le statut -->
            {% if inventory.status.value == 'complete' and inventory.can_be_validated() %}
                <div class="alert alert-info">
                    <h5 class="alert-heading">
                        <i class="bi bi-info-circle me-2"></i>Inventaire termin√©
                    </h5>
                    <p class="mb-3">Tous les produits ont √©t√© compt√©s. Vous pouvez maintenant valider l'inventaire et appliquer les ajustements.</p>
                    <a href="{{ url_for('inventory.validate', id=inventory.id) }}" class="btn btn-success">
                        <i class="bi bi-check-circle me-2"></i>Valider l'inventaire
                    </a>
                </div>
            {% elif inventory.status.value == 'valide' %}
                <div class="alert alert-success">
                    <h5 class="alert-heading">
                        <i class="bi bi-check-circle me-2"></i>Inventaire valid√©
                    </h5>
                    <p class="mb-0">
                        Valid√© le {{ inventory.validated_at.strftime('%d/%m/%Y √† %H:%M') }}
                        par {{ inventory.validated_by.username if inventory.validated_by else 'N/A' }}
                    </p>
                </div>
            {% endif %}

            <!-- D√©tail par emplacement -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üìã D√©tail par emplacement</h5>
                </div>
                <div class="card-body">
                    {% for location in inventory.locations_list %}
                        {% set location_items = items_by_location.get(location, []) %}
                        {% if location_items %}
                            <div class="mb-4">
                                <h6 class="text-primary mb-3">
                                    {% if location == 'ingredients_magasin' %}
                                        üì¶ Magasin (Labo A)
                                    {% elif location == 'ingredients_local' %}
                                        üè≠ Local (Labo B)
                                    {% elif location == 'consommables' %}
                                        üìã Consommables
                                    {% endif %}
                                    <span class="badge bg-light text-dark ms-2">{{ location_items | length }} produits</span>
                                </h6>
                                
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Produit</th>
                                                <th>Unit√©</th>
                                                <th class="text-end">Stock th√©orique</th>
                                                <th class="text-end">Stock physique</th>
                                                <th class="text-end">√âcart</th>
                                                <th class="text-end">%</th>
                                                <th>Statut</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in location_items %}
                                                <tr>
                                                    <td>
                                                        <strong>{{ item.product.name }}</strong>
                                                        {% if item.notes %}
                                                            <br><small class="text-muted">{{ item.notes }}</small>
                                                        {% endif %}
                                                    </td>
                                                    <td>{{ item.product.unit }}</td>
                                                    <td class="text-end">{{ item.product.format_quantity_display(item.theoretical_stock) }}</td>
                                                    <td class="text-end">
                                                        {% if item.physical_stock is not none %}
                                                            {{ item.product.format_quantity_display(item.physical_stock) }}
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-end">
                                                        {% if item.variance is not none %}
                                                            <span class="{% if item.variance > 0 %}text-success{% elif item.variance < 0 %}text-danger{% else %}text-muted{% endif %}">
                                                                {{ "+" if item.variance > 0 else "" }}{{ item.product.format_quantity_display(item.variance) }}
                                                            </span>
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-end">
                                                        {% if item.variance_percentage is not none %}
                                                            <span class="{% if item.variance_level.value == 'critique' %}text-danger{% elif item.variance_level.value == 'normal' %}text-warning{% else %}text-success{% endif %}">
                                                                {{ "%.1f"|format(item.variance_percentage) }}%
                                                            </span>
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if item.is_counted %}
                                                            {% if item.has_variance %}
                                                                {% if item.variance_level.value == 'critique' %}
                                                                    <span class="badge bg-danger">Critique</span>
                                                                {% elif item.variance_level.value == 'normal' %}
                                                                    <span class="badge bg-warning">Normal</span>
                                                                {% else %}
                                                                    <span class="badge bg-success">OK</span>
                                                                {% endif %}
                                                            {% else %}
                                                                <span class="badge bg-success">OK</span>
                                                            {% endif %}
                                                        {% else %}
                                                            <span class="badge bg-secondary">Non compt√©</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.progress {
    background-color: #e9ecef;
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.badge {
    font-size: 0.75em;
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
}

.alert {
    border: none;
    border-radius: 0.5rem;
}
</style>
{% endblock %}
