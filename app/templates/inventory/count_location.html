{% extends "base.html" %}

{% block title %}Saisie Inventaire - {{ location_name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <!-- En-t√™te -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-0">üìã Saisie Inventaire</h2>
                    <p class="text-muted mb-0">
                        {{ inventory.title }} - {{ location_name }}
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('inventory.view', id=inventory.id) }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>Retour √† l'inventaire
                    </a>
                </div>
            </div>

            <!-- Progression -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">Progression de la saisie</h6>
                                <span class="badge bg-primary">{{ stats.counted_items }}/{{ stats.total_items }}</span>
                            </div>
                            <div class="progress" style="height: 10px;">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: {{ stats.progress_percentage }}%"
                                     aria-valuenow="{{ stats.progress_percentage }}" 
                                     aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                            <small class="text-muted">{{ "%.1f"|format(stats.progress_percentage) }}% termin√©</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <h5 class="text-primary mb-0">{{ stats.counted_items }}</h5>
                            <small class="text-muted">Produits compt√©s</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtres de recherche -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" id="searchInput" class="form-control" placeholder="Rechercher un produit...">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select id="categoryFilter" class="form-select">
                                <option value="">Toutes les cat√©gories</option>
                                <option value="ingredient">Ingr√©dients</option>
                                <option value="produit_fini">Produits Finis</option>
                                <option value="consommable">Consommables</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select id="statusFilter" class="form-select">
                                <option value="">Tous les statuts</option>
                                <option value="counted">Compt√©s</option>
                                <option value="uncounted">Non compt√©s</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                <i class="bi bi-x-circle me-1"></i>Effacer
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Liste des produits √† saisir -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üì¶ Produits √† saisir</h5>
                </div>
                <div class="card-body">
                    {% if items %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Produit</th>
                                        <th>Unit√©</th>
                                        <th class="text-end">Stock th√©orique</th>
                                        <th class="text-end">Stock physique</th>
                                        <th class="text-end">√âcart</th>
                                        <th class="text-end">%</th>
                                        <th>Statut</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in items %}
                                        <tr class="{% if item.is_counted %}table-success{% endif %}" 
                                            data-product-name="{{ item.product.name|lower }}"
                                            data-category="{{ item.product.category|lower if item.product.category else 'ingredient' }}"
                                            data-status="{% if item.physical_stock is not none %}counted{% else %}uncounted{% endif %}">
                                            <td>
                                                <strong>{{ item.product.name }}</strong>
                                                {% if item.product.description %}
                                                    <br><small class="text-muted">{{ item.product.description }}</small>
                                                {% endif %}
                                            </td>
                                            <td>{{ item.product.unit }}</td>
                                            <td class="text-end">{{ item.product.format_quantity_display(item.theoretical_stock) }}</td>
                                            <td class="text-end">
                                                {% if item.physical_stock is not none %}
                                                    <strong>{{ item.product.format_quantity_display(item.physical_stock) }}</strong>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-end">
                                                {% if item.variance is not none %}
                                                    <span class="{% if item.variance > 0 %}text-success{% elif item.variance < 0 %}text-danger{% else %}text-muted{% endif %}">
                                                        {{ "+" if item.variance > 0 else "" }}{{ item.product.format_quantity_display(item.variance) }}
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-end">
                                                {% if item.variance_percentage is not none %}
                                                    <span class="{% if item.variance_level.value == 'critique' %}text-danger{% elif item.variance_level.value == 'normal' %}text-warning{% else %}text-success{% endif %}">
                                                        {{ "%.1f"|format(item.variance_percentage) }}%
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if item.is_counted %}
                                                    {% if item.has_variance %}
                                                        {% if item.variance_level.value == 'critique' %}
                                                            <span class="badge bg-danger">Critique</span>
                                                        {% elif item.variance_level.value == 'normal' %}
                                                            <span class="badge bg-warning">Normal</span>
                                                        {% else %}
                                                            <span class="badge bg-success">OK</span>
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="badge bg-success">OK</span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="badge bg-secondary">√Ä saisir</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="{{ url_for('inventory.count_item', item_id=item.id) }}" 
                                                   class="btn btn-sm {% if item.is_counted %}btn-outline-primary{% else %}btn-primary{% endif %}">
                                                    {% if item.is_counted %}
                                                        <i class="bi bi-pencil me-1"></i>Modifier
                                                    {% else %}
                                                        <i class="bi bi-plus-circle me-1"></i>Saisir
                                                    {% endif %}
                                                </a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-inbox fs-1 text-muted"></i>
                            <h5 class="text-muted mt-3">Aucun produit trouv√©</h5>
                            <p class="text-muted">Aucun produit n'est configur√© pour cet emplacement dans l'inventaire.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Actions -->
            {% if stats.counted_items == stats.total_items %}
                <div class="alert alert-success mt-4">
                    <h5 class="alert-heading">
                        <i class="bi bi-check-circle me-2"></i>Saisie termin√©e !
                    </h5>
                    <p class="mb-3">Tous les produits de cet emplacement ont √©t√© compt√©s. Vous pouvez maintenant passer √† un autre emplacement ou terminer l'inventaire.</p>
                    <a href="{{ url_for('inventory.view', id=inventory.id) }}" class="btn btn-success">
                        <i class="bi bi-arrow-right me-2"></i>Retour √† l'inventaire
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.table-success {
    background-color: rgba(25, 135, 84, 0.1) !important;
}

.progress {
    background-color: #e9ecef;
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}

.badge {
    font-size: 0.75em;
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
}

.alert {
    border: none;
    border-radius: 0.5rem;
}

.fs-1 {
    font-size: 2rem !important;
}

.hidden {
    display: none !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');
    const statusFilter = document.getElementById('statusFilter');
    const tableRows = document.querySelectorAll('tbody tr');
    
    function filterTable() {
        const searchTerm = searchInput.value.toLowerCase();
        const categoryValue = categoryFilter.value;
        const statusValue = statusFilter.value;
        
        let visibleCount = 0;
        
        tableRows.forEach(row => {
            const productName = row.getAttribute('data-product-name') || '';
            const category = row.getAttribute('data-category') || '';
            const status = row.getAttribute('data-status') || '';
            
            let showRow = true;
            
            // Filtre par recherche
            if (searchTerm && !productName.includes(searchTerm)) {
                showRow = false;
            }
            
            // Filtre par cat√©gorie
            if (categoryValue && category !== categoryValue) {
                showRow = false;
            }
            
            // Filtre par statut
            if (statusValue && status !== statusValue) {
                showRow = false;
            }
            
            if (showRow) {
                row.classList.remove('hidden');
                visibleCount++;
            } else {
                row.classList.add('hidden');
            }
        });
        
        // Mettre √† jour le compteur de r√©sultats
        updateResultsCounter(visibleCount);
    }
    
    function updateResultsCounter(count) {
        let counter = document.getElementById('resultsCounter');
        if (!counter) {
            // Cr√©er le compteur s'il n'existe pas
            const header = document.querySelector('.card-header h5');
            counter = document.createElement('span');
            counter.id = 'resultsCounter';
            counter.className = 'badge bg-secondary ms-2';
            header.appendChild(counter);
        }
        counter.textContent = `${count} produit${count > 1 ? 's' : ''}`;
    }
    
    function clearFilters() {
        searchInput.value = '';
        categoryFilter.value = '';
        statusFilter.value = '';
        filterTable();
    }
    
    // √âv√©nements
    searchInput.addEventListener('input', filterTable);
    categoryFilter.addEventListener('change', filterTable);
    statusFilter.addEventListener('change', filterTable);
    
    // Initialiser le compteur
    updateResultsCounter(tableRows.length);
    
    // Rendre la fonction clearFilters globale
    window.clearFilters = clearFilters;
});
</script>
{% endblock %}
