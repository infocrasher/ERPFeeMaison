{% extends "base.html" %}
{% from "_form_macros.html" import render_field %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">{{ title }}</h3>
                </div>
                <div class="card-body">
                    <form method="POST" novalidate>
                        {{ form.hidden_tag() }}

                        <div class="row">
                            <div class="col-md-6">{{ render_field(form.name, class="form-control") }}</div>
                            <div class="col-md-6">{{ render_field(form.finished_product, class="form-control") }}</div>
                        </div>
                        
                        {{ render_field(form.description, class="form-control", rows=3) }}

                        <hr>
                        <h4>Ingrédients</h4>
                        
                        <div id="ingredients-container">
                            <!-- ### CORRECTION ### La ligne "{{ form.ingredients.hidden_tag() }}" a été supprimée d'ici. -->
                            {% for subform in form.ingredients %}
                                <div class="row ingredient-form-row mb-2 align-items-center">
                                    <div class="col-md-4">{{ render_field(subform.product, class="form-control ingredient-select", label=False) }}</div>
                                    <div class="col-md-2">{{ render_field(subform.quantity_needed, class="form-control", label=False, placeholder="Qté") }}</div>
                                    <div class="col-md-2">{{ render_field(subform.unit, class="form-control", label=False, placeholder="Unité") }}</div>
                                    <div class="col-md-3">{{ render_field(subform.notes, class="form-control", label=False, placeholder="Notes") }}</div>
                                    <div class="col-md-1">
                                        <button type="button" class="btn btn-danger btn-sm remove-ingredient-btn" title="Supprimer l'ingrédient">X</button>
                                    </div>
                                    {{ subform.id }}
                                </div>
                            {% endfor %}
                        </div>

                        <button type="button" id="add-ingredient-btn" class="btn btn-secondary btn-sm mt-2">Ajouter un ingrédient</button>
                        
                        <hr>
                        <div class="form-group text-center">
                            <a href="{{ url_for('recipes.list_recipes') }}" class="btn btn-outline-secondary">Annuler</a>
                            {{ form.submit(class="btn btn-primary") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Template pour les nouveaux ingrédients -->
<template id="ingredient-form-template">
    <div class="row ingredient-form-row mb-2 align-items-center">
        <div class="col-md-4">
            <select name="ingredients-__INDEX__-product" class="form-control ingredient-select"></select>
        </div>
        <div class="col-md-2">
            <input type="number" step="any" name="ingredients-__INDEX__-quantity_needed" class="form-control" placeholder="Qté">
        </div>
        <div class="col-md-2">
            <input type="text" name="ingredients-__INDEX__-unit" class="form-control" placeholder="Unité">
        </div>
        <div class="col-md-3">
            <input type="text" name="ingredients-__INDEX__-notes" class="form-control" placeholder="Notes">
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-danger btn-sm remove-ingredient-btn" title="Supprimer l'ingrédient">X</button>
        </div>
    </div>
</template>

<div id="ingredients-data" data-ingredients='{{ ingredient_products_json|tojson|safe }}' style="display: none;"></div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const dataElement = document.getElementById('ingredients-data');
    const ingredientsData = JSON.parse(dataElement.dataset.ingredients);

    const container = document.getElementById('ingredients-container');
    const addButton = document.getElementById('add-ingredient-btn');
    const template = document.getElementById('ingredient-form-template');
    
    let index = container.querySelectorAll('.ingredient-form-row').length;

    function populateSelectWithOptions(selectElement, options, selectedValue = null) {
        const previouslySelected = selectedValue || selectElement.value;
        selectElement.innerHTML = '<option value="" selected>--- Choisir un ingrédient ---</option>';
        options.forEach(ingredient => {
            const option = document.createElement('option');
            option.value = ingredient.id;
            option.textContent = `${ingredient.name} (${ingredient.unit || 'N/A'})`;
            selectElement.appendChild(option);
        });

        if (previouslySelected) {
            selectElement.value = previouslySelected;
        }
    }
    
    function updateUnit(selectElement) {
        const selectedId = parseInt(selectElement.value, 10);
        const selectedIngredient = ingredientsData.find(p => p.id === selectedId);
        const row = selectElement.closest('.ingredient-form-row');
        const unitInput = row.querySelector('input[name*="unit"]');
        if (unitInput && selectedIngredient) {
            unitInput.value = selectedIngredient.unit || '';
        }
    }

    addButton.addEventListener('click', () => {
        const clone = template.content.cloneNode(true);
        const newRow = clone.firstElementChild;
        
        newRow.innerHTML = newRow.innerHTML.replace(/__INDEX__/g, index);
        container.appendChild(newRow);
        
        const newSelect = newRow.querySelector('.ingredient-select');
        populateSelectWithOptions(newSelect, ingredientsData);
        newSelect.addEventListener('change', () => updateUnit(newSelect));
        
        index++;
    });

    container.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('remove-ingredient-btn')) {
            e.target.closest('.ingredient-form-row').remove();
        }
    });

    container.querySelectorAll('.ingredient-select').forEach(select => {
        const currentValue = select.value;
        populateSelectWithOptions(select, ingredientsData, currentValue);
        select.addEventListener('change', () => updateUnit(select));
    });
});
</script>
{% endblock %}