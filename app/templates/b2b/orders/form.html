{% extends "base.html" %}

{% block title %}{{ title }} - F√©e Maison{% endblock %}

{% block content %}
<style>
    /* Am√©liorations visuelles pour les templates */
    .template-card {
        transition: all 0.3s ease;
        border: 2px solid transparent;
        cursor: pointer;
    }

    .template-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        border-color: var(--bs-primary);
    }

    .order-item-row {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid var(--bs-primary);
        margin-bottom: 15px;
    }

    /* Animation pour les nouveaux items */
    @keyframes slideInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .order-item-row {
        animation: slideInDown 0.3s ease;
    }

    /* Style pour le toast */
    .toast {
        min-width: 300px;
    }

    /* Pr√©vention des probl√®mes de modal */
    .modal {
        z-index: 1055;
    }

    .modal-backdrop {
        z-index: 1054;
    }

    /* Force la suppression des scrollbars bloqu√©es */
    body.modal-cleanup {
        overflow: auto !important;
        padding-right: 0 !important;
        margin-right: 0 !important;
    }

    /* Animation plus fluide pour √©viter les conflits */
    .modal.fade .modal-dialog {
        transition: transform 0.15s ease-out;
    }
</style>
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title mb-0">
                        <i class="bi bi-building me-2"></i>{{ title }}
                    </h3>
                </div>
                <div class="card-body">
                    <form method="POST" novalidate id="orderForm">
                        {{ form.hidden_tag() }}

                        <!-- Informations de base -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.b2b_client_id.label(class="form-label") }}
                                    {{ form.b2b_client_id(class="form-select" + (" is-invalid" if
                                    form.b2b_client_id.errors else "")) }}
                                    {% if form.b2b_client_id.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.b2b_client_id.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.delivery_date.label(class="form-label") }}
                                    {{ form.delivery_date(class="form-control" + (" is-invalid" if
                                    form.delivery_date.errors else ""), type="date") }}
                                    {% if form.delivery_date.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.delivery_date.errors %}
                                        {{ error }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>



                        <!-- Articles de la commande -->
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Articles de la commande</h5>
                            </div>
                            <div class="card-body">
                                <!-- Boutons d'ajout -->
                                <div class="d-flex gap-2 mb-3">
                                    <button type="button" class="btn btn-primary" id="add-item-btn"
                                        aria-label="Ajouter un article simple">
                                        <i class="bi bi-plus-circle me-2"></i>Ajouter un article
                                    </button>
                                    <button type="button" class="btn btn-success" id="add-composite-btn"
                                        data-bs-toggle="modal" data-bs-target="#compositeProductModal"
                                        aria-label="Cr√©er un produit compos√©">
                                        <i class="bi bi-layers me-2"></i>Ajouter produit compos√©
                                    </button>
                                </div>

                                <!-- Container pour les lignes d'articles -->
                                <div id="order-items-container">
                                    {% for item_form in form.items %}
                                    <div class="order-item-row mb-3">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label class="form-label"
                                                    for="{{ item_form.product.id }}">Produit</label>
                                                {{ item_form.product(class="form-control product-select",
                                                id=item_form.product.id) }}
                                                {% if item_form.product.errors %}
                                                <div class="invalid-feedback">
                                                    {% for error in item_form.product.errors %}
                                                    {{ error }}
                                                    {% endfor %}
                                                </div>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label"
                                                    for="{{ item_form.quantity.id }}">Quantit√©</label>
                                                {{ item_form.quantity(class="form-control quantity-input",
                                                type="number", min="1", value="1", id=item_form.quantity.id) }}
                                                {% if item_form.quantity.errors %}
                                                <div class="invalid-feedback">
                                                    {% for error in item_form.quantity.errors %}
                                                    {{ error }}
                                                    {% endfor %}
                                                </div>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label" for="{{ item_form.unit_price.id }}">Prix
                                                    unitaire</label>
                                                {{ item_form.unit_price(class="form-control", type="number",
                                                step="0.01", min="0", id=item_form.unit_price.id) }}
                                                {% if item_form.unit_price.errors %}
                                                <div class="invalid-feedback">
                                                    {% for error in item_form.unit_price.errors %}
                                                    {{ error }}
                                                    {% endfor %}
                                                </div>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-1 d-flex align-items-end">
                                                <button type="button"
                                                    class="btn btn-outline-danger btn-sm remove-item-btn"
                                                    style="display: {{ 'none' if loop.first else 'block' }}"
                                                    aria-label="Supprimer cet article">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>

                                <!-- Total -->
                                <div class="row mt-3">
                                    <div class="col-md-8"></div>
                                    <div class="col-md-4">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <h5 class="mb-0">Total: <span id="order-total">0.00</span> DA</h5>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Modal pour les produits compos√©s -->
                        <div class="modal fade" id="compositeProductModal" tabindex="-1"
                            aria-labelledby="compositeProductModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-xl">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="compositeProductModalLabel">
                                            <i class="bi bi-layers me-2"></i>Cr√©er un produit compos√©
                                        </h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div id="composite-product-form">
                                            <div class="row mb-4">
                                                <div class="col-md-6">
                                                    <div class="mb-3">
                                                        <label class="form-label" for="composite-name">Nom du produit
                                                            compos√©</label>
                                                        <input type="text" class="form-control" id="composite-name"
                                                            name="composite-name" required>
                                                        <div class="form-text">
                                                            Ce nom appara√Ætra sur la facture client
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="mb-3">
                                                        <label class="form-label" for="composite-quantity">Quantit√©
                                                            command√©e</label>
                                                        <input type="number" class="form-control"
                                                            id="composite-quantity" name="composite-quantity" value="1"
                                                            min="1" required>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="mb-3">
                                                        <label class="form-label" for="composite-unit-price">Prix
                                                            unitaire (DZD)</label>
                                                        <input type="number" class="form-control"
                                                            id="composite-unit-price" name="composite-unit-price"
                                                            step="0.01" required>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="card">
                                                <div class="card-header">
                                                    <h6 class="mb-0">
                                                        <i class="bi bi-list-ul me-2"></i>Composition du produit
                                                    </h6>
                                                    <small class="text-muted">Ajoutez les produits finis qui composent
                                                        ce produit</small>
                                                </div>
                                                <div class="card-body">
                                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                                        <button type="button" class="btn btn-outline-primary btn-sm"
                                                            id="add-component-btn">
                                                            <i class="bi bi-plus-circle me-2"></i>Ajouter un produit
                                                            fini
                                                        </button>
                                                    </div>

                                                    <div id="components-container">
                                                        <!-- Les composants seront ajout√©s ici dynamiquement -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                            <i class="bi bi-x-circle me-2"></i>Annuler
                                        </button>
                                        <button type="button" class="btn btn-primary" id="save-composite-product-btn">
                                            <i class="bi bi-check-circle me-2"></i>Ajouter √† la commande
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="mb-4">
                            {{ form.notes.label(class="form-label") }}
                            {{ form.notes(class="form-control" + (" is-invalid" if form.notes.errors else ""), rows=3)
                            }}
                            {% if form.notes.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.notes.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <!-- Total -->
                        <div class="alert alert-info">
                            <strong>Total de la commande: <span id="orderTotal">0.00</span> DA</strong>
                        </div>

                        <!-- Boutons -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('b2b.list_orders') }}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left me-2"></i>Annuler
                            </a>
                            <button type="submit" class="btn btn-primary" id="submit-btn" form="orderForm">
                                <i class="bi bi-check-circle me-2"></i>Enregistrer la commande
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        let orderItemsCounter = 0;
        let componentsCounter = 0;
        let modalInstance = null; // Instance globale du modal
        let availableProducts = []; // Sera charg√© depuis l'API

        // Fonction pour nettoyer compl√®tement tous les modals
        function forceCleanupModals() {
            // Supprimer tous les overlays
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());

            // Nettoyer le body
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            document.body.style.marginRight = '';

            // Supprimer les attributs Bootstrap
            document.body.removeAttribute('data-bs-overflow');
            document.body.removeAttribute('data-bs-padding-right');
        }

        // Fonction s√©curis√©e pour fermer le modal
        function safeCloseModal() {
            try {
                if (modalInstance) {
                    // M√©thode 1: Fermeture via l'instance
                    modalInstance.hide();

                    // Attendre que l'animation se termine
                    setTimeout(() => {
                        forceCleanupModals();
                        modalInstance = null;
                    }, 200);
                } else {
                    // M√©thode 2: Fermeture par √©v√©nement si pas d'instance
                    const modalElement = document.getElementById('compositeProductModal');
                    if (modalElement) {
                        modalElement.dispatchEvent(new Event('hide.bs.modal'));
                        setTimeout(forceCleanupModals, 200);
                    }
                }
            } catch (error) {
                console.warn('Erreur fermeture modal:', error);
                // Nettoyage d'urgence
                forceCleanupModals();
            }
        }

        // Charger les produits depuis l'API
        async function loadProducts() {
            try {
                const response = await fetch('/admin/b2b/api/products');
                if (response.ok) {
                    availableProducts = await response.json();
                    console.log('Produits charg√©s:', availableProducts.length);
                } else {
                    console.error('Erreur lors du chargement des produits');
                    // Fallback sur une liste statique en cas d'erreur
                    availableProducts = [
                        { id: 1, name: 'Mini tarte au citron', price: 80 },
                        { id: 2, name: 'Mini tarte au chocolat', price: 80 },
                        { id: 3, name: 'Mini tarte aux fruits secs', price: 90 },
                        { id: 4, name: 'P√¢tisserie au citron', price: 120 },
                        { id: 5, name: 'P√¢tisserie au chocolat', price: 120 },
                        { id: 6, name: 'P√¢tisserie au pralin√©', price: 130 },
                        { id: 7, name: 'Rechta au poulet', price: 800 },
                        { id: 8, name: 'Salade mixte', price: 200 },
                        { id: 9, name: 'Boisson 33cl', price: 100 },
                        { id: 10, name: 'Fruit de saison', price: 150 }
                    ];
                }
            } catch (error) {
                console.error('Erreur r√©seau:', error);
                // Fallback sur une liste statique
                availableProducts = [
                    { id: 1, name: 'Mini tarte au citron', price: 80 },
                    { id: 2, name: 'Mini tarte au chocolat', price: 80 },
                    { id: 3, name: 'Mini tarte aux fruits secs', price: 90 },
                    { id: 4, name: 'P√¢tisserie au citron', price: 120 },
                    { id: 5, name: 'P√¢tisserie au chocolat', price: 120 },
                    { id: 6, name: 'P√¢tisserie au pralin√©', price: 130 },
                    { id: 7, name: 'Rechta au poulet', price: 800 },
                    { id: 8, name: 'Salade mixte', price: 200 },
                    { id: 9, name: 'Boisson 33cl', price: 100 },
                    { id: 10, name: 'Fruit de saison', price: 150 }
                ];
            }
        }

        // Initialisation
        function init() {
            loadProducts().then(() => {
                initializeItemCounter();
                bindExistingItems();
                bindEvents();
                updateOrderTotal();
                forceCleanupModals();
            });
        }

        // Compter les items existants au chargement
        function initializeItemCounter() {
            const existingItems = document.querySelectorAll('[name^="items-"]');
            const indices = [];

            existingItems.forEach(item => {
                const match = item.name.match(/items-(\d+)-/);
                if (match) {
                    indices.push(parseInt(match[1]));
                }
            });

            orderItemsCounter = indices.length > 0 ? Math.max(...indices) + 1 : 1;
            console.log('Compteur initialis√© √†:', orderItemsCounter);
        }

        // G√©rer les items existants
        function bindExistingItems() {
            // G√©rer les items Jinja2 (order-item-row)
            const existingRows = document.querySelectorAll('.order-item-row');
            console.log('Items existants (Jinja2) trouv√©s:', existingRows.length);

            existingRows.forEach((row, index) => {
                console.log(`Binding item Jinja2 ${index}:`, row);

                const productSelect = row.querySelector('.product-select');
                const quantityInput = row.querySelector('.quantity-input');
                const priceInput = row.querySelector('[name$="-unit_price"]');
                const removeBtn = row.querySelector('.remove-item-btn');

                console.log('Product select:', productSelect);
                console.log('Quantity input:', quantityInput);
                console.log('Price input:', priceInput);

                if (productSelect && priceInput) {
                    productSelect.addEventListener('change', function () {
                        console.log('Produit chang√©:', this.value);
                        const selectedOption = this.selectedOptions[0];
                        if (selectedOption && selectedOption.textContent.includes('(') && selectedOption.textContent.includes('DA')) {
                            const priceMatch = selectedOption.textContent.match(/\((\d+(?:\.\d+)?)\s*DA/);
                            if (priceMatch) {
                                priceInput.value = priceMatch[1];
                                console.log('Prix mis √† jour:', priceMatch[1]);
                                updateOrderTotal();
                            }
                        }
                    });
                }

                if (quantityInput) {
                    quantityInput.addEventListener('input', function () {
                        console.log('Quantit√© chang√©e:', this.value);
                        updateOrderTotal();
                    });
                }

                if (priceInput) {
                    priceInput.addEventListener('input', function () {
                        console.log('Prix chang√©:', this.value);
                        updateOrderTotal();
                    });
                }

                if (removeBtn) {
                    removeBtn.addEventListener('click', function () {
                        console.log('Suppression item');
                        row.remove();
                        updateOrderTotal();
                    });
                }
            });

            // G√©rer les items JavaScript (order-item)
            const dynamicItems = document.querySelectorAll('.order-item');
            console.log('Items dynamiques (JS) trouv√©s:', dynamicItems.length);

            dynamicItems.forEach((item, index) => {
                console.log(`Binding item JS ${index}:`, item);

                const productSelect = item.querySelector('.product-select');
                const quantityInput = item.querySelector('.quantity-input');
                const priceInput = item.querySelector('.price-input');
                const removeBtn = item.querySelector('.remove-order-item-btn');

                console.log('Product select (JS):', productSelect);
                console.log('Quantity input (JS):', quantityInput);
                console.log('Price input (JS):', priceInput);

                if (productSelect && priceInput) {
                    productSelect.addEventListener('change', function () {
                        console.log('Produit JS chang√©:', this.value);
                        const selectedOption = this.selectedOptions[0];
                        if (selectedOption?.dataset?.price) {
                            priceInput.value = selectedOption.dataset.price;
                            console.log('Prix JS mis √† jour:', selectedOption.dataset.price);
                            updateOrderTotal();
                        }
                    });
                }

                if (quantityInput) {
                    quantityInput.addEventListener('input', function () {
                        console.log('Quantit√© JS chang√©e:', this.value);
                        updateOrderTotal();
                    });
                }

                if (priceInput) {
                    priceInput.addEventListener('input', function () {
                        console.log('Prix JS chang√©:', this.value);
                        updateOrderTotal();
                    });
                }

                if (removeBtn) {
                    removeBtn.addEventListener('click', function () {
                        console.log('Suppression item JS');
                        item.remove();
                        updateOrderTotal();
                    });
                }
            });
        }

        // Binding des √©v√©nements principaux
        function bindEvents() {
            // Ajouter produit simple
            document.getElementById('add-item-btn')?.addEventListener('click', addSimpleProduct);

            // Ouvrir modal produit compos√©
            document.getElementById('add-composite-btn')?.addEventListener('click', openCompositeModal);

            // Ajouter composant dans le modal
            document.getElementById('add-component-btn')?.addEventListener('click', addComponent);

            // Sauvegarder le produit compos√©
            document.getElementById('save-composite-product-btn')?.addEventListener('click', saveCompositeProduct);

            // Gestion de la soumission du formulaire
            const orderForm = document.getElementById('orderForm');
            const submitBtn = document.getElementById('submit-btn');

            console.log('üîç Formulaire trouv√©:', !!orderForm, orderForm);
            console.log('üîç Bouton submit trouv√©:', !!submitBtn, submitBtn);

            let isSubmitting = false;

            if (submitBtn) {
                submitBtn.addEventListener('click', function (e) {
                    console.log('üñ±Ô∏è CLICK SUR LE BOUTON SUBMIT');
                    console.log('Type du bouton:', this.type);
                    console.log('Form associ√©:', this.form);
                    console.log('Bouton d√©sactiv√©?', this.disabled);
                    console.log('Formulaire valide?', this.form?.checkValidity());

                    // √âviter les doubles soumissions
                    if (isSubmitting) {
                        console.log('‚ö†Ô∏è Soumission d√©j√† en cours, ignor√©');
                        e.preventDefault();
                        return false;
                    }

                    // Le bouton type="submit" devrait automatiquement soumettre le formulaire
                    // Si √ßa ne marche pas, c'est qu'il y a un probl√®me de validation HTML5
                    console.log('‚úÖ Click d√©tect√©, le formulaire devrait se soumettre automatiquement...');
                });
            }

            if (orderForm) {
                orderForm.addEventListener('submit', function (e) {
                    console.log('=== SOUMISSION FORMULAIRE ===');
                    console.log('Form ID:', this.id);
                    console.log('Form action:', this.action);
                    console.log('Form method:', this.method);

                    // Marquer qu'on est en train de soumettre
                    isSubmitting = true;

                    // Log des donn√©es du formulaire
                    const formData = new FormData(this);
                    console.log('Donn√©es du formulaire:');
                    for (let [key, value] of formData.entries()) {
                        console.log(`${key}: ${value}`);
                    }

                    // Validation c√¥t√© client
                    const clientSelect = document.getElementById('b2b_client_id');
                    const deliveryDate = document.getElementById('delivery_date');

                    console.log('Client s√©lectionn√©:', clientSelect?.value);
                    console.log('Date de livraison:', deliveryDate?.value);

                    if (!clientSelect?.value) {
                        e.preventDefault();
                        isSubmitting = false;
                        alert('Veuillez s√©lectionner un client B2B');
                        console.log('Erreur: Client non s√©lectionn√©');
                        return false;
                    }

                    if (!deliveryDate?.value) {
                        e.preventDefault();
                        isSubmitting = false;
                        alert('Veuillez saisir une date de livraison');
                        console.log('Erreur: Date de livraison manquante');
                        return false;
                    }

                    // V√©rifier les produits
                    const productItems = document.querySelectorAll('[name^="items-"][name$="-product"]');
                    console.log('Nombre de produits trouv√©s:', productItems.length);
                    let hasValidItems = false;
                    productItems.forEach((item, index) => {
                        console.log(`Produit ${index}:`, item.value);
                        if (item.value && item.value !== '') {
                            hasValidItems = true;
                        }
                    });

                    if (!hasValidItems) {
                        e.preventDefault();
                        isSubmitting = false;
                        alert('Veuillez ajouter au moins un produit √† la commande');
                        console.log('Erreur: Aucun produit valide');
                        return false;
                    }

                    console.log('‚úÖ Validation r√©ussie - Soumission autoris√©e');
                    console.log('Formulaire va √™tre soumis normalement...');
                    // Ne pas appeler e.preventDefault() ici - laisser la soumission se faire
                    return true;
                });
            } else {
                console.error('‚ùå FORMULAIRE NON TROUV√â: orderForm');
            }

            // √âv√©nements du modal
            const modalElement = document.getElementById('compositeProductModal');
            if (modalElement) {
                // Cleanup quand le modal est compl√®tement ferm√©
                modalElement.addEventListener('hidden.bs.modal', function () {
                    modalInstance = null;
                    forceCleanupModals();
                });

                // Gestion d'erreur si le modal ne se ferme pas
                modalElement.addEventListener('hide.bs.modal', function () {
                    setTimeout(() => {
                        if (document.querySelector('.modal-backdrop')) {
                            forceCleanupModals();
                        }
                    }, 500);
                });
            }

            // Bouton fermer du modal
            const closeButtons = document.querySelectorAll('[data-bs-dismiss="modal"]');
            closeButtons.forEach(btn => {
                btn.addEventListener('click', function () {
                    setTimeout(forceCleanupModals, 100);
                });
            });

            // ESC pour fermer le modal
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape' && modalInstance) {
                    safeCloseModal();
                }
            });


        }

        // Ouvrir le modal de cr√©ation de produit compos√©
        function openCompositeModal() {
            try {
                // Nettoyage pr√©ventif
                forceCleanupModals();

                // Reset du formulaire
                const form = document.getElementById('composite-product-form');
                if (form) form.reset();

                const container = document.getElementById('components-container');
                if (container) container.innerHTML = '';

                componentsCounter = 0;

                // Ajouter un composant par d√©faut
                addComponent();

                // Cr√©er l'instance du modal
                const modalElement = document.getElementById('compositeProductModal');
                if (modalElement) {
                    modalInstance = new bootstrap.Modal(modalElement, {
                        backdrop: 'static', // Emp√™che la fermeture accidentelle
                        keyboard: true,
                        focus: true
                    });

                    modalInstance.show();
                }
            } catch (error) {
                console.error('Erreur ouverture modal:', error);
                forceCleanupModals();
            }
        }

        // Ajouter un composant dans le modal
        function addComponent() {
            const container = document.getElementById('components-container');
            if (!container) return;

            const componentDiv = createComponentHTML(componentsCounter);
            container.appendChild(componentDiv);
            componentsCounter++;
        }

        // Cr√©er le HTML pour un composant
        function createComponentHTML(index) {
            const div = document.createElement('div');
            div.className = 'component-row mb-3';
            div.dataset.index = index;

            const productsOptions = availableProducts.map(product =>
                `<option value="${product.id}" data-price="${product.price}">${product.name}</option>`
            ).join('');

            div.innerHTML = `
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label" for="component-product-${index}">Produit fini</label>
                    <select class="form-select component-product" id="component-product-${index}" name="component-product-${index}">
                        <option value="">S√©lectionner un produit</option>
                        ${productsOptions}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label" for="component-quantity-${index}">Quantit√©</label>
                    <input type="number" class="form-control component-quantity" id="component-quantity-${index}" name="component-quantity-${index}" value="1" min="1">
                </div>
                <div class="col-md-3">
                    <label class="form-label" for="component-price-${index}">Prix unitaire (DZD)</label>
                    <input type="number" class="form-control component-price" id="component-price-${index}" name="component-price-${index}" step="0.01" readonly>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-danger btn-sm remove-component-btn" aria-label="Supprimer ce composant">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;

            bindComponentEvents(div);
            return div;
        }

        // Binding des √©v√©nements pour un composant
        function bindComponentEvents(componentDiv) {
            const productSelect = componentDiv.querySelector('.component-product');
            const priceInput = componentDiv.querySelector('.component-price');
            const removeBtn = componentDiv.querySelector('.remove-component-btn');

            if (productSelect && priceInput) {
                productSelect.addEventListener('change', function () {
                    const selectedOption = this.selectedOptions[0];
                    if (selectedOption?.dataset?.price) {
                        priceInput.value = selectedOption.dataset.price;
                    }
                });
            }

            if (removeBtn) {
                removeBtn.addEventListener('click', function () {
                    componentDiv.remove();
                });
            }
        }

        // Sauvegarder le produit compos√© et l'ajouter √† la commande
        function saveCompositeProduct() {
            try {
                const compositeName = document.getElementById('composite-name')?.value?.trim();
                const compositeQuantity = parseInt(document.getElementById('composite-quantity')?.value) || 1;
                const compositePrice = parseFloat(document.getElementById('composite-unit-price')?.value) || 0;

                // Validations
                if (!compositeName) {
                    alert('Veuillez saisir le nom du produit compos√©');
                    return;
                }

                if (compositePrice <= 0) {
                    alert('Veuillez saisir un prix unitaire valide');
                    return;
                }

                // R√©cup√©rer tous les composants
                const components = [];
                const componentRows = document.querySelectorAll('.component-row');
                componentRows.forEach(row => {
                    const productSelect = row.querySelector('.component-product');
                    const quantity = parseInt(row.querySelector('.component-quantity')?.value) || 0;
                    const price = parseFloat(row.querySelector('.component-price')?.value) || 0;

                    if (productSelect?.value && quantity > 0) {
                        components.push({
                            productId: productSelect.value,
                            productName: productSelect.selectedOptions[0]?.text || '',
                            quantity: quantity,
                            unitPrice: price
                        });
                    }
                });

                if (components.length === 0) {
                    alert('Veuillez ajouter au moins un produit fini √† la composition');
                    return;
                }

                // Cr√©er l'affichage du produit compos√© dans la commande
                const container = document.getElementById('order-items-container');
                if (container) {
                    const compositeItem = createCompositeOrderItemHTML(
                        orderItemsCounter,
                        compositeName,
                        compositeQuantity,
                        compositePrice,
                        components
                    );

                    container.appendChild(compositeItem);
                    // Incr√©menter le compteur pour tenir compte des composants suppl√©mentaires
                    orderItemsCounter += components.length;
                }

                // Fermeture s√©curis√©e du modal
                safeCloseModal();

                // Mettre √† jour le total
                updateOrderTotal();

                // Message de succ√®s
                showSuccessMessage(`Produit compos√© "${compositeName}" ajout√© √† la commande !`);

            } catch (error) {
                console.error('Erreur sauvegarde produit compos√©:', error);
                safeCloseModal();
            }
        }

        // Ajouter un produit simple √† la commande
        function addSimpleProduct() {
            const container = document.getElementById('order-items-container');
            if (container) {
                const itemDiv = createOrderItemHTML('simple', orderItemsCounter, '', 1, 0, '');
                container.appendChild(itemDiv);
                orderItemsCounter++;
                updateOrderTotal();
            }
        }

        // Cr√©er le HTML pour un produit compos√© dans la commande
        function createCompositeOrderItemHTML(index, name, quantity, unitPrice, components) {
            const div = document.createElement('div');
            div.className = 'order-item mb-4';
            div.dataset.index = index;
            div.dataset.type = 'composite';

            const compositionDetails = components.map(comp =>
                `${comp.quantity} √ó ${comp.productName}`
            ).join('');

            const totalPrice = quantity * unitPrice;

            div.innerHTML = `
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <strong><i class="bi bi-layers me-2"></i>${name}</strong>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label text-white mb-1" for="composite-quantity-${index}">Quantit√©</label>
                            <input type="number" name="items-${index}-quantity" id="composite-quantity-${index}"
                                   class="form-control form-control-sm" value="${quantity}" min="1" step="1">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label text-white mb-1" for="composite-price-${index}">Prix unitaire (DZD)</label>
                            <input type="number" name="items-${index}-unit_price" id="composite-price-${index}"
                                   class="form-control form-control-sm" value="${unitPrice}" step="0.01">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label text-white mb-1" for="composite-total-${index}">Total</label>
                            <input type="text" class="form-control form-control-sm text-white bg-transparent border-0" 
                                   id="composite-total-${index}" value="${totalPrice.toLocaleString()} DZD" readonly>
                        </div>
                        <div class="col-md-1 text-end">
                            <button type="button" class="btn btn-outline-light btn-sm remove-order-item-btn" aria-label="Supprimer ce produit">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <strong>Composition:</strong><br>
                            ${compositionDetails}
                        </div>
                        <div class="col-md-4">
                            <label class="form-label" for="composite-description-${index}">Description</label>
                            <input type="text" name="items-${index}-description" id="composite-description-${index}"
                                   class="form-control" value="${name}">
                        </div>
                    </div>
                </div>
            </div>
        `;

            // Champ cach√© pour indiquer que c'est un produit compos√©
            const productHidden = document.createElement('input');
            productHidden.type = 'hidden';
            productHidden.name = `items-${index}-product`;
            productHidden.id = `composite-product-${index}`;
            productHidden.value = 'composite';
            div.appendChild(productHidden);

            // ‚úÖ IMPORTANT : S√©rialiser la composition en JSON dans un seul champ cach√©
            // Le backend s'attend √† recevoir une string JSON dans le champ 'composition'
            const compositionHidden = document.createElement('input');
            compositionHidden.type = 'hidden';
            compositionHidden.name = `items-${index}-composition`;
            compositionHidden.id = `composite-data-${index}`;

            // Nettoyer les donn√©es avant s√©rialisation (garder que id, name, qty)
            const cleanComponents = components.map(c => ({
                product_id: c.productId,
                name: c.productName,
                quantity: c.quantity,
                unit_price: c.unitPrice // Optionnel, pour info
            }));

            compositionHidden.value = JSON.stringify(cleanComponents);
            div.appendChild(compositionHidden);

            // Binding √©v√©nement suppression
            const removeBtn = div.querySelector('.remove-order-item-btn');
            if (removeBtn) {
                removeBtn.addEventListener('click', function () {
                    div.remove();
                    updateOrderTotal();
                });
            }

            // Binding √©v√©nements pour les champs d'√©dition
            const quantityInput = div.querySelector('input[name*="quantity"]');
            const priceInput = div.querySelector('input[name*="unit_price"]');

            if (quantityInput) {
                quantityInput.addEventListener('input', function () {
                    updateOrderTotal();
                    // Mettre √† jour l'affichage du total
                    const totalInput = div.querySelector('input[id*="composite-total"]');
                    if (totalInput) {
                        const newQuantity = parseFloat(this.value) || 0;
                        const newPrice = parseFloat(priceInput.value) || 0;
                        const newTotal = newQuantity * newPrice;
                        totalInput.value = newTotal.toLocaleString() + ' DZD';
                    }
                });
            }

            if (priceInput) {
                priceInput.addEventListener('input', function () {
                    updateOrderTotal();
                    // Mettre √† jour l'affichage du total
                    const totalInput = div.querySelector('input[id*="composite-total"]');
                    if (totalInput) {
                        const newQuantity = parseFloat(quantityInput.value) || 0;
                        const newPrice = parseFloat(this.value) || 0;
                        const newTotal = newQuantity * newPrice;
                        totalInput.value = newTotal.toLocaleString() + ' DZD';
                    }
                });
            }

            return div;
        }

        // Cr√©er le HTML pour un produit simple
        function createOrderItemHTML(type, index, name, quantity, price, description = '') {
            const div = document.createElement('div');
            div.className = 'order-item mb-3';
            div.dataset.index = index;
            div.dataset.type = type;

            const productsOptions = availableProducts.map(product =>
                `<option value="${product.id}" data-price="${product.price}">${product.name}</option>`
            ).join('');

            div.innerHTML = `
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label" for="items-${index}-product">Produit</label>
                    <select name="items-${index}-product" id="items-${index}-product" class="form-select product-select">
                        <option value="">S√©lectionner un produit</option>
                        ${productsOptions}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label" for="items-${index}-quantity">Quantit√©</label>
                    <input type="number" name="items-${index}-quantity" id="items-${index}-quantity"
                           class="form-control quantity-input" value="${quantity}" step="0.001">
                </div>
                <div class="col-md-2">
                    <label class="form-label" for="items-${index}-unit_price">Prix unitaire</label>
                    <input type="number" name="items-${index}-unit_price" id="items-${index}-unit_price"
                           class="form-control price-input" value="${price}" step="0.01">
                </div>
                <div class="col-md-3">
                    <label class="form-label" for="items-${index}-description">Description</label>
                    <input type="text" name="items-${index}-description" id="items-${index}-description"
                           class="form-control" value="${description}">
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="button" class="btn btn-outline-danger btn-sm remove-order-item-btn" aria-label="Supprimer ce produit">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        `;

            // Binding des √©v√©nements
            bindSimpleItemEvents(div);
            return div;
        }

        // Binding des √©v√©nements pour un produit simple
        function bindSimpleItemEvents(itemDiv) {
            const productSelect = itemDiv.querySelector('.product-select');
            const priceInput = itemDiv.querySelector('.price-input');
            const quantityInput = itemDiv.querySelector('.quantity-input');
            const removeBtn = itemDiv.querySelector('.remove-order-item-btn');

            if (productSelect && priceInput) {
                productSelect.addEventListener('change', function () {
                    const selectedOption = this.selectedOptions[0];
                    if (selectedOption?.dataset?.price) {
                        priceInput.value = selectedOption.dataset.price;
                        updateOrderTotal();
                    }
                });
            }

            if (quantityInput) {
                quantityInput.addEventListener('input', updateOrderTotal);
            }

            if (priceInput) {
                priceInput.addEventListener('input', updateOrderTotal);
            }

            if (removeBtn) {
                removeBtn.addEventListener('click', function () {
                    itemDiv.remove();
                    updateOrderTotal();
                });
            }
        }

        // Mettre √† jour le total de la commande
        function updateOrderTotal() {
            let total = 0;
            console.log('=== MISE √Ä JOUR DU TOTAL ===');

            // G√©rer les items existants (premier item par d√©faut - Jinja2)
            const existingItems = document.querySelectorAll('.order-item-row');
            console.log('Items existants (Jinja2):', existingItems.length);

            existingItems.forEach((item, index) => {
                // ‚úÖ CORRECTION : Ignorer les composants (items avec data-is-component)
                if (item.dataset.isComponent === 'true') {
                    console.log(`Item existant ${index}: IGNOR√â (composant)`);
                    return;
                }

                const quantityInput = item.querySelector('.quantity-input');
                const priceInput = item.querySelector('[name$="-unit_price"]');
                const quantity = parseFloat(quantityInput?.value) || 0;
                const unitPrice = parseFloat(priceInput?.value) || 0;
                const subtotal = quantity * unitPrice;

                console.log(`Item existant ${index}:`, {
                    quantity: quantity,
                    unitPrice: unitPrice,
                    subtotal: subtotal
                });

                total += subtotal;
            });

            // G√©rer les items ajout√©s dynamiquement (JavaScript)
            const dynamicItems = document.querySelectorAll('.order-item');
            console.log('Items dynamiques (JS):', dynamicItems.length);

            dynamicItems.forEach((item, index) => {
                if (item.dataset.type === 'composite') {
                    const quantityInput = item.querySelector('input[name*="quantity"]');
                    const unitPriceInput = item.querySelector('input[name*="unit_price"]');
                    const quantity = parseFloat(quantityInput?.value) || 0;
                    const unitPrice = parseFloat(unitPriceInput?.value) || 0;
                    const subtotal = quantity * unitPrice;

                    console.log(`Item compos√© ${index}:`, {
                        quantity: quantity,
                        unitPrice: unitPrice,
                        subtotal: subtotal
                    });

                    total += subtotal;
                } else {
                    const quantityInput = item.querySelector('.quantity-input');
                    const priceInput = item.querySelector('.price-input');
                    const quantity = parseFloat(quantityInput?.value) || 0;
                    const unitPrice = parseFloat(priceInput?.value) || 0;
                    const subtotal = quantity * unitPrice;

                    console.log(`Item simple ${index}:`, {
                        quantity: quantity,
                        unitPrice: unitPrice,
                        subtotal: subtotal
                    });

                    total += subtotal;
                }
            });

            console.log('Total final:', total);

            const totalElement = document.getElementById('order-total');
            if (totalElement) {
                totalElement.textContent = total.toLocaleString('fr-FR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }

            // Mettre √† jour aussi l'affichage du total en haut
            const orderTotalElement = document.getElementById('orderTotal');
            if (orderTotalElement) {
                orderTotalElement.textContent = total.toLocaleString('fr-FR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }
        }

        // Afficher message de succ√®s
        function showSuccessMessage(message) {
            const toast = document.createElement('div');
            toast.className = 'toast align-items-center text-white bg-success border-0 position-fixed';
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
            toast.setAttribute('role', 'alert');

            toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-check-circle me-2"></i>${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;

            document.body.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();

            toast.addEventListener('hidden.bs.toast', () => toast.remove());
        }

        // Initialisation
        init();

        // Fonction d'urgence globale pour nettoyer les modals bloqu√©s
        window.emergencyCleanupModal = function () {
            console.log('üö® Nettoyage d\'urgence des modals');
            forceCleanupModals();
            modalInstance = null;
        };
    });

    // Code de diagnostic supprim√© - causait des doublons d'√©v√©nements
    // Le premier DOMContentLoaded (ligne ~335) g√®re d√©j√† la soumission
</script>
{% endblock %}