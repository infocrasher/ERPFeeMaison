{% extends "base.html" %}

{% block title %}Nouvelle facture depuis commande B2B - Fée Maison{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>Créer une facture depuis la commande {{ order.order_number }}</h3>
        <a href="{{ url_for('b2b.view_order', order_id=order.id) }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Retour à la commande
        </a>
    </div>

    <!-- Informations de la commande -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Informations de la commande</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Client :</strong> {{ order.b2b_client.company_name if order.b2b_client else "—" }}</p>
                    <p><strong>Date commande :</strong> {{ order.order_date.strftime('%d/%m/%Y') if order.order_date else "—" }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Statut commande :</strong> 
                        <span class="badge bg-{{ 
                            'success' if order.status == 'completed' 
                            else 'warning' if order.status in ['in_production', 'ready_at_shop'] 
                            else 'info' if order.status == 'delivered'
                            else 'danger' if order.status == 'cancelled'
                            else 'secondary' 
                        }}">
                            {{ order.get_status_display() }}
                        </span>
                    </p>
                    <p><strong>Montant commande :</strong> {{ "{:,.0f}".format(order.total_amount) }} DA</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulaire de création de facture -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">Créer la facture</h5>
        </div>
        <div class="card-body">
            <form method="post">
                {{ form.csrf_token }}

                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <label class="form-label">{{ form.invoice_type.label }}</label>
                        {{ form.invoice_type(class="form-select" + (" is-invalid" if form.invoice_type.errors else "")) }}
                        {% if form.invoice_type.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.invoice_type.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">{{ form.invoice_date.label }}</label>
                        {{ form.invoice_date(class="form-control" + (" is-invalid" if form.invoice_date.errors else ""), type="date") }}
                        {% if form.invoice_date.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.invoice_date.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">{{ form.due_date.label }}</label>
                        {{ form.due_date(class="form-control" + (" is-invalid" if form.due_date.errors else ""), type="date") }}
                        {% if form.due_date.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.due_date.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="col-12">
                        <label class="form-label">{{ form.notes.label }}</label>
                        {{ form.notes(class="form-control" + (" is-invalid" if form.notes.errors else ""), rows="2", placeholder="Notes facture...") }}
                        {% if form.notes.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.notes.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Articles à facturer -->
                <div class="mb-4">
                    <h6>Articles à facturer</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th style="width:45%">Description</th>
                                    <th style="width:12%">Qté</th>
                                    <th style="width:18%">Prix unitaire (DA)</th>
                                    <th style="width:18%">Total (DA)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for it in items %}
                                {% set i = loop.index0 %}
                                <tr>
                                    <td>
                                        <textarea name="items-{{ i }}-description" class="form-control" rows="3" style="font-size: 0.9em;">{{ it.description }}</textarea>
                                        <input type="hidden" name="items-{{ i }}-product_id" value="{{ it.product_id or '' }}">
                                    </td>
                                    <td>
                                        <input type="number" step="0.001" min="0" name="items-{{ i }}-quantity"
                                               value="{{ ('%.3f' % it.quantity).rstrip('0').rstrip('.') if it.quantity is not none else '0' }}"
                                               class="form-control text-end quantity-input"
                                               data-index="{{ i }}">
                                    </td>
                                    <td>
                                        <input type="number" step="0.01" min="0" name="items-{{ i }}-unit_price"
                                               value="{{ ('%.2f' % it.unit_price) if it.unit_price is not none else '0.00' }}"
                                               class="form-control text-end price-input"
                                               data-index="{{ i }}">
                                    </td>
                                    <td class="text-end">
                                        <span class="total-display" data-index="{{ i }}">
                                            {% set line_total = (it.quantity or 0) * (it.unit_price or 0) %}
                                            {{ '%.2f' % line_total }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="table-info">
                                    <td colspan="3" class="text-end"><strong>Total facture :</strong></td>
                                    <td class="text-end"><strong><span id="grand-total">0.00</span> DA</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Boutons -->
                <div class="d-flex gap-2">
                    {{ form.submit(class="btn btn-success") }}
                    <a href="{{ url_for('b2b.view_order', order_id=order.id) }}" class="btn btn-outline-secondary">Annuler</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// JavaScript simple pour calcul des totaux en temps réel (optionnel)
document.addEventListener('DOMContentLoaded', function() {
    function calculateTotal(index) {
        const qtyInput = document.querySelector(`input[name="items-${index}-quantity"]`);
        const priceInput = document.querySelector(`input[name="items-${index}-unit_price"]`);
        const totalDisplay = document.querySelector(`span[data-index="${index}"]`);
        
        if (qtyInput && priceInput && totalDisplay) {
            const qty = parseFloat(qtyInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const total = qty * price;
            totalDisplay.textContent = total.toFixed(2);
        }
    }
    
    function calculateGrandTotal() {
        let grandTotal = 0;
        document.querySelectorAll('.total-display').forEach(function(span) {
            grandTotal += parseFloat(span.textContent) || 0;
        });
        document.getElementById('grand-total').textContent = grandTotal.toFixed(2);
    }
    
    // Écouter les changements sur les inputs
    document.querySelectorAll('.quantity-input, .price-input').forEach(function(input) {
        input.addEventListener('input', function() {
            const index = this.dataset.index;
            calculateTotal(index);
            calculateGrandTotal();
        });
    });
    
    // Calcul initial
    document.querySelectorAll('.quantity-input').forEach(function(input) {
        const index = input.dataset.index;
        calculateTotal(index);
    });
    calculateGrandTotal();
});
</script>
{% endblock %}
