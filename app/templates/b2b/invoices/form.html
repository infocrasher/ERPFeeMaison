{% extends "base.html" %}

{% block title %}{{ title }} - Fée Maison{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title mb-0">
                        <i class="bi bi-receipt me-2"></i>{{ title }}
                    </h3>
                </div>
                <div class="card-body">
                    <form method="POST" novalidate id="invoiceForm">
                        {{ form.hidden_tag() }}
                        
                        <!-- Informations de base -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.b2b_client_id.label(class="form-label") }}
                                    {{ form.b2b_client_id(class="form-select" + (" is-invalid" if form.b2b_client_id.errors else "")) }}
                                    {% if form.b2b_client_id.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.b2b_client_id.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.invoice_type.label(class="form-label") }}
                                    {{ form.invoice_type(class="form-select" + (" is-invalid" if form.invoice_type.errors else "")) }}
                                    {% if form.invoice_type.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.invoice_type.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.invoice_date.label(class="form-label") }}
                                    {{ form.invoice_date(class="form-control" + (" is-invalid" if form.invoice_date.errors else ""), type="date") }}
                                    {% if form.invoice_date.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.invoice_date.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.due_date.label(class="form-label") }}
                                    {{ form.due_date(class="form-control" + (" is-invalid" if form.due_date.errors else ""), type="date") }}
                                    {% if form.due_date.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.due_date.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.payment_method.label(class="form-label") }}
                                    {{ form.payment_method(class="form-select" + (" is-invalid" if form.payment_method.errors else "")) }}
                                    {% if form.payment_method.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.payment_method.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Conditions de paiement</label>
                                    <div class="form-control-plaintext">
                                        <span id="paymentTerms">30 jours</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Articles de la facture -->
                        <div class="mb-4">
                            <h5>Articles de la facture</h5>
                            <div id="invoiceItems">
                                {% for item_form in form.invoice_items %}
                                <div class="invoice-item border rounded p-3 mb-3">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Description</label>
                                                <input type="text" name="{{ item_form.description.name }}" 
                                                       class="form-control" 
                                                       value="{{ item_form.description.data or '' }}"
                                                       placeholder="Description du produit/service"
                                                       required>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="mb-3">
                                                <label class="form-label">Quantité</label>
                                                {{ item_form.quantity(class="form-control quantity-input" + (" is-invalid" if item_form.quantity.errors else ""), step="0.001") }}
                                                {% if item_form.quantity.errors %}
                                                    <div class="invalid-feedback">
                                                        {% for error in item_form.quantity.errors %}
                                                            {{ error }}
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="mb-3">
                                                <label class="form-label">Prix unitaire (DA)</label>
                                                {{ item_form.unit_price(class="form-control price-input" + (" is-invalid" if item_form.unit_price.errors else ""), step="0.01") }}
                                                {% if item_form.unit_price.errors %}
                                                    <div class="invalid-feedback">
                                                        {% for error in item_form.unit_price.errors %}
                                                            {{ error }}
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="mb-3">
                                                <label class="form-label">Total</label>
                                                <div class="form-control-plaintext">
                                                    <span class="item-total">0.00</span> DA
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="mb-3">
                                                <label class="form-label">&nbsp;</label>
                                                <button type="button" class="btn btn-danger btn-sm remove-item" style="display: {{ 'none' if loop.first else 'block' }}">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="btn btn-outline-primary" id="addItem">
                                <i class="bi bi-plus-circle me-2"></i>Ajouter un article
                            </button>
                        </div>

                        <!-- Notes -->
                        <div class="mb-4">
                            {{ form.notes.label(class="form-label") }}
                            {{ form.notes(class="form-control" + (" is-invalid" if form.notes.errors else ""), rows=3) }}
                            {% if form.notes.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.notes.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Totaux -->
                        <div class="alert alert-info">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Sous-total: <span id="subtotal">0.00</span> DA</strong>
                                </div>
                                <div class="col-md-6">
                                    <strong>Total: <span id="invoiceTotal">0.00</span> DA</strong>
                                </div>
                            </div>
                        </div>

                        <!-- Boutons -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('b2b.list_invoices') }}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left me-2"></i>Annuler
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-2"></i>{{ form.submit.label.text }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== DEBUT DEBUG FACTURE ===');
    console.log('DOM chargé, recherche des éléments...');

    const clientSelect = document.querySelector('select[name="b2b_client_id"]');
    const paymentTerms = document.getElementById('paymentTerms');
    const addItemBtn = document.getElementById('addItem');
    const invoiceItems = document.getElementById('invoiceItems');
    const subtotalSpan = document.getElementById('subtotal');
    const totalSpan = document.getElementById('invoiceTotal');

    console.log('Elements trouvés:', {
        clientSelect: !!clientSelect,
        paymentTerms: !!paymentTerms,
        addItemBtn: !!addItemBtn,
        invoiceItems: !!invoiceItems,
        subtotalSpan: !!subtotalSpan,
        totalSpan: !!totalSpan
    });

    // Vérifier que les éléments essentiels existent
    if (!addItemBtn) {
        console.error('ERREUR: Bouton addItem non trouvé!');
        return;
    }
    if (!invoiceItems) {
        console.error('ERREUR: Container invoiceItems non trouvé!');
        return;
    }

    // Définir les fonctions utilitaires d'abord
    function updateItemTotal(item) {
        const quantity = parseFloat(item.querySelector('.quantity-input').value) || 0;
        const price = parseFloat(item.querySelector('.price-input').value) || 0;
        const total = quantity * price;
        item.querySelector('.item-total').textContent = total.toFixed(2);
        return total;
    }

    function updateTotals() {
        let subtotal = 0;
        document.querySelectorAll('.invoice-item').forEach(item => {
            subtotal += updateItemTotal(item);
        });
        
        if (subtotalSpan) subtotalSpan.textContent = subtotal.toFixed(2);
        if (totalSpan) totalSpan.textContent = subtotal.toFixed(2);
    }

    // Données pré-chargées depuis une commande si disponibles
    {% if order_items_for_form %}
    try {
        console.log('=== DONNEES PRE-CHARGEES DETECTEES ===');
        const orderItemsData = {{ order_items_for_form | tojson }};
        console.log('Données de commande à pré-charger:', orderItemsData);
        
        // Pré-remplir les champs avec les données de la commande
        if (orderItemsData && orderItemsData.length > 0) {
            console.log('Début du pré-remplissage...');
            
            // D'abord, s'assurer qu'on a assez d'articles dans le formulaire
            console.log('Articles actuels:', invoiceItems.children.length);
            console.log('Articles nécessaires:', orderItemsData.length);
            
            while (invoiceItems.children.length < orderItemsData.length) {
                console.log('Ajout d\'un article...');
                addItemBtn.click();
            }
            
            // Remplir les champs
            orderItemsData.forEach((itemData, index) => {
                console.log(`Remplissage article ${index}:`, itemData);
                const itemDiv = invoiceItems.children[index];
                if (itemDiv) {
                    const descInput = itemDiv.querySelector('input[name*="description"]');
                    const quantityInput = itemDiv.querySelector('input[name*="quantity"]');
                    const priceInput = itemDiv.querySelector('input[name*="unit_price"]');
                    
                    console.log('Champs trouvés:', {
                        description: !!descInput,
                        quantity: !!quantityInput,
                        price: !!priceInput
                    });
                    
                    if (descInput) descInput.value = itemData.description || '';
                    if (quantityInput) quantityInput.value = itemData.quantity || '';
                    if (priceInput) priceInput.value = itemData.unit_price || '';
                }
            });
            
            console.log('Mise à jour des totaux...');
            // Mettre à jour les totaux
            updateTotals();
            console.log('Pré-remplissage terminé avec succès!');
        }
    } catch (error) {
        console.error('Erreur lors du pré-remplissage:', error);
    }
    {% else %}
    console.log('=== AUCUNE DONNEE PRE-CHARGEE ===');
    {% endif %}
    console.log('=== FIN DEBUG FACTURE ===');

    // Mettre à jour les conditions de paiement selon le client
    if (clientSelect && paymentTerms) {
        clientSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.dataset.paymentTerms) {
                paymentTerms.textContent = selectedOption.dataset.paymentTerms + ' jours';
            } else {
                paymentTerms.textContent = '30 jours';
            }
        });
    }

    // Ajouter un article
    addItemBtn.addEventListener('click', function() {
        const itemTemplate = invoiceItems.children[0].cloneNode(true);
        
        // Réinitialiser les valeurs
        itemTemplate.querySelectorAll('input').forEach(input => {
            input.value = '';
        });
        
        // Afficher le bouton supprimer
        itemTemplate.querySelector('.remove-item').style.display = 'block';
        
        // Mettre à jour les noms des champs
        const itemCount = invoiceItems.children.length;
        itemTemplate.querySelectorAll('input').forEach(input => {
            const name = input.name;
            if (name) {
                input.name = name.replace(/\[\d+\]/, `[${itemCount}]`);
                input.id = input.id.replace(/_\d+_/, `_${itemCount}_`);
            }
        });
        
        invoiceItems.appendChild(itemTemplate);
        updateTotals();
    });

    // Supprimer un article
    invoiceItems.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-item') || e.target.closest('.remove-item')) {
            const item = e.target.closest('.invoice-item');
            if (invoiceItems.children.length > 1) {
                item.remove();
                updateTotals();
            }
        }
    });

    // Fonctions déjà définies plus haut

    // Écouter les changements de quantité et prix
    invoiceItems.addEventListener('input', function(e) {
        if (e.target.classList.contains('quantity-input') || e.target.classList.contains('price-input')) {
            updateTotals();
        }
    });

    // Initialiser les totaux
    updateTotals();
});
</script>
{% endblock %} 