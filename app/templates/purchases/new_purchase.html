{% extends "base.html" %}

{% block title %}{{ title }} - F√©e Maison{% endblock %}

{% block head %}
<style>
    .product-row {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        border-left: 4px solid #667eea;
    }
    .stock-selector {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 6px;
        color: white;
        padding: 5px 10px;
        font-size: 0.85em;
    }
    .calculation-display {
        background: #e3f2fd;
        border-radius: 6px;
        padding: 8px;
        font-size: 0.9em;
        margin-top: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- En-t√™te -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3">üìù Nouveau Bon d'Achat</h1>
            <p class="text-muted">Cr√©ation d'un bon d'achat avec mise √† jour automatique du stock</p>
        </div>
    </div>

    <form method="POST" id="purchaseForm">
        {{ form.hidden_tag() }}
        
        <!-- Informations Fournisseur -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">üè¢ Informations Fournisseur</div>
                    <div class="card-body">
                        <div class="mb-3">
                            {{ form.supplier_name.label(class="form-label") }}
                            {{ form.supplier_name(class="form-control") }}
                        </div>
                        <div class="mb-3">
                            {{ form.supplier_contact.label(class="form-label") }}
                            {{ form.supplier_contact(class="form-control") }}
                        </div>
                        <div class="mb-3">
                            {{ form.supplier_phone.label(class="form-label") }}
                            {{ form.supplier_phone(class="form-control") }}
                        </div>
                        <div class="mb-3">
                            {{ form.supplier_email.label(class="form-label") }}
                            {{ form.supplier_email(class="form-control") }}
                        </div>
                        <div class="mb-3">
                            {{ form.supplier_address.label(class="form-label") }}
                            {{ form.supplier_address(class="form-control", rows="3") }}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">‚öôÔ∏è Param√®tres</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">üìÖ Date d'achat</label>
                            <input type="text" class="form-control" value="Aujourd'hui - {{ moment().format('DD/MM/YYYY √† HH:mm') }}" readonly>
                            <small class="text-muted">Date automatique lors de la cr√©ation</small>
                        </div>
                        <div class="mb-3">
                            {{ form.urgency.label(class="form-label") }}
                            {{ form.urgency(class="form-select") }}
                        </div>
                        <div class="mb-3">
                            <label class="form-label">üì¶ Stock par d√©faut</label>
                            {{ form.default_stock_location(class="form-select", id="defaultStockLocation") }}
                            <small class="text-muted">Peut √™tre modifi√© pour chaque produit</small>
                        </div>
                        <div class="mb-3">
                            {{ form.payment_terms.label(class="form-label") }}
                            {{ form.payment_terms(class="form-control") }}
                        </div>
                        <div class="mb-3">
                            {{ form.notes.label(class="form-label") }}
                            {{ form.notes(class="form-control", rows="3") }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section Articles -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">üõí Articles Achet√©s</h5>
                <button type="button" class="btn btn-success btn-sm" id="addItemBtn">
                    <i class="bi bi-plus-circle"></i> Ajouter Article
                </button>
            </div>
            <div class="card-body">
                <div id="itemsContainer">
                    <!-- Les lignes d'articles seront ajout√©es ici dynamiquement -->
                </div>
                
                <!-- Total -->
                <div class="row mt-3">
                    <div class="col-md-8"></div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <strong>Total G√©n√©ral :</strong>
                                    <strong id="grandTotal">0.00 DA</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Boutons d'action -->
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between">
                    <a href="{{ url_for('purchases.list_purchases') }}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Retour Liste
                    </a>
                    <div>
                        {{ form.submit(class="btn btn-primary btn-lg") }}
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Template pour ligne d'article -->
<template id="itemRowTemplate">
    <div class="product-row" data-item-index="">
        <div class="row align-items-end">
            <div class="col-md-3">
                <label class="form-label">Produit</label>
                <select class="form-select product-select" name="items[][product_id]" required>
                    <option value="">Choisir un produit...</option>
                    {% for product in available_products %}
                    <option value="{{ product.id }}" 
                            data-name="{{ product.name }}" 
                            data-unit="{{ product.unit }}"
                            data-cost="{{ product.cost_price or 0 }}">
                        {{ product.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Conditionnement</label>
                <select class="form-select unit-select" name="items[][unit]">
                    <option value="">Unit√© de base</option>
                    {% for unit in available_units %}
                    <option value="{{ unit.id }}" 
                            data-name="{{ unit.name }}"
                            data-factor="{{ unit.conversion_factor }}"
                            data-base="{{ unit.base_unit }}">
                        {{ unit.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-1">
                <label class="form-label">Quantit√©</label>
                <input type="number" class="form-control quantity-input" 
                       name="items[][quantity_ordered]" 
                       step="0.001" min="0" required>
            </div>
            <div class="col-md-2">
                <label class="form-label">Prix unitaire (DA)</label>
                <input type="number" class="form-control price-input" 
                       name="items[][unit_price]" 
                       step="0.01" min="0" required>
            </div>
            <div class="col-md-2">
                <label class="form-label">üì¶ Stock Destination</label>
                <select class="form-select stock-selector stock-location-select" name="items[][stock_location]" required>
                    <option value="ingredients_magasin">üè™ Stock Magasin</option>
                    <option value="ingredients_local">üè≠ Stock Local</option>
                    <option value="comptoir">üõí Stock Comptoir</option>
                    <option value="consommables">üì¶ Stock Consommables</option>
                </select>
            </div>
            <div class="col-md-1">
                <label class="form-label">Total</label>
                <input type="text" class="form-control line-total" readonly>
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-danger btn-sm remove-item-btn">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
        <div class="calculation-display mt-2" style="display: none;">
            <small class="conversion-info"></small>
        </div>
    </div>
</template>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let itemIndex = 0;
    const itemsContainer = document.getElementById('itemsContainer');
    const addItemBtn = document.getElementById('addItemBtn');
    const defaultStockLocation = document.getElementById('defaultStockLocation');
    
    // Ajouter automatiquement une premi√®re ligne
    addItemRow();
    
    addItemBtn.addEventListener('click', addItemRow);
    
    function addItemRow() {
        const template = document.getElementById('itemRowTemplate');
        const clone = template.content.cloneNode(true);
        
        // Mettre √† jour l'index
        const row = clone.querySelector('.product-row');
        row.setAttribute('data-item-index', itemIndex);
        
        // D√©finir le stock par d√©faut
        const stockSelect = clone.querySelector('.stock-location-select');
        stockSelect.value = defaultStockLocation.value;
        
        // Ajouter les event listeners
        setupRowEventListeners(clone);
        
        itemsContainer.appendChild(clone);
        itemIndex++;
    }
    
    function setupRowEventListeners(row) {
        const productSelect = row.querySelector('.product-select');
        const unitSelect = row.querySelector('.unit-select');
        const quantityInput = row.querySelector('.quantity-input');
        const priceInput = row.querySelector('.price-input');
        const lineTotalInput = row.querySelector('.line-total');
        const removeBtn = row.querySelector('.remove-item-btn');
        const conversionInfo = row.querySelector('.conversion-info');
        const calculationDisplay = row.querySelector('.calculation-display');
        
        // Calcul automatique du total de ligne
        function updateLineTotal() {
            const quantity = parseFloat(quantityInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            const total = quantity * price;
            
            lineTotalInput.value = total.toFixed(2) + ' DA';
            updateGrandTotal();
            
            // Affichage des conversions d'unit√©s
            const selectedUnit = unitSelect.options[unitSelect.selectedIndex];
            if (selectedUnit && selectedUnit.value && quantity > 0) {
                const unitName = selectedUnit.dataset.name;
                const factor = parseFloat(selectedUnit.dataset.factor);
                const baseUnit = selectedUnit.dataset.base;
                const baseQuantity = quantity * factor;
                
                conversionInfo.innerHTML = `
                    <strong>Conversion :</strong> ${quantity} √ó ${unitName} = ${baseQuantity.toFixed(3)}${baseUnit}<br>
                    <strong>Total :</strong> ${total.toFixed(2)} DA
                `;
                calculationDisplay.style.display = 'block';
            } else {
                calculationDisplay.style.display = 'none';
            }
        }
        
        // Event listeners
        quantityInput.addEventListener('input', updateLineTotal);
        priceInput.addEventListener('input', updateLineTotal);
        unitSelect.addEventListener('change', updateLineTotal);
        
        removeBtn.addEventListener('click', function() {
            if (itemsContainer.children.length > 1) {
                row.querySelector('.product-row').remove();
                updateGrandTotal();
            } else {
                alert('Au moins un article est requis.');
            }
        });
    }
    
    function updateGrandTotal() {
        const lineTotals = document.querySelectorAll('.line-total');
        let grandTotal = 0;
        
        lineTotals.forEach(input => {
            const value = parseFloat(input.value.replace(' DA', '')) || 0;
            grandTotal += value;
        });
        
        document.getElementById('grandTotal').textContent = grandTotal.toFixed(2) + ' DA';
    }
    
    // Event listener pour stock par d√©faut
    defaultStockLocation.addEventListener('change', function() {
        const stockSelects = document.querySelectorAll('.stock-location-select');
        stockSelects.forEach(select => {
            if (!select.value || select.value === select.dataset.originalDefault) {
                select.value = defaultStockLocation.value;
                select.dataset.originalDefault = defaultStockLocation.value;
            }
        });
    });
    
    // Validation avant soumission
    document.getElementById('purchaseForm').addEventListener('submit', function(e) {
        const products = document.querySelectorAll('.product-select');
        let hasValidItems = false;
        
        products.forEach(select => {
            if (select.value) {
                hasValidItems = true;
            }
        });
        
        if (!hasValidItems) {
            e.preventDefault();
            alert('Veuillez ajouter au moins un produit au bon d\'achat.');
        }
    });
});
</script>
{% endblock %}
