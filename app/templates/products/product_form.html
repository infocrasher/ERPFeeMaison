{% extends "base.html" %}

{% block title %}{{ title }} - Fée Maison{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-9 col-xl-8">
            <div class="d-flex align-items-center mb-4">
                <a href="{{ url_for('products.list_products') }}" class="btn btn-outline-secondary me-3" title="Retour à la liste des produits">
                    <i class="bi bi-arrow-left"></i>
                </a>
                <h1 class="h3 mb-0">
                    <i class="bi bi-box-seam-fill me-2"></i>{{ title }}
                </h1>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-{% if product and product.id %}pencil-fill{% else %}plus-circle-fill{% endif %} me-2"></i>
                        {{ legend or 'Détails du produit' }}
                    </h5>
                </div>
                <div class="card-body p-4">
                    <form method="POST" enctype="multipart/form-data" novalidate>
                        {{ form.hidden_tag() }}
                        
                        <div class="row">
                            <div class="col-md-7 mb-3">
                                {{ form.name.label(class="form-label fw-semibold") }}
                                <span class="text-danger" title="Champ requis">*</span>
                                {{ form.name(class="form-control form-control-lg" + (" is-invalid" if form.name.errors else ""), placeholder="Nom complet du produit ou ingrédient") }}
                                {% if form.name.errors %}
                                    <div class="invalid-feedback">{% for error in form.name.errors %}{{ error }}{% endfor %}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-5 mb-3">
                                {{ form.product_type.label(class="form-label fw-semibold") }}
                                <span class="text-danger" title="Champ requis">*</span>
                                {{ form.product_type(class="form-select form-select-lg" + (" is-invalid" if form.product_type.errors else ""), id="product_type") }}
                                {% if form.product_type.errors %}
                                    <div class="invalid-feedback">{% for error in form.product_type.errors %}{{ error }}{% endfor %}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-7 mb-3">
                                {{ form.category.label(class="form-label fw-semibold") }}
                                <span class="text-danger" title="Champ requis">*</span>
                                {{ form.category(class="form-select" + (" is-invalid" if form.category.errors else "")) }}
                                {% if form.category.errors %}
                                    <div class="invalid-feedback">{% for error in form.category.errors %}{{ error }}{% endfor %}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-5 mb-3">
                                {{ form.unit.label(class="form-label fw-semibold") }}
                                <span class="text-danger" title="Champ requis">*</span>
                                {{ form.unit(class="form-select" + (" is-invalid" if form.unit.errors else "")) }}
                                {% if form.unit.errors %}
                                    <div class="invalid-feedback">{% for error in form.unit.errors %}{{ error }}{% endfor %}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.sale_unit.label(class="form-label fw-semibold") }}
                                {{ form.sale_unit(class="form-select" + (" is-invalid" if form.sale_unit.errors else ""), id="sale_unit") }}
                                {% if form.sale_unit.errors %}
                                    <div class="invalid-feedback">{% for error in form.sale_unit.errors %}{{ error }}{% endfor %}</div>
                                {% endif %}
                                <div class="form-text">Unité utilisée pour la vente au POS. Si vide, utilise l'unité de base.</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            {{ form.description.label(class="form-label fw-semibold") }}
                            {{ form.description(class="form-control" + (" is-invalid" if form.description.errors else ""), rows=3, placeholder="Description détaillée, ingrédients clés, notes spéciales...") }}
                            {% if form.description.errors %}
                                <div class="invalid-feedback">{% for error in form.description.errors %}{{ error }}{% endfor %}</div>
                            {% endif %}
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3" id="price_field_wrapper">
                                {{ form.price.label(class="form-label fw-semibold") }}
                                <span class="text-danger price-required-indicator" style="display: none;" title="Requis pour Produit Fini">*</span>
                                <div class="input-group">
                                    {{ form.price(class="form-control" + (" is-invalid" if form.price.errors else ""), step="0.01", placeholder="0.00") }}
                                    <span class="input-group-text">DA</span>
                                </div>
                                {% if form.price.errors %}
                                    <div class="invalid-feedback d-block">{% for error in form.price.errors %}{{ error }}{% endfor %}</div>
                                {% endif %}
                                <div class="form-text price-form-text" id="price_unit_text">Prix de vente au client.</div>
                            </div>

                            <div class="col-md-6 mb-3" id="cost_price_field_wrapper">
                                {{ form.cost_price.label(class="form-label fw-semibold") }}
                                <span class="text-danger cost-price-required-indicator" style="display: none;" title="Requis pour Ingrédient">*</span>
                                <div class="input-group">
                                    {{ form.cost_price(class="form-control" + (" is-invalid" if form.cost_price.errors else ""), step="0.01", placeholder="0.00") }}
                                    <span class="input-group-text">DA</span>
                                </div>
                                {% if form.cost_price.errors %}
                                    <div class="invalid-feedback d-block">{% for error in form.cost_price.errors %}{{ error }}{% endfor %}</div>
                                {% endif %}
                                <div class="form-text cost-price-form-text">Prix d'achat (matière première) ou coût de revient direct (produit fini).</div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <!-- ### DEBUT DE LA CORRECTION ### -->
                            <!-- Le champ pour 'quantity_in_stock' a été supprimé d'ici. -->
                            <!-- ### FIN DE LA CORRECTION ### -->

                            <div class="col-md-12 mb-4">
                                {{ form.sku.label(class="form-label fw-semibold") }}
                                {{ form.sku(class="form-control" + (" is-invalid" if form.sku.errors else ""), placeholder="Ex: GATEAU-CHOC-001, AMANDES-KG-01") }}
                                {% if form.sku.errors %}
                                    <div class="invalid-feedback">{% for error in form.sku.errors %}{{ error }}{% endfor %}</div>
                                {% endif %}
                                <div class="form-text">Référence unique du produit / UGS (optionnel).</div>
                            </div>
                        </div>
                        
                        <!-- Champ "Peut être vendu" (uniquement pour ingrédients et consommables) -->
                        <div class="mb-3" id="can_be_sold_wrapper" style="display: none;">
                            <div class="form-check">
                                {{ form.can_be_sold(class="form-check-input", id="can_be_sold") }}
                                {{ form.can_be_sold.label(class="form-check-label fw-semibold") }}
                                <div class="form-text">Si coché, ce produit apparaîtra au Point de Vente et nécessitera un prix de vente.</div>
                            </div>
                        </div>
                        
                        <!-- Champ "Peut être acheté" (uniquement pour produits finis) -->
                        <div class="mb-3" id="can_be_purchased_wrapper" style="display: none;">
                            <div class="form-check">
                                {{ form.can_be_purchased(class="form-check-input", id="can_be_purchased") }}
                                {{ form.can_be_purchased.label(class="form-check-label fw-semibold") }}
                                <div class="form-text">Si coché, ce produit pourra être acheté directement dans les bons d'achat (ex: tartes préparées en interne mais parfois achetées).</div>
                            </div>
                        </div>
                        
                        <!-- Seuils d'alerte de stock -->
                        <hr class="my-4">
                        <h6 class="fw-bold mb-3">
                            <i class="bi bi-bell-fill me-2"></i>Seuils d'Alerte de Stock
                        </h6>
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle me-2"></i>
                            <small>Définissez les seuils minimaux pour recevoir des alertes. Mettez 0 pour les produits sur commande.</small>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                {{ form.seuil_min_comptoir.label(class="form-label fw-semibold") }}
                                {{ form.seuil_min_comptoir(class="form-control" + (" is-invalid" if form.seuil_min_comptoir.errors else ""), step="0.01", placeholder="0") }}
                                {% if form.seuil_min_comptoir.errors %}
                                    <div class="invalid-feedback">{% for error in form.seuil_min_comptoir.errors %}{{ error }}{% endfor %}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-3 mb-3">
                                {{ form.seuil_min_ingredients_local.label(class="form-label fw-semibold") }}
                                {{ form.seuil_min_ingredients_local(class="form-control" + (" is-invalid" if form.seuil_min_ingredients_local.errors else ""), step="0.01", placeholder="0") }}
                                {% if form.seuil_min_ingredients_local.errors %}
                                    <div class="invalid-feedback">{% for error in form.seuil_min_ingredients_local.errors %}{{ error }}{% endfor %}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-3 mb-3">
                                {{ form.seuil_min_ingredients_magasin.label(class="form-label fw-semibold") }}
                                {{ form.seuil_min_ingredients_magasin(class="form-control" + (" is-invalid" if form.seuil_min_ingredients_magasin.errors else ""), step="0.01", placeholder="0") }}
                                {% if form.seuil_min_ingredients_magasin.errors %}
                                    <div class="invalid-feedback">{% for error in form.seuil_min_ingredients_magasin.errors %}{{ error }}{% endfor %}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-3 mb-3">
                                {{ form.seuil_min_consommables.label(class="form-label fw-semibold") }}
                                {{ form.seuil_min_consommables(class="form-control" + (" is-invalid" if form.seuil_min_consommables.errors else ""), step="0.01", placeholder="0") }}
                                {% if form.seuil_min_consommables.errors %}
                                    <div class="invalid-feedback">{% for error in form.seuil_min_consommables.errors %}{{ error }}{% endfor %}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="mb-3">
                            {{ form.image.label(class="form-label fw-semibold") }}
                            {{ form.image(class="form-control" + (" is-invalid" if form.image.errors else "")) }}
                            {% if form.image.errors %}
                                <div class="invalid-feedback d-block">{% for error in form.image.errors %}{{ error }}{% endfor %}</div>
                            {% endif %}
                            {% if product and product.image_filename %}
                                <div class="mt-2">
                                    <img src="{{ url_for('static', filename='img/products/' ~ product.image_filename) }}" alt="Aperçu" class="img-thumbnail" style="max-width: 200px;">
                                </div>
                            {% endif %}
                        </div>

                        <div class="d-flex gap-2 mt-4">
                            {{ form.submit(class="btn btn-primary btn-lg") }}
                            <a href="{{ url_for('products.list_products') }}" class="btn btn-outline-secondary btn-lg">
                                <i class="bi bi-x-circle me-1"></i>Annuler
                            </a>
                            {% if product and product.id %}
                            <button type="button" 
                                    class="btn btn-outline-danger btn-lg ms-auto" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#deleteProductModal{{ product.id }}">
                                <i class="bi bi-trash-fill me-1"></i>Supprimer ce Produit
                            </button>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
            {% if product and product.id %}
            <!-- Modal de suppression (si en mode édition) -->
            <div class="modal fade" id="deleteProductModal{{ product.id }}">
                <!-- Le contenu de ta modal reste ici -->
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const productTypeField = document.getElementById('product_type');
    const priceFieldWrapper = document.getElementById('price_field_wrapper');
    const costPriceFieldWrapper = document.getElementById('cost_price_field_wrapper');
    const priceInput = document.getElementById('price');
    const costPriceInput = document.getElementById('cost_price');
    const priceRequiredIndicator = document.querySelector('.price-required-indicator');
    const costPriceRequiredIndicator = document.querySelector('.cost-price-required-indicator');
    const priceFormText = document.getElementById('price_unit_text') || document.querySelector('.price-form-text');
    const costPriceFormText = document.querySelector('.cost-price-form-text');
    const canBeSoldWrapper = document.getElementById('can_be_sold_wrapper');
    const canBeSoldCheckbox = document.getElementById('can_be_sold');
    const saleUnitField = document.getElementById('sale_unit');
    const unitField = document.getElementById('unit');

    function updateFieldsBasedOnProductType() {
        if (!productTypeField || !priceFieldWrapper || !costPriceFieldWrapper || !priceInput || !costPriceInput || !priceRequiredIndicator || !costPriceRequiredIndicator) {
            return;
        }
        const productType = productTypeField.value;
        
        if (productType === 'ingredient') {
            // Afficher la case "Peut être vendu"
            if (canBeSoldWrapper) canBeSoldWrapper.style.display = 'block';
            
            // Masquer la case "Peut être acheté" (uniquement pour produits finis)
            const canBePurchasedWrapper = document.getElementById('can_be_purchased_wrapper');
            if (canBePurchasedWrapper) canBePurchasedWrapper.style.display = 'none';
            const canBePurchasedCheckbox = document.getElementById('can_be_purchased');
            if (canBePurchasedCheckbox) canBePurchasedCheckbox.checked = false;
            
            // Masquer le prix par défaut (sera affiché si can_be_sold est coché)
            if (!canBeSoldCheckbox || !canBeSoldCheckbox.checked) {
                priceFieldWrapper.style.display = 'none';
                priceInput.value = '';
                priceRequiredIndicator.style.display = 'none';
            }
            
            costPriceFieldWrapper.style.display = 'block';
            costPriceRequiredIndicator.style.display = 'inline';
            if (costPriceFormText) costPriceFormText.textContent = "Prix d'achat de la matière première (obligatoire).";
            if (priceFormText) priceFormText.textContent = "Prix de vente au client (affiché si 'Peut être vendu' est coché).";
            updatePriceUnitText();
            
        } else if (productType === 'finished') {
            // Masquer la case "Peut être vendu" (les produits finis sont toujours vendables)
            if (canBeSoldWrapper) canBeSoldWrapper.style.display = 'none';
            if (canBeSoldCheckbox) canBeSoldCheckbox.checked = false;
            
            // Afficher la case "Peut être acheté" pour produits finis
            const canBePurchasedWrapper = document.getElementById('can_be_purchased_wrapper');
            if (canBePurchasedWrapper) canBePurchasedWrapper.style.display = 'block';
            
            // Prix toujours visible et obligatoire pour produits finis
            priceFieldWrapper.style.display = 'block';
            priceRequiredIndicator.style.display = 'inline';
            costPriceFieldWrapper.style.display = 'block';
            costPriceRequiredIndicator.style.display = 'none';
            if (costPriceFormText) costPriceFormText.textContent = "Coût de revient direct ou prix d'achat (optionnel pour produit fini).";
            if (priceFormText) priceFormText.textContent = "Prix de vente au client (obligatoire pour produit fini).";
            updatePriceUnitText();
            
        } else { // Cas 'consommable' et autres
            // Afficher la case "Peut être vendu"
            if (canBeSoldWrapper) canBeSoldWrapper.style.display = 'block';
            
            // Masquer la case "Peut être acheté" (uniquement pour produits finis)
            const canBePurchasedWrapper = document.getElementById('can_be_purchased_wrapper');
            if (canBePurchasedWrapper) canBePurchasedWrapper.style.display = 'none';
            const canBePurchasedCheckbox = document.getElementById('can_be_purchased');
            if (canBePurchasedCheckbox) canBePurchasedCheckbox.checked = false;
            
            // Masquer le prix par défaut (sera affiché si can_be_sold est coché)
            if (!canBeSoldCheckbox || !canBeSoldCheckbox.checked) {
                priceFieldWrapper.style.display = 'none';
                priceInput.value = '';
                priceRequiredIndicator.style.display = 'none';
            }
            
            costPriceFieldWrapper.style.display = 'block';
            priceRequiredIndicator.style.display = 'none';
            costPriceRequiredIndicator.style.display = 'none';
            if (costPriceFormText) costPriceFormText.textContent = "Prix d'achat ou coût de revient direct.";
            if (priceFormText) priceFormText.textContent = "Prix de vente au client (affiché si 'Peut être vendu' est coché).";
            updatePriceUnitText();
        }
        
        // Mettre à jour l'affichage du prix selon l'état de can_be_sold
        updatePriceFieldBasedOnCanBeSold();
    }
    
    function updatePriceFieldBasedOnCanBeSold() {
        if (!canBeSoldCheckbox || !priceFieldWrapper || !priceInput || !priceRequiredIndicator) {
            return;
        }
        
        const productType = productTypeField ? productTypeField.value : '';
        const canBeSold = canBeSoldCheckbox.checked;
        
        // Si c'est un ingrédient ou consommable
        if (productType === 'ingredient' || productType === 'consommable') {
            if (canBeSold) {
                // Afficher le champ prix et le rendre obligatoire
                priceFieldWrapper.style.display = 'block';
                priceRequiredIndicator.style.display = 'inline';
                if (priceFormText) priceFormText.textContent = "Prix de vente au client (obligatoire si 'Peut être vendu' est coché).";
                updatePriceUnitText();
            } else {
                // Masquer le champ prix et vider sa valeur
                priceFieldWrapper.style.display = 'none';
                priceInput.value = '';
                priceRequiredIndicator.style.display = 'none';
                if (priceFormText) priceFormText.textContent = "Prix de vente au client (affiché si 'Peut être vendu' est coché).";
                updatePriceUnitText();
            }
        }
    }
    
    // Initialiser les champs au chargement
    if (productTypeField) {
        updateFieldsBasedOnProductType();
        productTypeField.addEventListener('change', updateFieldsBasedOnProductType);
    }
    
    // Écouter les changements de la case "Peut être vendu"
    if (canBeSoldCheckbox) {
        canBeSoldCheckbox.addEventListener('change', updatePriceFieldBasedOnCanBeSold);
    }
    
    // Fonction pour mettre à jour le texte du prix selon l'unité de vente
    function updatePriceUnitText() {
        if (!priceFormText || !unitField) return;
        
        const baseUnit = unitField.value || '';
        const saleUnit = saleUnitField ? saleUnitField.value : '';
        const displayUnit = saleUnit || baseUnit;
        
        // Mettre à jour le texte seulement si le prix est visible
        if (priceFieldWrapper && priceFieldWrapper.style.display !== 'none') {
            if (displayUnit) {
                const unitLabels = {
                    'g': 'gramme',
                    'kg': 'kilogramme',
                    'ml': 'millilitre',
                    'l': 'litre',
                    'pièce': 'pièce'
                };
                const unitLabel = unitLabels[displayUnit] || displayUnit;
                priceFormText.textContent = `Prix de vente au client (par ${unitLabel}).`;
            } else {
                priceFormText.textContent = "Prix de vente au client.";
            }
        }
    }
    
    // Écouter les changements de l'unité de base et de l'unité de vente
    if (unitField) {
        unitField.addEventListener('change', updatePriceUnitText);
    }
    if (saleUnitField) {
        saleUnitField.addEventListener('change', updatePriceUnitText);
    }
    
    // Mettre à jour au chargement
    updatePriceUnitText();
});
</script>
{% endblock %}