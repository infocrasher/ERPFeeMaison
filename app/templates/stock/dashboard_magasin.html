{% extends "base.html" %}

{% block title %}{{ title }} - F√©e Maison{% endblock %}

{% block head %}
<style>
    .hero-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 18px;
        padding: 24px;
        color: #fff;
        box-shadow: 0 10px 30px rgba(102,126,234,.25);
    }
    .hero-actions .btn {
        border-radius: 999px;
        padding: 0.55rem 1.4rem;
    }
    .stat-chip {
        border-radius: 16px;
        padding: 14px 16px;
        background: #fff;
        box-shadow: 0 5px 18px rgba(0,0,0,.08);
        transition: transform .2s ease;
    }
    .stat-chip:hover { transform: translateY(-4px); }
    .stat-chip h3 { margin: 0; font-size: 1.6rem; }
    .filter-panel {
        background: #fff;
        border-radius: 14px;
        box-shadow: 0 8px 25px rgba(0,0,0,.07);
        padding: 18px;
    }
    .search-input {
        border-radius: 999px;
        padding: .65rem 1.25rem;
        border: 1px solid #e3e6ef;
        box-shadow: none;
    }
    .alert-card {
        border-radius: 16px;
        padding: 18px;
        color: #fff;
        min-height: 180px;
    }
    .alert-critical { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
    .alert-warning { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); color:#fff; }
    .category-accordion .accordion-button {
        background: #f8f9fc;
        font-weight: 600;
    }
    .ingredient-row {
        border-radius: 12px;
        background: #fff;
        border: 1px solid #eef0f7;
        padding: 16px;
        margin-bottom: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: box-shadow .2s ease;
    }
    .ingredient-row:hover {
        box-shadow: 0 12px 28px rgba(15,23,42,.08);
    }
    .badge-soft {
        border-radius: 999px;
        padding: .35rem .8rem;
        font-size: .85rem;
    }
    .badge-soft-danger { background: rgba(255,99,132,.15); color:#ff5274; }
    .badge-soft-warning { background: rgba(253,193,112,.2); color:#ff8d2b; }
    .badge-soft-success { background: rgba(29,209,161,.15); color:#1dd1a1; }
    .show-more-btn {
        border-radius: 999px;
        padding: .55rem 1.5rem;
    }
    .side-card {
        border-radius: 16px;
        box-shadow: 0 12px 28px rgba(0,0,0,.08);
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="hero-card mb-4">
        <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
            <div>
                <p class="text-uppercase mb-1" style="letter-spacing:.2em;">R√©serve magasin</p>
                <h1 class="h3 mb-2">üì¶ Gestion des ingr√©dients & fournisseurs</h1>
                <span class="badge bg-light text-dark">Derni√®re mise √† jour {{ current_time.strftime('%d/%m/%Y %H:%M') if current_time is defined else '‚Äî' }}</span>
            </div>
            <div class="hero-actions btn-group">
                <a href="{{ url_for('purchases.new_purchase') }}" class="btn btn-light text-primary"><i class="bi bi-plus"></i> Nouvel achat</a>
                <a href="{{ url_for('stock.create_transfer') }}" class="btn btn-outline-light"><i class="bi bi-arrow-left-right"></i> Transfert</a>
            </div>
        </div>
        <div class="row g-3 mt-3">
            <div class="col-md-3">
                <div class="stat-chip">
                    <small class="text-muted">Ingr√©dients actifs</small>
                    <h3>{{ total_ingredients_magasin or 0 }}</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-chip">
                    <small class="text-muted">Valeur stock</small>
                    <h3>{{ total_value or '0' }} DA</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-chip">
                    <small class="text-muted">Sous seuil</small>
                    <h3>{{ (critical_ingredients|length) + (suggested_purchases|length) }}</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-chip">
                    <small class="text-muted">Achats en cours</small>
                    <h3>{{ pending_purchases or 0 }}</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <div class="alert-card alert-critical h-100">
                        <div class="d-flex justify-content-between mb-2">
                            <strong>Ruptures imm√©diates</strong>
                            <span class="badge bg-light text-danger">{{ critical_ingredients|length }}</span>
                        </div>
                        <ul class="list-unstyled mb-0">
                            {% for ingredient in critical_ingredients[:4] %}
                            <li class="d-flex justify-content-between">
                                <span>{{ ingredient.name }}</span>
                                <span class="badge-soft badge-soft-danger">0</span>
                            </li>
                            {% endfor %}
                            {% if critical_ingredients|length == 0 %}
                            <li class="text-white-50">Aucune rupture üéâ</li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="alert-card alert-warning h-100">
                        <div class="d-flex justify-content-between mb-2">
                            <strong>Surveiller</strong>
                            <span class="badge bg-light text-dark">{{ suggested_purchases|length }}</span>
                        </div>
                        <ul class="list-unstyled mb-0">
                            {% for suggestion in suggested_purchases[:4] %}
                            <li class="d-flex justify-content-between">
                                <span>{{ suggestion.product_name }}</span>
                                <small>{{ suggestion.suggested_quantity }} {{ suggestion.unit }}</small>
                            </li>
                            {% endfor %}
                            {% if suggested_purchases|length == 0 %}
                            <li class="text-white-50">Rien √† signaler</li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>

            <div class="filter-panel mb-3">
                <div class="row align-items-center g-2">
                    <div class="col-md-7">
                        <input type="text" id="ingredient-search" class="form-control search-input" placeholder="Filtrer un ingr√©dient ou une cat√©gorie...">
                    </div>
                    <div class="col-md-5 text-md-end">
                        <span class="badge bg-primary me-2" id="visible-count">0 affich√©s</span>
                        <button class="btn btn-outline-primary btn-sm" id="toggle-collapse"><i class="bi bi-arrows-expand"></i> Tout r√©duire</button>
                    </div>
                </div>
            </div>

            <div class="accordion category-accordion" id="categoryAccordion">
                {% for category, ingredients in ingredients_by_category.items() %}
                <div class="accordion-item mb-3">
                    <h2 class="accordion-header" id="heading-{{ loop.index }}">
                        <button class="accordion-button {{ 'collapsed' if loop.index > 3 }}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ loop.index }}">
                            <span class="me-2">üìÅ {{ category }}</span>
                            <small class="text-muted">{{ ingredients|length }} produits</small>
                        </button>
                    </h2>
                    <div id="collapse-{{ loop.index }}" class="accordion-collapse collapse {{ 'show' if loop.index <= 3 }}" data-bs-parent="#categoryAccordion">
                        <div class="accordion-body">
                            {% for ingredient in ingredients %}
                            {% set stock_level = ingredient.stock_ingredients_magasin or 0 %}
                            {% set seuil = ingredient.seuil_min_ingredients_magasin if ingredient.seuil_min_ingredients_magasin is not none else 0 %}
                            {% set status = 'success' %}
                            {% set label = 'Disponible' %}
                            {% if stock_level <= 0 %}
                                {% set status = 'danger' %}
                                {% set label = 'Rupture' %}
                            {% elif stock_level <= seuil %}
                                {% set status = 'warning' %}
                                {% set label = 'Sous seuil' %}
                            {% endif %}
                            <div class="ingredient-row" data-name="{{ ingredient.name|lower }}" data-category="{{ category|lower }}">
                                <div>
                                    <strong>{{ ingredient.name }}</strong><br>
                                    <small class="text-muted">{{ ingredient.unit or 'unit√©s' }}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge-soft badge-soft-{{ status }}">{{ "%.2f"|format(stock_level) }} / {{ "%.2f"|format(seuil) }}</span><br>
                                    <small class="text-muted">{{ "%.2f"|format(ingredient.valeur_stock_ingredients_magasin or 0) }} DA</small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="text-center mt-3">
                <button class="btn btn-outline-primary show-more-btn" id="showMoreBtn">Charger plus</button>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card side-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-lightning-charge text-primary me-2"></i>Actions rapides</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('purchases.list_purchases') }}" class="btn btn-outline-primary"><i class="bi bi-receipt me-2"></i> Liste achats</a>
                        <a href="{{ url_for('stock.transfers_list') }}" class="btn btn-outline-success"><i class="bi bi-arrow-repeat me-2"></i> Transferts</a>
                        <a href="{{ url_for('stock.overview') }}" class="btn btn-outline-info"><i class="bi bi-pie-chart me-2"></i> Vue globale</a>
                        <a href="{{ url_for('stock.adjustment') }}" class="btn btn-outline-warning"><i class="bi bi-sliders me-2"></i>Ajuster stock</a>
                    </div>
                </div>
            </div>
            {% if suggested_purchases %}
            <div class="card side-card">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0"><i class="bi bi-lightbulb me-2"></i>Suggestions d'achat</h6>
                </div>
                <div class="list-group list-group-flush">
                    {% for suggestion in suggested_purchases %}
                    <div class="list-group-item">
                        <strong>{{ suggestion.product_name }}</strong><br>
                        <small class="text-muted">Ajouter {{ suggestion.suggested_quantity }} {{ suggestion.unit }}</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const ingredientRows = [...document.querySelectorAll('.ingredient-row')];
const searchInput = document.getElementById('ingredient-search');
const visibleCount = document.getElementById('visible-count');
const showMoreBtn = document.getElementById('showMoreBtn');
let sliceIndex = 20;

function updateVisibility() {
    const term = (searchInput.value || '').toLowerCase();
    let visible = 0;
    ingredientRows.forEach((row, index) => {
        const matches = row.dataset.name.includes(term) || row.dataset.category.includes(term);
        const withinSlice = index < sliceIndex;
        if (matches && withinSlice) {
            row.style.display = 'flex';
            visible++;
        } else {
            row.style.display = 'none';
        }
    });
    visibleCount.textContent = `${visible} affich√©s`;
    if (sliceIndex >= ingredientRows.length) {
        showMoreBtn.classList.add('d-none');
    } else {
        showMoreBtn.classList.remove('d-none');
    }
}

searchInput.addEventListener('input', () => {
    sliceIndex = 20;
    updateVisibility();
});

showMoreBtn.addEventListener('click', () => {
    sliceIndex += 20;
    updateVisibility();
});

document.addEventListener('DOMContentLoaded', () => {
    updateVisibility();
});
</script>
{% endblock %}
