{% extends "base.html" %}

{% block title %}POS Moderne - F√©e Maison{% endblock %}

{% block head %}
<style>
    :root {
        --mint-50: #f3fbf6;
        --mint-100: #d9f7e8;
        --mint-200: #b9efda;
        --mint-300: #8de2bc;
        --mint-500: #2bc48a;
        --mint-600: #1ea971;
        --mint-700: #13885a;
        --teal-900: #153b3d;
        --slate-100: #eff3f6;
        --slate-200: #dfe7ec;
        --slate-400: #9aa6b2;
        --slate-600: #6c7a89;
        --slate-700: #4c5a67;
        --card-bg: #ffffff;
        --shadow-soft: 0 24px 48px rgba(28, 99, 71, 0.08);
        --radius-lg: 20px;
        --radius-md: 14px;
        --radius-sm: 10px;
        --font-family: 'Poppins', 'Segoe UI', sans-serif;
    }

    * {
        box-sizing: border-box;
    }

    body {
        margin: 0;
        padding: 0;
        font-family: var(--font-family);
        background: var(--mint-50);
        color: var(--teal-900);
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
    }

    .navbar.navbar {
        display: none !important;
    }

    body > .container-fluid.mt-3 {
        display: none !important;
    }

    main.container-fluid.mt-4 {
        margin-top: 0 !important;
        padding: 0 !important;
    }

    .pos-modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }

    .pos-modal.is-open {
        display: flex;
    }

    .pos-modal__backdrop {
        position: absolute;
        inset: 0;
        background: rgba(21, 59, 61, 0.35);
        backdrop-filter: blur(2px);
    }

    .pos-modal__dialog {
        position: relative;
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-soft);
        padding: 24px;
        width: min(360px, 90vw);
        display: flex;
        flex-direction: column;
        gap: 16px;
        z-index: 2001;
    }

    .pos-modal__dialog h3 {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--teal-900);
    }

    .pos-modal__form {
        display: flex;
        flex-direction: column;
        gap: 14px;
    }

    .pos-modal__field {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .pos-modal__field label {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--slate-600);
    }

    .pos-modal__field input {
        border: 1px solid var(--slate-200);
        border-radius: var(--radius-sm);
        padding: 10px 12px;
        font-size: 0.95rem;
        outline: none;
        transition: border 0.2s, box-shadow 0.2s;
    }

    .pos-modal__field input:focus {
        border-color: var(--mint-500);
        box-shadow: 0 0 0 3px rgba(43, 196, 138, 0.15);
    }

    .pos-modal__actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 10px;
    }

    .modal-btn {
        border: none;
        border-radius: var(--radius-sm);
        padding: 10px 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.18s, background 0.18s;
    }

    .modal-btn.secondary {
        background: var(--slate-100);
        color: var(--slate-700);
    }

    .modal-btn.secondary:hover {
        transform: translateY(-1px);
        background: var(--slate-200);
    }

    .modal-btn.primary {
        background: linear-gradient(135deg, var(--mint-500), var(--mint-300));
        color: white;
        box-shadow: 0 10px 18px rgba(43, 196, 138, 0.25);
    }

    .modal-btn.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 16px 22px rgba(43, 196, 138, 0.3);
    }

    .pos-modal__summary {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--slate-700);
        background: var(--slate-100);
        border-radius: var(--radius-sm);
        padding: 10px 12px;
    }

    .pos-modal__change {
        background: var(--mint-50);
        border: 1px dashed var(--mint-300);
        border-radius: var(--radius-sm);
        padding: 10px 12px;
        font-weight: 600;
        color: var(--mint-600);
    }

    .pos-modal__error {
        color: #c2414d;
        font-size: 0.85rem;
        font-weight: 600;
        display: none;
    }

    .pos-modal__error.is-visible {
        display: block;
    }

    .pos-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        height: 100%;
        overflow: hidden;
    }

    .pos-shell {
        flex: 1;
        display: flex;
        min-height: 0;
        padding: 12px 16px;
        gap: 16px;
        height: 100%;
        overflow: hidden;
    }

    /* --- Sidebar --- */
    .sidebar-nav {
        width: 220px;
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-soft);
        padding: 24px 18px;
        display: flex;
        flex-direction: column;
        gap: 24px;
        transition: transform 0.3s ease, opacity 0.3s ease, width 0.3s ease;
        z-index: 100;
    }
    
    /* Sidebar collapsed state */
    .sidebar-nav.collapsed {
        transform: translateX(-240px);
        opacity: 0;
        pointer-events: none;
        position: absolute;
        left: 24px;
        top: 24px;
        bottom: 16px;
    }
    
    .sidebar-nav.collapsed.hover-visible {
        transform: translateX(0);
        opacity: 1;
        pointer-events: auto;
    }
    
    /* Hover trigger zone */
    .sidebar-hover-zone {
        position: fixed;
        left: 0;
        top: 0;
        width: 30px;
        height: 100%;
        z-index: 99;
        display: none;
    }
    
    .sidebar-hover-zone.active {
        display: block;
    }
    
    /* Toggle button */
    .sidebar-toggle-btn {
        position: fixed;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        z-index: 101;
        background: var(--mint-500);
        color: white;
        border: none;
        width: 28px;
        height: 60px;
        border-radius: 0 8px 8px 0;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        box-shadow: 2px 0 8px rgba(0,0,0,0.15);
        transition: background 0.2s;
    }
    
    .sidebar-toggle-btn:hover {
        background: var(--mint-600);
    }
    
    .sidebar-toggle-btn.visible {
        display: flex;
    }
    
    .sidebar-toggle-hint {
        position: fixed;
        bottom: 10px;
        left: 10px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.75rem;
        z-index: 102;
        display: none;
    }
    
    .sidebar-toggle-hint.visible {
        display: block;
    }

    .sidebar-brand {
        display: flex;
        align-items: center;
        gap: 12px;
        font-weight: 700;
        font-size: 1.1rem;
        color: var(--mint-600);
    }

    .brand-logo {
        width: 36px;
        height: 36px;
        border-radius: 12px;
        background: linear-gradient(135deg, var(--mint-500), var(--mint-300));
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
    }

    .sidebar-menu {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .sidebar-section {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .sidebar-section-title {
        font-size: 0.78rem;
        font-weight: 700;
        letter-spacing: .08em;
        text-transform: uppercase;
        color: var(--slate-400);
        margin-bottom: 2px;
    }

    .sidebar-link {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 14px;
        border-radius: var(--radius-sm);
        text-decoration: none;
        color: var(--slate-700);
        font-weight: 500;
        transition: background 0.2s, color 0.2s, transform 0.2s;
    }

    .sidebar-link .icon {
        width: 32px;
        height: 32px;
        border-radius: 10px;
        background: var(--mint-100);
        color: var(--mint-600);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
    }

    .sidebar-link.active,
    .sidebar-link:hover {
        background: var(--mint-100);
        color: var(--mint-700);
        transform: translateX(4px);
    }

    .sidebar-footer {
        margin-top: auto;
        display: flex;
        flex-direction: column;
        gap: 18px;
        padding-top: 12px;
        border-top: 1px solid var(--slate-200);
    }

    .sidebar-profile {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .sidebar-profile .profile-role {
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--mint-600);
        text-transform: uppercase;
        letter-spacing: .08em;
    }

    .sidebar-profile .profile-username {
        font-size: 0.95rem;
        color: var(--slate-600);
    }

    .sidebar-footer-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .sidebar-cta {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px;
        border-radius: var(--radius-sm);
        text-decoration: none;
        font-weight: 600;
        background: var(--mint-100);
        color: var(--mint-600);
        transition: background 0.18s, transform 0.18s, color 0.18s;
    }

    .sidebar-cta:hover {
        background: var(--mint-500);
        color: white;
        transform: translateY(-2px);
    }

    .sidebar-cta.danger {
        background: #fde7e8;
        color: #c2414d;
    }

    .sidebar-cta.danger:hover {
        background: #f25f6d;
        color: white;
    }

    .logout-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 12px;
        border-radius: var(--radius-sm);
        background: #fbe7e8;
        color: #b6424d;
        text-decoration: none;
        font-weight: 600;
        transition: transform 0.18s, background 0.18s;
    }

    .logout-btn:hover {
        transform: translateY(-2px);
        background: #f7c9cf;
    }

    /* --- Main columns --- */
    .pos-main {
        flex: 1;
        display: flex;
        min-height: 0;
        gap: 24px;
    }

    .menu-column {
        flex: 1;
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        display: flex;
        flex-direction: column;
        box-shadow: var(--shadow-soft);
        padding: 16px;
        min-width: 0;
        min-height: 0;
        height: 100%;
        overflow: hidden;
    }

    .menu-top {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-shrink: 0;
        margin-bottom: 8px;
    }

    .menu-heading {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .menu-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--teal-900);
    }

    .menu-subtitle {
        font-size: 0.85rem;
        color: var(--slate-600);
    }

    .top-actions {
        display: flex;
        gap: 12px;
    }

    .top-action {
        border: none;
        background: var(--mint-100);
        color: var(--mint-600);
        font-weight: 500;
        border-radius: var(--radius-sm);
        padding: 10px 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: transform 0.2s, background 0.2s;
        text-decoration: none;
    }

    .top-action:hover {
        transform: translateY(-2px);
        background: var(--mint-300);
        color: var(--teal-900);
    }

    .menu-search {
        margin-top: 8px;
        flex-shrink: 0;
    }

    .search-field {
        display: flex;
        align-items: center;
        background: var(--mint-50);
        border: 1px solid var(--slate-200);
        border-radius: var(--radius-md);
        padding: 10px 14px;
    }

    .search-field svg {
        color: var(--slate-600);
        margin-right: 10px;
    }

    .search-field input {
        flex: 1;
        border: none;
        background: transparent;
        font-size: 1rem;
        outline: none;
        color: var(--teal-900);
    }

    .category-strip {
        display: flex;
        gap: 10px;
        margin: 10px 0 8px;
        overflow-x: auto;
        padding-bottom: 4px;
        flex-shrink: 0;
    }

    .category-strip::-webkit-scrollbar {
        height: 6px;
    }

    .category-strip::-webkit-scrollbar-thumb {
        background: var(--mint-300);
        border-radius: 999px;
    }

    .category-tab {
        border: none;
        padding: 12px 20px;
        border-radius: 999px;
        background: var(--mint-100);
        color: var(--mint-600);
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s, transform 0.2s, color 0.2s;
        white-space: nowrap;
    }

    .category-tab.active,
    .category-tab:hover {
        background: var(--mint-600);
        color: white;
        transform: translateY(-2px);
    }

    .products-scroll {
        flex: 1;
        overflow-y: auto;
        margin-top: 0;
        padding-right: 6px;
        min-height: 0;
        height: 100%;
    }

    .products-scroll::-webkit-scrollbar {
        width: 6px;
    }

    .products-scroll::-webkit-scrollbar-thumb {
        background: var(--mint-300);
        border-radius: 999px;
    }

    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 12px;
    }
    
    /* Mode compact avec sidebar visible */
    .pos-shell:not(.sidebar-hidden) .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    }
    
    /* Mode compact avec sidebar cach√©e = plus d'espace = 5 colonnes */
    .pos-shell.sidebar-hidden .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    }

    .product-card {
        background: var(--card-bg);
        border-radius: var(--radius-sm);
        padding: 10px;
        box-shadow: 0 4px 12px rgba(28, 99, 71, 0.08);
        display: flex;
        flex-direction: column;
        min-height: 180px;
        transition: transform 0.2s, box-shadow 0.2s;
        position: relative;
    }

    .product-card.out-of-stock {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .product-card:hover:not(.out-of-stock) {
        transform: translateY(-6px);
        box-shadow: 0 24px 45px rgba(19, 136, 90, 0.18);
    }

    .card-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        background: var(--mint-600);
        color: white;
        font-size: 0.65rem;
        font-weight: 600;
        padding: 2px 6px;
        border-radius: 999px;
        letter-spacing: 0.02em;
    }

    .card-badge.badge-out {
        background: #f46a6a;
    }

    .card-image {
        height: 80px;
        border-radius: var(--radius-sm);
        background: var(--mint-50);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 8px;
        overflow: hidden;
    }

    .card-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .card-placeholder {
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--mint-600);
    }

    .card-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .card-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--teal-900);
        line-height: 1.2;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .card-meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: auto;
        font-weight: 600;
        font-size: 0.8rem;
        color: var(--mint-600);
    }

    .card-meta .stock {
        font-size: 0.7rem;
        color: var(--slate-600);
    }

    .card-actions {
        margin-top: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 6px;
    }

    .card-add-btn {
        flex: 1;
        border: none;
        background: linear-gradient(135deg, var(--mint-500), var(--mint-300));
        color: white;
        padding: 8px;
        border-radius: var(--radius-sm);
        font-weight: 600;
        font-size: 0.8rem;
        cursor: pointer;
        box-shadow: 0 6px 12px rgba(43, 196, 138, 0.2);
        transition: transform 0.18s, box-shadow 0.18s;
    }

    .card-add-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 28px rgba(43, 196, 138, 0.25);
    }

    .card-qty-controls {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--mint-100);
        border-radius: var(--radius-sm);
        padding: 4px 6px;
        gap: 4px;
    }

    .qty-btn {
        border: none;
        background: var(--card-bg);
        color: var(--mint-600);
        width: 26px;
        height: 26px;
        border-radius: 8px;
        font-weight: 700;
        font-size: 0.9rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.15s, background 0.15s;
    }

    .qty-btn:hover {
        transform: scale(1.05);
        background: var(--mint-300);
        color: white;
    }

    .qty-display {
        font-weight: 600;
        color: var(--mint-700);
        font-size: 0.85rem;
    }

    .loading,
    .error-message {
        padding: 32px;
        text-align: center;
        color: var(--slate-600);
        font-weight: 500;
    }

    .error-message {
        background: #ffe6e6;
        border-radius: var(--radius-sm);
    }

    /* --- Order column --- */
    .order-column {
        width: 360px;
        display: flex;
        flex-direction: column;
        background: var(--card-bg);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-soft);
        padding: 24px;
        min-height: 0;
    }

    .order-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
    }

    .order-table {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    
    .order-table .label {
        color: var(--mint-600);
        font-weight: 600;
        font-size: 0.85rem;
    }

    .order-table .value {
        font-size: 1.15rem;
        font-weight: 600;
        color: var(--teal-900);
    }

    .order-settings {
        border: none;
        background: var(--mint-100);
        color: var(--mint-600);
        width: 36px;
        height: 36px;
        border-radius: 12px;
        cursor: pointer;
    }

    .service-toggle {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-top: 18px;
    }

    .service-button {
        border: none;
        padding: 10px 12px;
        border-radius: var(--radius-sm);
        background: var(--mint-100);
        color: var(--mint-600);
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s, color 0.2s;
    }

    .service-button.active,
    .service-button:hover {
        background: var(--mint-600);
        color: white;
    }

    .order-customer-card {
        margin-top: 18px;
        background: var(--mint-50);
        border-radius: var(--radius-md);
        padding: 16px;
        border: 1px solid var(--mint-100);
    }

    .customer-selector-container {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 10px;
    }

    .customer-search-wrapper {
        flex: 1;
        position: relative;
    }

    .customer-search-input {
        width: 100%;
        padding: 10px 14px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--slate-200);
        background: var(--card-bg);
        font-size: 0.95rem;
    }

    .customer-search-input:focus {
        outline: none;
        border-color: var(--mint-500);
        box-shadow: 0 0 0 3px rgba(43, 196, 138, 0.15);
    }
    
    .pos-autocomplete-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid var(--slate-200);
        border-top: none;
        border-radius: 0 0 var(--radius-sm) var(--radius-sm);
        max-height: 200px;
        overflow-y: auto;
        z-index: 20;
        display: none;
    }
    
    .pos-autocomplete-item {
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f4f6f8;
        font-size: 0.9rem;
    }
    
    .pos-autocomplete-item:hover {
        background: var(--mint-50);
    }

    .customer-actions button {
        border: none;
        background: var(--mint-500);
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.18s;
    }

    .customer-actions button:hover {
        transform: translateY(-2px);
    }
    
    .selected-customer-info {
        display: none;
        gap: 12px;
        align-items: center;
        background: var(--card-bg);
        border-radius: var(--radius-sm);
        padding: 10px 14px;
        border: 1px solid var(--mint-100);
    }

    .selected-customer-info.show {
        display: flex !important;
    }
    
    .customer-avatar {
        color: var(--mint-600);
    }
    
    .customer-details {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    
    .customer-name {
        font-weight: 600;
        color: var(--teal-900);
    }
    
    .customer-phone {
        font-size: 0.85rem;
        color: var(--slate-600);
    }

    .order-items-container {
        flex: 1;
        margin-top: 18px;
        background: var(--card-bg);
        border-radius: var(--radius-md);
        border: 1px solid var(--slate-200);
        padding: 12px 16px;
        overflow-y: auto;
        min-height: 0;
        max-height: 260px;
    }

    .order-items-container::-webkit-scrollbar {
        width: 6px;
    }

    .order-items-container::-webkit-scrollbar-thumb {
        background: var(--mint-300);
        border-radius: 999px;
    }

    .order-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 12px 0;
        border-bottom: 1px solid var(--slate-200);
        gap: 12px;
    }

    .order-item:last-child {
        border-bottom: none;
    }

    .order-item.selected {
        background: var(--mint-100);
        border-radius: var(--radius-sm);
        padding: 12px;
    }

    .item-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .item-name {
        font-weight: 600;
        color: var(--teal-900);
    }

    .item-details {
        font-size: 0.9rem;
        color: var(--slate-600);
    }

    .item-price {
        font-weight: 600;
        color: var(--mint-600);
        font-size: 1rem;
    }
    
    .empty-cart-placeholder {
        text-align: center;
        color: var(--slate-600);
        padding: 40px 0;
    }

    .order-totals {
        margin-top: 18px;
        background: var(--mint-50);
        border-radius: var(--radius-md);
        padding: 16px;
        border: 1px solid var(--mint-100);
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .order-totals-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 0.97rem;
        color: var(--slate-700);
    }

    .order-totals-row.total {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--teal-900);
    }
    
    .payment-controls {
        margin-top: 18px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        background: var(--card-bg);
        border-radius: var(--radius-md);
        border: 1px solid var(--mint-100);
        padding: 16px;
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.4);
        position: sticky;
        bottom: 24px;
    }

    .numpad-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
    }

    .numpad-button {
        border: none;
        background: var(--mint-100);
        color: var(--mint-600);
        font-weight: 600;
        border-radius: var(--radius-sm);
        padding: 14px 0;
        font-size: 1.1rem;
        cursor: pointer;
        transition: transform 0.18s, background 0.18s, color 0.18s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .numpad-button:hover {
        transform: translateY(-2px);
        background: var(--mint-500);
        color: white;
    }

    .numpad-button.mode-active {
        background: var(--mint-600);
        color: white;
    }
    
    .place-order-btn {
        border: none;
        background: linear-gradient(135deg, var(--mint-500), #1cb5a0);
        color: white;
        padding: 18px;
        border-radius: var(--radius-md);
        font-size: 1.15rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        cursor: pointer;
        box-shadow: 0 18px 32px rgba(27, 143, 102, 0.25);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .place-order-btn:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 24px 38px rgba(27, 143, 102, 0.28);
    }

    .place-order-btn:disabled {
        background: #d4dce1;
        box-shadow: none;
        cursor: not-allowed;
    }

    /* Footer supprim√© pour plus d'espace */

    @media (max-width: 1400px) {
        .sidebar-nav {
            display: none;
        }

        .pos-shell {
            padding: 16px;
        }
    }
</style>
{% endblock %}

{% block content %}
<script type="application/json" id="categories-data">
{% if categories_js %}{{ categories_js|tojson|safe }}{% else %}[]{% endif %}
</script>
<div class="pos-wrapper">
    <!-- Hover zone pour afficher le menu -->
    <div class="sidebar-hover-zone" id="sidebarHoverZone"></div>
    <!-- Bouton toggle visible quand sidebar cach√©e -->
    <button class="sidebar-toggle-btn" id="sidebarToggleBtn" title="Afficher le menu (F6)">‚ò∞</button>
    <!-- Hint F6 -->
    <div class="sidebar-toggle-hint" id="sidebarHint">Appuyez sur F6 pour basculer le menu</div>
    
    <div class="pos-shell" id="posShell">
        <aside class="sidebar-nav" id="sidebarNav">
            <div class="sidebar-brand">
                <div class="brand-logo">FM</div>
                F√©e Maison POS
            </div>
            <nav class="sidebar-menu">
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Dashboards</div>
                    <a class="sidebar-link" href="{{ url_for('dashboards.dashboard_routes.daily_dashboard') }}">
                        <span class="icon">üìà</span>
                        Dashboard Journalier
                    </a>
                    <a class="sidebar-link" href="{{ url_for('dashboard.shop_dashboard') }}">
                        <span class="icon">üè™</span>
                        Dashboard Shop
                    </a>
                    <a class="sidebar-link" href="{{ url_for('dashboard.production_dashboard') }}">
                        <span class="icon">üç≥</span>
                        Dashboard Production
        </a>
    </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">Op√©rations</div>
                    <a class="sidebar-link" href="{{ url_for('orders.new_customer_order') }}">
                        <span class="icon">üÜï</span>
                        Nouvelle commande
                    </a>
                    <a class="sidebar-link" href="{{ url_for('orders.list_orders') }}">
                        <span class="icon">üì¶</span>
                        Toutes les commandes
                    </a>
                    <a class="sidebar-link" href="{{ url_for('orders.orders_calendar') }}">
                        <span class="icon">üóìÔ∏è</span>
                        Calendrier Production
                    </a>
                    <a class="sidebar-link" href="{{ url_for('deliverymen.list_deliverymen') }}">
                        <span class="icon">üöö</span>
                        Liste livreur
                    </a>
                    <a class="sidebar-link" href="{{ url_for('sales.list_delivery_debts') }}">
                        <span class="icon">üí∏</span>
                        Dette livreur
                    </a>
                    <a class="sidebar-link" href="{{ url_for('stock.dashboard_comptoir') }}">
                        <span class="icon">üßÅ</span>
                        Stock comptoir
                    </a>
                    <a class="sidebar-link" href="{{ url_for('stock.dashboard_consommables') }}">
                        <span class="icon">üß¥</span>
                        Stock consommables
                    </a>
                    <a class="sidebar-link" href="{{ url_for('stock.transfers_list') }}">
                        <span class="icon">üîÑ</span>
                        Transferts stock
                    </a>
                    <a class="sidebar-link" href="{{ url_for('inventory.daily_waste_index') }}">
                        <span class="icon">‚ôªÔ∏è</span>
                        Invendus quotidiens
                    </a>
                    <a class="sidebar-link" href="{{ url_for('inventory.weekly_comptoir_index') }}">
                        <span class="icon">üßÆ</span>
                        Inventaire hebdomadaire
                    </a>
    </div>
            </nav>
            <div class="sidebar-footer">
                <div class="sidebar-profile">
                    <div class="profile-role">
                        {{ current_user.profile.name if current_user.profile else current_user.role|capitalize }}
</div>
                    <div class="profile-username">
                        {{ current_user.username }}
                    </div>
                </div>
                <div class="sidebar-footer-actions">
                    <a class="sidebar-cta" href="{{ url_for('sales.cash_status') }}">
                        üíµ √âtat de la caisse
                    </a>
                    <a class="sidebar-cta danger" href="{{ url_for('sales.close_cash_register') }}">
                        üõë Fermer la caisse
                    </a>
                </div>
                {% if current_user.is_authenticated %}
                <a class="logout-btn" href="{{ url_for('auth.logout') }}">
                    ‚á¶ D√©connexion
                </a>
                {% endif %}
            </div>
        </aside>

        <div class="pos-main">
            <section class="menu-column">
                <div class="menu-top">
                    <div class="menu-heading">
                        <div class="menu-title">F√©e Maison POS</div>
                        <div class="menu-subtitle">
                            Session {{ current_user.username if current_user.is_authenticated else 'Utilisateur' }} ¬∑ Comptoir principal
                        </div>
                    </div>
                    <div class="top-actions">
                        <a href="{{ url_for('sales.cashout') }}" class="top-action" title="D√©p√¥t en Banque">
                            üí∞ Cashout
                        </a>
                        <a href="{{ url_for('accounting.new_expense') }}" class="top-action" title="Frais Divers">
                            üßæ Frais
                        </a>
                        <a href="{{ url_for('sales.cash_status') }}" class="top-action" title="√âtat de la Caisse">
                            üì¶ Caisse
                        </a>
                    </div>
                </div>

                <div class="menu-search">
                    <div class="search-field">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <input type="text" id="product-search" placeholder="Rechercher un produit..." autocomplete="off">
                    </div>
                </div>

                <div class="category-strip" id="categories-bar">
                    <button class="category-tab active" data-category="all">Tous</button>
                </div>

                <div class="products-scroll">
                    <div class="products-grid" id="products-grid">
                        <div class="loading">Chargement des produits...</div>
                    </div>
                </div>
            </section>

            <aside class="order-column">
                <div class="order-customer-card">
                <div class="customer-selector-container">
                    <div class="customer-search-wrapper">
                            <input type="text" id="posCustomerSearch" class="customer-search-input" placeholder="üîç Rechercher un client..." autocomplete="off">
                        <div id="posCustomerSuggestions" class="pos-autocomplete-suggestions"></div>
                    </div>
                    <div class="customer-actions">
                        <button type="button" id="clearPosCustomerBtn" class="pos-btn-clear" title="Effacer">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                        <button type="button" id="newPosCustomerBtn" class="pos-btn-new" title="Nouveau client">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </button>
                    </div>
                </div>
                    <div id="selectedCustomerInfo" class="selected-customer-info">
                    <div class="customer-avatar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    </div>
                    <div class="customer-details">
                        <div id="selectedCustomerName" class="customer-name">Client</div>
                        <div id="selectedCustomerPhone" class="customer-phone"></div>
                    </div>
                </div>
            </div>

            <div class="order-items-container" id="order-items">
                <div class="empty-cart-placeholder">Le panier est vide</div>
            </div>

                <div class="order-totals">
                    <div class="order-totals-row">
                    <span>Sous-total</span>
                    <span id="order-subtotal">0.00 DA</span>
                </div>
                    <div class="order-totals-row">
                    <span>Remise</span>
                    <span id="order-discount">0.00 DA</span>
                </div>
                    <div class="order-totals-row total">
                    <span>Total</span>
                    <span id="order-total">0.00 DA</span>
                </div>
            </div>

        <div class="payment-controls">
            <div class="numpad-container">
                 <button class="numpad-button" data-mode="quantity">Qt√©</button>
                 <button class="numpad-button" data-mode="discount">% Rem.</button>
                 <button class="numpad-button" data-mode="price">Prix</button>
                        <button class="numpad-button" data-key="7">7</button>
                        <button class="numpad-button" data-key="8">8</button>
                        <button class="numpad-button" data-key="9">9</button>
                        <button class="numpad-button" data-key="4">4</button>
                        <button class="numpad-button" data-key="5">5</button>
                        <button class="numpad-button" data-key="6">6</button>
                        <button class="numpad-button" data-key="1">1</button>
                        <button class="numpad-button" data-key="2">2</button>
                        <button class="numpad-button" data-key="3">3</button>
                        <button class="numpad-button" data-key="0">0</button>
                 <button class="numpad-button" data-key=".">.</button>
                 <button class="numpad-button" data-key="backspace">‚å´</button>
            </div>
                    <button class="place-order-btn" id="payment-btn" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                Paiement
            </button>
                </div>
            </aside>
        </div>
        </div>
    </div>

<!-- Footer supprim√© - cartes statiques inutiles -->

<div class="pos-modal" id="posCustomerModal" aria-hidden="true">
    <div class="pos-modal__backdrop" data-modal-dismiss></div>
    <div class="pos-modal__dialog">
        <h3>Ajouter un client</h3>
        <form id="posCustomerForm" class="pos-modal__form">
            <div class="pos-modal__field">
                <label for="posCustomerNameInput">Nom du client</label>
                <input type="text" id="posCustomerNameInput" name="customer_name" placeholder="Ex. Yasmine Saifi" required>
            </div>
            <div class="pos-modal__field">
                <label for="posCustomerPhoneInput">T√©l√©phone</label>
                <input type="tel" id="posCustomerPhoneInput" name="customer_phone" placeholder="Ex. 0556 00 00 00" required>
            </div>
            <div class="pos-modal__actions">
                <button type="button" class="modal-btn secondary" id="posCustomerModalCancel">Annuler</button>
                <button type="submit" class="modal-btn primary">Enregistrer</button>
            </div>
        </form>
    </div>
</div>

<div class="pos-modal" id="posPaymentModal" aria-hidden="true">
    <div class="pos-modal__backdrop" data-modal-dismiss></div>
    <div class="pos-modal__dialog">
        <h3>Paiement</h3>
        <div class="pos-modal__summary">
            Total encaissement : <span id="posPaymentTotalDue">0.00 DA</span>
        </div>
        <form id="posPaymentForm" class="pos-modal__form">
            <div class="pos-modal__field">
                <label for="posPaymentAmountInput">Montant re√ßu</label>
                <input type="number" step="0.01" min="0" id="posPaymentAmountInput" placeholder="Ex. 5000" required>
            </div>
            <div class="pos-modal__field">
                <label>Monnaie √† rendre</label>
                <div id="posPaymentChangeDisplay" class="pos-modal__change">0.00 DA</div>
            </div>
            <div class="pos-modal__error" id="posPaymentError" role="alert"></div>
            <div class="pos-modal__actions">
                <button type="button" class="modal-btn secondary" id="posPaymentModalCancel">Annuler</button>
                <button type="submit" class="modal-btn primary">Valider</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const state = {
        products: [],
        categories: [],
        favoriteProductIds: [],
        cart: [],
        selectedCartItemIndex: -1,
        numpad: {
            mode: 'quantity',
            buffer: ''
        },
        loading: true,
        error: null,
        customer: null,
        customerSearchResults: [],
        orderTotals: {
            subtotal: 0,
            discount: 0,
            total: 0
        },
        serviceMode: 'dine-in',
        paymentMethod: 'cash'
    };

    const categoriesDataElement = document.getElementById('categories-data');
    if (categoriesDataElement) {
        try {
            const parsed = JSON.parse(categoriesDataElement.textContent || '[]');
            if (Array.isArray(parsed)) {
                state.categories = parsed;
            }
        } catch (err) {
            console.warn('Impossible de parser categories-data', err);
        }
    }

    const productsGrid = document.getElementById('products-grid');
    const orderItemsContainer = document.getElementById('order-items');
    const subtotalEl = document.getElementById('order-subtotal');
    const discountEl = document.getElementById('order-discount');
    const totalEl = document.getElementById('order-total');
    const paymentBtn = document.getElementById('payment-btn');
    const searchInput = document.getElementById('product-search');
    const categoriesBar = document.getElementById('categories-bar');
    const customerSearchInput = document.getElementById('posCustomerSearch');
    const customerSuggestions = document.getElementById('posCustomerSuggestions');
    const selectedCustomerInfo = document.getElementById('selectedCustomerInfo');
    const selectedCustomerName = document.getElementById('selectedCustomerName');
    const selectedCustomerPhone = document.getElementById('selectedCustomerPhone');
    const clearCustomerBtn = document.getElementById('clearPosCustomerBtn');
    const newCustomerBtn = document.getElementById('newPosCustomerBtn');
    const customerModal = document.getElementById('posCustomerModal');
    const customerModalCancel = document.getElementById('posCustomerModalCancel');
    const customerForm = document.getElementById('posCustomerForm');
    const customerNameInput = document.getElementById('posCustomerNameInput');
    const customerPhoneInput = document.getElementById('posCustomerPhoneInput');
    const paymentModal = document.getElementById('posPaymentModal');
    const paymentModalCancel = document.getElementById('posPaymentModalCancel');
    const paymentForm = document.getElementById('posPaymentForm');
    const paymentAmountInput = document.getElementById('posPaymentAmountInput');
    const paymentChangeDisplay = document.getElementById('posPaymentChangeDisplay');
    const paymentError = document.getElementById('posPaymentError');
    const paymentTotalDue = document.getElementById('posPaymentTotalDue');
    let customerSearchTimeout = null;
    const paymentControls = document.querySelector('.payment-controls');
    const serviceButtons = document.querySelectorAll('.service-button');

    serviceButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            serviceButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            state.serviceMode = btn.dataset.service;
        });
    });

    function slugifyCategory(value) {
        return String(value || 'autres')
            .toLowerCase()
            .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
            .replace(/[^a-z0-9]+/g, '-')
            .replace(/^-+|-+$/g, '') || 'autres';
    }

    function getActiveCategory() {
        const activeTab = categoriesBar.querySelector('.category-tab.active');
        return activeTab ? activeTab.dataset.category : 'all';
    }

    function refreshProductsView() {
        renderProducts(searchInput.value, getActiveCategory());
    }

    function buildCategoryList() {
        const base = [];
        if (Array.isArray(state.categories) && state.categories.length) {
            state.categories.forEach(cat => {
                const label = cat.name || cat.label || cat.display_name || cat;
                const key = cat.slug || cat.key || slugifyCategory(label);
                base.push({ key, label });
            });
        } else {
            const map = new Map();
            state.products.forEach(product => {
                const label = product.category_name || product.category || product.categoryLabel || 'Autres';
                const key = product.category_slug || slugifyCategory(label);
                if (!map.has(key)) {
                    map.set(key, { key, label });
                }
            });
            base.push(...map.values());
        }
        return base;
    }

    function refreshCategoryTabs() {
        if (!categoriesBar) return;
        const previous = getActiveCategory();
        const categories = [{ key: 'all', label: 'Tous' }];
        if (state.favoriteProductIds && state.favoriteProductIds.length) {
            categories.push({ key: 'favorites', label: 'Favoris' });
        }
        const dynamicCategories = buildCategoryList().filter(cat => cat.key !== 'all');
        const seen = new Set(categories.map(cat => cat.key));
        dynamicCategories.forEach(cat => {
            if (!seen.has(cat.key)) {
                categories.push(cat);
                seen.add(cat.key);
            }
        });

        categoriesBar.innerHTML = categories.map(cat => `
            <button class="category-tab" data-category="${cat.key}">${cat.label}</button>
        `).join('');

        const toActivate = categoriesBar.querySelector(`[data-category="${previous}"]`) || categoriesBar.querySelector('.category-tab');
        if (toActivate) {
            toActivate.classList.add('active');
        }
    }
    
    async function loadProducts() {
        try {
            state.loading = true;
            state.error = null;
            renderProducts();
            
            const response = await fetch('/sales/api/products');
            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
            }
            
            const payload = await response.json();
            const products = Array.isArray(payload)
                ? payload
                : Array.isArray(payload.products) ? payload.products : [];
            const categories = Array.isArray(payload.categories) ? payload.categories : null;

            state.products = products.map(product => ({
                ...product,
                image: product.image_filename
                    ? `/static/img/products/${product.image_filename}`
                    : `https://via.placeholder.com/160x120.png/${getRandomColor()}/FFFFFF?Text=${encodeURIComponent((product.name || 'Produit').substring(0, 10))}`
            }));

            if (categories) {
                state.categories = categories.map(cat => ({
                    key: cat.slug || cat.key || slugifyCategory(cat.name),
                    label: cat.name || cat.label || 'Cat√©gorie'
                }));
            }
            state.loading = false;
        } catch (error) {
            console.error('Erreur lors du chargement des produits:', error);
            state.error = "Erreur lors du chargement des produits";
            state.loading = false;
        }
    }

    async function loadFavoriteProducts() {
        try {
            const response = await fetch('/sales/api/favorites');
            if (!response.ok) {
                return;
            }
            const data = await response.json();
            if (Array.isArray(data)) {
                state.favoriteProductIds = data;
            } else if (data && Array.isArray(data.favorite_product_ids)) {
                state.favoriteProductIds = data.favorite_product_ids;
            } else if (data && Array.isArray(data.favorites)) {
                state.favoriteProductIds = data.favorites;
            }
        } catch (error) {
            console.warn('Impossible de r√©cup√©rer les favoris', error);
        }
    }

    function getRandomColor() {
        const colors = ['F5DEB3', 'D2691E', '8B4513', 'FFE4B5', '6F4E37', 'FFF8DC', 'FFA500', '90EE90', '87CEEB', 'DDA0DD'];
        return colors[Math.floor(Math.random() * colors.length)];
    }

    function getCsrfToken() {
        const meta = document.querySelector('meta[name="csrf-token"]');
        return meta ? meta.getAttribute('content') : '';
    }

    function openCustomerModal() {
        if (!customerModal) return;
        customerModal.classList.add('is-open');
        customerModal.setAttribute('aria-hidden', 'false');
        if (customerNameInput) {
            customerNameInput.value = customerSearchInput?.value?.trim() || '';
        }
        if (customerPhoneInput) {
            customerPhoneInput.value = '';
        }
        setTimeout(() => customerNameInput?.focus(), 100);
    }

    function closeCustomerModal() {
        if (!customerModal) return;
        customerModal.classList.remove('is-open');
        customerModal.setAttribute('aria-hidden', 'true');
        customerForm?.reset();
        customerSearchInput?.focus();
    }

    async function completeSale(paymentContext = {}) {
        if (state.cart.length === 0) {
            alert('Le panier est vide');
            return null;
        }

        try {
            const items = state.cart.map(item => {
                const discountedUnitPrice = item.unitPrice * (1 - item.discountPercent / 100);
                return {
                    product_id: item.productId,
                    quantity: item.quantity,
                    unit_price: discountedUnitPrice
                };
            });

            const response = await fetch('/sales/api/complete-sale', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    items,
                    payment_method: state.paymentMethod,
                    service_mode: state.serviceMode,
                    customer_id: state.customer?.id || null,
                    customer_name: state.customer?.name || null,
                    customer_phone: state.customer?.phone || null,
                    amount_received: paymentContext.amountReceived ?? null,
                    change_amount: paymentContext.change ?? null
                })
            });

            const result = await response.json();
            
            if (result.success) {
                state.cart = [];
                state.selectedCartItemIndex = -1;
                renderCart();
                await loadProducts();
                refreshCategoryTabs();
                refreshProductsView();
                clearCustomerSelection();
                renderSelectedCustomer();
                return result;
            } else {
                alert(`Erreur: ${result.message}`);
                return null;
            }
        } catch (error) {
            console.error('Erreur lors de la finalisation:', error);
            alert('Erreur lors de la finalisation de la vente');
            return null;
        }
    }

    const formatPrice = (price) => `${price.toFixed(2)} DA`;

    function matchesCategory(product, category) {
        if (category === 'all') {
            return true;
        }
        if (category === 'favorites') {
            return state.favoriteProductIds.includes(product.id);
        }
        const slug = product.category_slug || slugifyCategory(product.category_name || product.category || '');
        return slug === category;
    }
    
    function renderProducts(filter = '', category = 'all') {
        if (!productsGrid) return;

        if (state.loading) {
            productsGrid.innerHTML = '<div class="loading">Chargement des produits...</div>';
            return;
        }

        if (state.error) {
            productsGrid.innerHTML = `<div class="error-message">${state.error}</div>`;
            return;
        }

        const query = (filter || '').toLowerCase();
        const filteredProducts = state.products.filter(product => {
            const matchesSearch = (product.name || '').toLowerCase().includes(query)
                || (product.description || '').toLowerCase().includes(query);
            return matchesSearch && matchesCategory(product, category);
        });

        if (filteredProducts.length === 0) {
            productsGrid.innerHTML = '<div class="error-message">Aucun produit trouv√©.</div>';
            return;
        }

        productsGrid.innerHTML = '';
        filteredProducts.forEach(product => {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.dataset.productId = product.id;
            
            if (product.stock <= 0) {
                card.classList.add('out-of-stock');
            }

            const inCart = state.cart.find(item => item.productId === product.id && item.discountPercent === 0);
            const controlsHtml = inCart ? `
                <div class="card-qty-controls" data-product-id="${product.id}">
                    <button class="qty-btn" data-action="decrease">‚àí</button>
                    <span class="qty-display">${inCart.quantity}</span>
                    <button class="qty-btn" data-action="increase">+</button>
                </div>
            ` : `
                <button class="card-add-btn" data-action="add" data-product-id="${product.id}">
                    Ajouter
                </button>
            `;

            const badge = product.stock <= 0 ? '<span class="card-badge badge-out">Rupture</span>' : '';
            const image = product.image ? `<img src="${product.image}" alt="${product.name}">` : `<span class="card-placeholder">${(product.name || 'P')[0]}</span>`;
            const unitLabel = product.unit || 'u.';

            card.innerHTML = `
                ${badge}
                <div class="card-image">${image}</div>
                <div class="card-info">
                    <div class="card-title">${product.name || 'Produit'}</div>
                    <div class="card-meta">
                        <span>${formatPrice(product.price || 0)}</span>
                        <span class="stock">${product.stock ?? 0} ${unitLabel}</span>
                    </div>
                </div>
                <div class="card-actions">${controlsHtml}</div>
            `;
            
            productsGrid.appendChild(card);
        });
    }

    function renderCart() {
        if (!orderItemsContainer) return;

        if (state.cart.length === 0) {
            orderItemsContainer.innerHTML = '<div class="empty-cart-placeholder">Le panier est vide</div>';
            state.selectedCartItemIndex = -1;
        } else {
            orderItemsContainer.innerHTML = '';
            state.cart.forEach((item, index) => {
                const product = state.products.find(p => p.id === item.productId);
                if (!product) {
                    return;
                }
                
                const itemEl = document.createElement('div');
                itemEl.className = 'order-item';
                if (index === state.selectedCartItemIndex) {
                    itemEl.classList.add('selected');
                }
                itemEl.dataset.itemIndex = index;
                
                const totalPrice = item.quantity * item.unitPrice * (1 - item.discountPercent / 100);
                itemEl.innerHTML = `
                    <div class="item-info">
                        <div class="item-name">${product.name}</div>
                        <div class="item-details">
                            ${item.quantity} √ó ${formatPrice(item.unitPrice)}
                            ${item.discountPercent > 0 ? ` ¬∑ ${item.discountPercent}% rem.` : ''}
                        </div>
                    </div>
                    <div class="item-price">${formatPrice(totalPrice)}</div>
                `;
                orderItemsContainer.appendChild(itemEl);
            });
        }
        
        let subtotal = 0;
        let totalDiscount = 0;
        state.cart.forEach(item => {
            const originalTotal = item.quantity * item.unitPrice;
            subtotal += originalTotal;
            totalDiscount += originalTotal * (item.discountPercent / 100);
        });
        const total = subtotal - totalDiscount;
        state.orderTotals = {
            subtotal,
            discount: totalDiscount,
            total
        };

        subtotalEl.textContent = formatPrice(subtotal);
        discountEl.textContent = formatPrice(totalDiscount);
        totalEl.textContent = formatPrice(total);
        
        paymentBtn.disabled = state.cart.length === 0;
    }

    function renderSelectedCustomer() {
        if (!selectedCustomerInfo) return;
        if (state.customer) {
            selectedCustomerInfo.classList.add('show');
            selectedCustomerName.textContent = state.customer.name || state.customer.full_name || 'Client';
            selectedCustomerPhone.textContent = state.customer.phone || '';
        } else {
            selectedCustomerInfo.classList.remove('show');
            selectedCustomerName.textContent = 'Client';
            selectedCustomerPhone.textContent = '';
        }
    }

    function renderCustomerSuggestions() {
        if (!customerSuggestions) return;
        const results = state.customerSearchResults || [];
        if (!results.length) {
            customerSuggestions.style.display = 'none';
            customerSuggestions.innerHTML = '';
            return;
        }
        customerSuggestions.innerHTML = results.map(result => `
            <div class="pos-autocomplete-item" data-customer-id="${result.id}">
                <strong>${result.full_name}</strong>
                ${result.display_phone ? `<div class="small text-muted">${result.display_phone}</div>` : ''}
            </div>
        `).join('');
        customerSuggestions.style.display = 'block';
    }

    function clearCustomerSelection() {
        state.customer = null;
        customerSearchInput.value = '';
        state.customerSearchResults = [];
        renderCustomerSuggestions();
        renderSelectedCustomer();
    }

    function openPaymentModal() {
        if (!paymentModal) return;
        if (!state.cart.length) {
            alert('Le panier est vide.');
            return;
        }
        const total = state.orderTotals?.total || 0;
        paymentTotalDue.textContent = formatPrice(total);
        if (paymentAmountInput) {
            paymentAmountInput.value = '';
        }
        if (paymentChangeDisplay) {
            paymentChangeDisplay.textContent = formatPrice(0);
        }
        if (paymentError) {
            paymentError.classList.remove('is-visible');
            paymentError.textContent = '';
        }
        paymentModal.classList.add('is-open');
        paymentModal.setAttribute('aria-hidden', 'false');
        updatePaymentChange();
        setTimeout(() => paymentAmountInput?.focus(), 100);
    }

    function closePaymentModal() {
        if (!paymentModal) return;
        paymentModal.classList.remove('is-open');
        paymentModal.setAttribute('aria-hidden', 'true');
        paymentForm?.reset();
    }

    function updatePaymentChange() {
        if (!paymentAmountInput || !paymentChangeDisplay) return;
        const total = state.orderTotals?.total || 0;
        const raw = paymentAmountInput.value.replace(',', '.');
        const amount = parseFloat(raw);
        if (Number.isNaN(amount) || amount < 0) {
            paymentChangeDisplay.textContent = formatPrice(0);
            return;
        }
        const change = Math.max(amount - total, 0);
        paymentChangeDisplay.textContent = formatPrice(change);
        if (paymentError) {
            paymentError.classList.remove('is-visible');
            paymentError.textContent = '';
        }
    }

    async function searchCustomers(term) {
        if (!term || term.length < 2) {
            state.customerSearchResults = [];
            renderCustomerSuggestions();
            return;
        }
        try {
            const response = await fetch(`/admin/customers/api/search?q=${encodeURIComponent(term)}&limit=8`);
            if (!response.ok) {
                throw new Error('Recherche client √©chou√©e');
            }
            const data = await response.json();
            state.customerSearchResults = data.map(item => ({
                id: item.id,
                name: item.full_name,
                full_name: item.full_name,
                phone: item.display_phone || item.phone || ''
            }));
            renderCustomerSuggestions();
        } catch (error) {
            console.warn('Erreur recherche client', error);
            state.customerSearchResults = [];
            renderCustomerSuggestions();
        }
    }

    async function selectCustomerById(customerId) {
        try {
            const response = await fetch(`/admin/customers/api/details/${customerId}`);
            if (!response.ok) {
                throw new Error('Client introuvable');
            }
            const data = await response.json();
            state.customer = {
                id: data.id,
                name: data.full_name,
                full_name: data.full_name,
                phone: data.display_phone || data.phone || ''
            };
            customerSearchInput.value = state.customer.name;
            customerSuggestions.style.display = 'none';
            renderSelectedCustomer();
        } catch (error) {
            console.error('Erreur s√©lection client', error);
            alert("Impossible de r√©cup√©rer les d√©tails du client s√©lectionn√©.");
        }
    }

    async function quickCreateCustomer(nameValue, phoneValue) {
        const rawName = (nameValue || '').trim();
        const rawPhone = (phoneValue || '').trim();

        if (!rawName || !rawPhone) {
            alert('Merci de renseigner le nom et le t√©l√©phone du client.');
            return;
        }

        const nameParts = rawName.split(' ').filter(Boolean);
        const firstName = nameParts.shift() || rawName;
        const lastName = nameParts.join(' ') || firstName;

        const formData = new URLSearchParams();
        formData.append('first_name', firstName);
        formData.append('last_name', lastName);
        formData.append('phone', rawPhone);
        formData.append('address', '');
        formData.append('csrf_token', getCsrfToken());

        try {
            const response = await fetch('/admin/customers/api/quick-create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData.toString()
            });

            const data = await response.json();
            if (!response.ok || !data.success) {
                throw new Error(data.message || 'Erreur inconnue');
            }

            state.customer = {
                id: data.customer.id,
                name: data.customer.full_name,
                full_name: data.customer.full_name,
                phone: data.customer.phone || ''
            };
            customerSearchInput.value = state.customer.name;
            state.customerSearchResults = [];
            renderCustomerSuggestions();
            renderSelectedCustomer();
            if (customerSuggestions) {
                customerSuggestions.style.display = 'none';
            }
            closeCustomerModal();
            alert(data.message || 'Client cr√©√© avec succ√®s.');
        } catch (error) {
            console.error('Erreur cr√©ation client', error);
            alert(`Impossible de cr√©er le client : ${error.message || error}`);
        }
    }
    
    function addProductToCart(productId) {
        const product = state.products.find(p => p.id === productId);
        if (!product) return;

        if (product.stock <= 0) {
            alert('Produit en rupture de stock');
            return;
        }

        const existingItemIndex = state.cart.findIndex(item => item.productId === productId && item.discountPercent === 0);
        
        if (existingItemIndex > -1) {
            const currentQuantity = state.cart[existingItemIndex].quantity;
            if (currentQuantity >= product.stock) {
                alert(`Stock insuffisant. Maximum disponible: ${product.stock}`);
                return;
            }
            state.cart[existingItemIndex].quantity++;
            selectCartItem(existingItemIndex);
        } else {
            state.cart.push({
                productId: product.id,
                quantity: 1,
                unitPrice: product.price,
                discountPercent: 0,
            });
            selectCartItem(state.cart.length - 1);
        }

        renderCart();
        refreshProductsView();
    }

    function adjustProductQuantity(productId, delta) {
        const product = state.products.find(p => p.id === productId);
        if (!product) return;

        const index = state.cart.findIndex(item => item.productId === productId && item.discountPercent === 0);
        if (index === -1) {
            if (delta > 0) {
                addProductToCart(productId);
            }
            return;
        }

        const nextQuantity = state.cart[index].quantity + delta;
        if (delta > 0) {
            if (nextQuantity > product.stock) {
                alert(`Stock insuffisant. Maximum disponible: ${product.stock}`);
                return;
            }
            state.cart[index].quantity = nextQuantity;
        } else {
            if (nextQuantity <= 0) {
                state.cart.splice(index, 1);
                if (state.selectedCartItemIndex >= state.cart.length) {
                    state.selectedCartItemIndex = state.cart.length - 1;
                }
            } else {
                state.cart[index].quantity = nextQuantity;
            }
        }

        renderCart();
        refreshProductsView();
    }
    
    function selectCartItem(index) {
        state.selectedCartItemIndex = index;
        state.numpad.buffer = '';
        renderCart();
    }
    
    function handleNumpadInput(key) {
        if (state.selectedCartItemIndex === -1) {
             alert("Veuillez d'abord s√©lectionner un article dans la commande.");
             return;
        }

        if (key === 'backspace') {
            state.numpad.buffer = state.numpad.buffer.slice(0, -1);
        } else {
            state.numpad.buffer += key;
        }
        
        const value = parseFloat(state.numpad.buffer) || 0;
        const selectedItem = state.cart[state.selectedCartItemIndex];
        const product = state.products.find(p => p.id === selectedItem.productId);
        
        switch (state.numpad.mode) {
            case 'quantity':
                if (value <= 0) {
                     state.cart.splice(state.selectedCartItemIndex, 1);
                     selectCartItem(state.cart.length > 0 ? 0 : -1);
                } else if (value > product.stock) {
                    alert(`Stock insuffisant. Maximum disponible: ${product.stock}`);
                    state.numpad.buffer = product.stock.toString();
                    selectedItem.quantity = product.stock;
                } else {
                    selectedItem.quantity = value;
                }
                break;
            case 'discount':
                if (value >= 0 && value <= 100) {
                     selectedItem.discountPercent = value;
                 } else {
                    alert('La remise doit √™tre entre 0 et 100.');
                     state.numpad.buffer = selectedItem.discountPercent.toString();
                 }
                break;
            case 'price':
                if (value >= 0) {
                    selectedItem.unitPrice = value;
                }
                break;
        }
        
        renderCart();
        refreshProductsView();
    }

    function setNumpadMode(newMode) {
        state.numpad.mode = newMode;
        state.numpad.buffer = '';

        document.querySelectorAll('.numpad-button[data-mode]').forEach(btn => {
            btn.classList.toggle('mode-active', btn.dataset.mode === newMode);
        });
    }
    
    productsGrid.addEventListener('click', (e) => {
        const addBtn = e.target.closest('.card-add-btn');
        if (addBtn) {
            addProductToCart(parseInt(addBtn.dataset.productId, 10));
            return;
        }

        const qtyBtn = e.target.closest('.qty-btn');
        if (qtyBtn) {
            const controls = qtyBtn.closest('.card-qty-controls');
            const productId = parseInt(controls.dataset.productId, 10);
            adjustProductQuantity(productId, qtyBtn.dataset.action === 'increase' ? 1 : -1);
            return;
        }

        const card = e.target.closest('.product-card');
        if (card && !card.classList.contains('out-of-stock')) {
            addProductToCart(parseInt(card.dataset.productId, 10));
        }
    });
    
    orderItemsContainer.addEventListener('click', (e) => {
        const itemEl = e.target.closest('.order-item');
        if (itemEl) {
            selectCartItem(parseInt(itemEl.dataset.itemIndex, 10));
        }
    });

    searchInput.addEventListener('input', () => {
        refreshProductsView();
    });

    categoriesBar.addEventListener('click', (e) => {
        const tab = e.target.closest('.category-tab');
        if (tab) {
            categoriesBar.querySelectorAll('.category-tab').forEach(btn => btn.classList.remove('active'));
            tab.classList.add('active');
            refreshProductsView();
        }
    });

    paymentControls.addEventListener('click', (e) => {
        const target = e.target;
        if (target.matches('.numpad-button[data-mode]')) {
            setNumpadMode(target.dataset.mode);
        } else if (target.matches('.numpad-button[data-key]')) {
            handleNumpadInput(target.dataset.key);
        } else if (target.matches('.payment-method')) {
            paymentControls.querySelectorAll('.payment-method').forEach(btn => btn.classList.remove('active'));
            target.classList.add('active');
            state.paymentMethod = target.dataset.method;
        } else if (target.matches('#payment-btn') && !target.disabled) {
            openPaymentModal();
        }
    });

    if (customerSuggestions) {
        customerSuggestions.addEventListener('click', (e) => {
            const item = e.target.closest('.pos-autocomplete-item');
            if (item) {
                const id = parseInt(item.dataset.customerId, 10);
                if (!Number.isNaN(id)) {
                    selectCustomerById(id);
                }
            }
        });
    }

    if (customerSearchInput) {
        customerSearchInput.addEventListener('input', (e) => {
            const term = e.target.value.trim();
            if (customerSearchTimeout) {
            clearTimeout(customerSearchTimeout);
            }
            customerSearchTimeout = setTimeout(() => searchCustomers(term), 250);
        });

        customerSearchInput.addEventListener('focus', (e) => {
            if ((state.customerSearchResults || []).length > 0) {
                customerSuggestions.style.display = 'block';
            }
        });
    }

    if (clearCustomerBtn) {
        clearCustomerBtn.addEventListener('click', (e) => {
            e.preventDefault();
            clearCustomerSelection();
        });
    }
    
    if (newCustomerBtn) {
        newCustomerBtn.addEventListener('click', (e) => {
            e.preventDefault();
            openCustomerModal();
        });
    }

    if (customerModalCancel) {
        customerModalCancel.addEventListener('click', (e) => {
            e.preventDefault();
            closeCustomerModal();
        });
    }

    if (customerModal) {
        customerModal.addEventListener('click', (e) => {
            if (e.target === customerModal || e.target.hasAttribute('data-modal-dismiss')) {
                closeCustomerModal();
            }
        });
    }

    if (customerForm) {
        customerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await quickCreateCustomer(customerNameInput.value, customerPhoneInput.value);
        });
    }

    if (paymentModalCancel) {
        paymentModalCancel.addEventListener('click', (e) => {
            e.preventDefault();
            closePaymentModal();
        });
    }

    if (paymentModal) {
        paymentModal.addEventListener('click', (e) => {
            if (e.target === paymentModal || e.target.hasAttribute('data-modal-dismiss')) {
                closePaymentModal();
            }
        });
    }

    if (paymentAmountInput) {
        paymentAmountInput.addEventListener('input', updatePaymentChange);
    }

    if (paymentForm) {
        paymentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (paymentError) {
                paymentError.classList.remove('is-visible');
                paymentError.textContent = '';
            }
            const total = state.orderTotals?.total || 0;
            const raw = paymentAmountInput.value.replace(',', '.');
            const amount = parseFloat(raw);
            if (Number.isNaN(amount) || amount < total) {
                if (paymentError) {
                    paymentError.textContent = `Montant insuffisant. Total √† encaisser : ${formatPrice(total)}`;
                    paymentError.classList.add('is-visible');
        } else {
                    alert(`Montant insuffisant. Total √† encaisser : ${formatPrice(total)}`);
                }
                return;
            }
            const change = amount - total;
            updatePaymentChange();
            const result = await completeSale({ amountReceived: amount, change });
            if (result) {
                closePaymentModal();
                alert(`Paiement enregistr√©.\nTotal: ${formatPrice(total)}\nRe√ßu: ${formatPrice(amount)}\nMonnaie √† rendre: ${formatPrice(change)}`);
            }
        });
    }

    document.addEventListener('click', (e) => {
        if (customerSuggestions && !customerSuggestions.contains(e.target) && e.target !== customerSearchInput) {
            customerSuggestions.style.display = 'none';
        }
    });

    (async function init() {
        await loadProducts();
        await loadFavoriteProducts();
        refreshCategoryTabs();
        refreshProductsView();
    renderCart();
    setNumpadMode('quantity');
        renderSelectedCustomer();
    })();

    // ========== SIDEBAR TOGGLE (F6 + Hover) ==========
    const sidebarNav = document.getElementById('sidebarNav');
    const posShell = document.getElementById('posShell');
    const sidebarHoverZone = document.getElementById('sidebarHoverZone');
    const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
    const sidebarHint = document.getElementById('sidebarHint');
    let sidebarCollapsed = false;
    let hoverTimeout = null;

    function toggleSidebar() {
        sidebarCollapsed = !sidebarCollapsed;
        
        if (sidebarCollapsed) {
            sidebarNav.classList.add('collapsed');
            posShell.classList.add('sidebar-hidden');
            sidebarHoverZone.classList.add('active');
            sidebarToggleBtn.classList.add('visible');
        } else {
            sidebarNav.classList.remove('collapsed', 'hover-visible');
            posShell.classList.remove('sidebar-hidden');
            sidebarHoverZone.classList.remove('active');
            sidebarToggleBtn.classList.remove('visible');
        }
        
        // Refresh products pour ajuster la grille
        setTimeout(() => refreshProductsView(), 100);
    }

    // F6 keyboard toggle
    document.addEventListener('keydown', (e) => {
        if (e.key === 'F6') {
            e.preventDefault();
            toggleSidebar();
        }
    });

    // Click on toggle button
    if (sidebarToggleBtn) {
        sidebarToggleBtn.addEventListener('click', toggleSidebar);
    }

    // Hover zone - show sidebar temporarily
    if (sidebarHoverZone) {
        sidebarHoverZone.addEventListener('mouseenter', () => {
            if (sidebarCollapsed) {
                clearTimeout(hoverTimeout);
                sidebarNav.classList.add('hover-visible');
            }
        });
    }

    // Sidebar - keep visible while hovering
    if (sidebarNav) {
        sidebarNav.addEventListener('mouseenter', () => {
            if (sidebarCollapsed) {
                clearTimeout(hoverTimeout);
            }
        });

        sidebarNav.addEventListener('mouseleave', () => {
            if (sidebarCollapsed) {
                hoverTimeout = setTimeout(() => {
                    sidebarNav.classList.remove('hover-visible');
                }, 300);
            }
        });
    }

    // Show hint briefly
    if (sidebarHint) {
        sidebarHint.classList.add('visible');
        setTimeout(() => {
            sidebarHint.classList.remove('visible');
        }, 5000);
    }
});
</script>
{% endblock %}

